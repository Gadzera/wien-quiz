<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wiener Taxi Pr√ºfungsassistent</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --brand:#2563eb; --brand-2:#60a5fa; --ok:#16a34a; --err:#dc2626; --warn:#f59e0b;
  --bg:#ffffff; --panel:#ffffff; --text:#0f172a; --muted:#6b7280;
  --chip:#f8fafc; --border:#e5e7eb; --shadow:0 10px 30px rgba(2,6,23,.15); --radius:14px;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1020; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --chip:#0b1225; --border:#1f2937; --shadow:0 10px 40px rgba(0,0,0,.45); }
}
*{ box-sizing:border-box } html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,sans-serif; }
#map{ position:fixed; inset:0; z-index:1; }

/* topbar */
.topbar{
  position:fixed;
  top:12px;
  left:12px;
  right:12px;
  display:flex;
  justify-content:space-between;
  gap:8px;
  z-index:1500;
}

.btn{ pointer-events:auto; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); box-shadow:var(--shadow); }
.btn.secondary{ background:#334155; }
.iconbtn{ pointer-events:auto; border:none; border-radius:10px; padding:10px 12px; background:#111827; color:#fff; opacity:.95; cursor:pointer; }
.spacer{ flex:1 }

/* sidebar */
.sidebar{ position:fixed; top:64px; right:12px; z-index:1000; width:420px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); display:none; }
.sidebar h3{ margin:0 0 8px 0; }
.cat{ display:flex; align-items:center; gap:8px; padding:8px; margin:8px 0; background:var(--chip); border-left:4px solid var(--brand); border-radius:10px; }
.cat .meta{ margin-left:auto; font-size:12px; color:var(--muted); }
.small{ font-size:12px; color:var(--muted); }
hr{ border:none; border-top:1px solid var(--border); margin:10px 0; }

/* quiz */
.quiz-panel{ position:fixed; top:64px; right:12px; z-index:1000; width:500px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none; }
.question{ font-weight:800; margin:8px 0 10px; text-align:center; }
.progress{ text-align:center; font-size:13px; color:var(--muted); }
.progressbar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px 0 12px; }
.progressbar-fill{ height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }
.options{ display:grid; gap:8px; }
.option{ padding:12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:transparent; }
.option:hover{ border-color:var(--brand); background:rgba(37,99,235,.07); }
.option.correct{ border-color:var(--ok); background:#f0fdf4; }
.option.incorrect{ border-color:var(--err); background:#fef2f2; }
.replay-row{ display:flex; gap:8px; justify-content:center; margin:6px 0 4px; }
.next-btn,.end-btn{ margin-top:10px; width:100%; font-weight:800; border:none; border-radius:10px; padding:10px 14px; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); cursor:pointer; }
.end-btn.secondary{ background:#334155; }

.panel{ position:fixed; top:64px; right:520px; z-index:1000; width:540px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none; }

/* login */
#loginModal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:2000; }
#loginBox{ width:90%; max-width:380px; background:var(--panel); color:var(--text); border-radius:14px; padding:20px; box-shadow:var(--shadow); border:1px solid var(--border); }
#loginBox h2{ margin:0 0 12px 0; }
#loginBox input{ width:100%; padding:12px; margin:8px 0; border:1px solid var(--border); border-radius:10px; background:var(--chip); color:var(--text); }
.login-btn{ width:100%; padding:12px; border:none; border-radius:10px; font-weight:800; background:linear-gradient(180deg,#ffcc66,#ff9933); cursor:pointer; }

/* toast */
.toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(20px); background:rgba(17,24,39,.95); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:3000; font-size:13px; }
.toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

/* Marker icons */
.leaflet-div-icon { background: transparent; border: none; }
.mk{ width:26px; height:26px; border-radius:50%; display:grid; place-items:center; color:#fff; font-weight:900; font-size:14px; box-shadow:0 2px 10px rgba(0,0,0,.35); border:2px solid rgba(255,255,255,.9); }
.mk.blue{ background:#2563eb; }
.mk.green{ background:#16a34a; }
.mk.red{ background:#dc2626; }
.mk.pulse{ box-shadow:0 0 0 0 rgba(37,99,235,.45); animation:mkpulse 1.4s infinite; }
@keyframes mkpulse{ 0%{ box-shadow:0 0 0 0 rgba(37,99,235,.45);} 70%{ box-shadow:0 0 0 16px rgba(37,99,235,0);} 100%{ box-shadow:0 0 0 0 rgba(37,99,235,0);} }

/* voice button */
.voice-btn{ background:linear-gradient(180deg,#8b5cf6,#7c3aed) !important; }
.voice-listening{ background:linear-gradient(180deg,#dc2626,#b91c1c) !important; animation:pulse 1.5s infinite; }
@keyframes pulse{ 0%{ opacity:1; } 50%{ opacity:0.7; } 100%{ opacity:1; } }

/* map popup */
.answer-popup { font-weight: bold; color: #1e40af; }
</style>
</head>
<body>

<div id="map"></div>

<div class="topbar">
  <button class="btn" id="menuBtn">‚ò∞ Themen</button>
  <div class="spacer"></div>
  <button class="iconbtn" id="studyBtn" title="–£—á–µ–±–Ω—ã–π —Ä–µ–∂–∏–º">üß≠</button>
  <button class="iconbtn" id="voiceModeBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º">üéôÔ∏è</button>
  <button class="iconbtn" id="leaderBtn" title="–õ–∏–¥–µ—Ä–±–æ—Ä–¥">üèÜ</button>
  <button class="iconbtn" id="statsBtn" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">üìä</button>
  <button class="iconbtn" id="ttsToggleBtn" title="–û–∑–≤—É—á–∫–∞ –≤–∫–ª/–≤—ã–∫–ª">üîä</button>
  <button class="iconbtn" id="logoutBtn" title="–í—ã–π—Ç–∏">‚éã</button>
</div>

<div class="sidebar" id="sidebar">
  <h3>üóÇÔ∏è Wiener Taxi Pr√ºfungsassistent</h3>
  <div style="text-align:center; margin:10px 0;">
    <button class="btn voice-btn" id="voiceQuizBtn">üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–π —ç–∫–∑–∞–º–µ–Ω</button>
  </div>
  <div id="catList"></div>
  <hr/>
  <button id="startBtn" class="btn" style="width:100%;margin-top:6px;">‚ñ∂Ô∏è Freies Quiz</button>
  <button id="examBtn" class="btn secondary" style="width:100%;margin-top:8px;">üìù Pr√ºfungsmodus (10 gemischt)</button>
  <button id="officialBtn" class="btn secondary" style="width:100%;margin-top:8px;">‚úÖ Amtlicher Block starten</button>
  <p class="small" style="margin-top:8px">Hotkeys: <b>1..6</b> f√ºr Antworten, <b>Enter</b> = Weiter.</p>
</div>

<div class="quiz-panel" id="quizPanel" aria-live="polite">
  <div class="progress" id="progress"></div>
  <div class="progressbar"><div class="progressbar-fill" id="progressFill"></div></div>

  <div class="question" id="questionText"></div>

  <div class="replay-row">
    <button class="btn secondary" id="replayBtn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–æ–ø—Ä–æ—Å">üîÅ Wiederholen</button>
    <button class="btn secondary" id="replaySlowBtn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–æ–ø—Ä–æ—Å –º–µ–¥–ª–µ–Ω–Ω–µ–µ">üê¢ Langsamer</button>
    <button class="btn voice-btn" id="voiceBtn">üé§ –û—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–º</button>
  </div>
  
  <div class="small" style="text-align:center;margin-top:-6px;margin-bottom:6px;">–ì–æ–≤–æ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (1,2,3,4) –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã</div>

  <div class="options" id="optionsContainer"></div>
  <button class="next-btn" id="nextBtn" style="display:none;">Weiter ‚Üí</button>
  <div id="endBtns" style="display:none;">
    <button class="end-btn" id="againBtn">üîÑ Nochmal spielen</button>
    <button class="end-btn secondary" id="backBtn">üìñ Zur√ºck</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- ====== –î–ê–¢–ê–ü–ê–ö ====== -->
<script type="application/json" id="data-pack">
{
  "regierungs": [
    {"name":"Parlament (Nationalrat und Bundesrat)","address":"Dr.-Karl-Renner-Ring 3","coords":[48.207989,16.359167]},
    {"name":"Bundespr√§sident (Pr√§sidentschaftskanzlei) [Hofburg]","address":"Ballhausplatz 1","coords":[48.208025,16.364581]},
    {"name":"Bundeskanzleramt","address":"Ballhausplatz 2","coords":[48.208386,16.363781]},
    {"name":"Bundesministerium f√ºr Inneres","address":"Herrengasse 7","coords":[48.209108,16.365931]},
    {"name":"Bundesministerium f√ºr Europ√§ische und Internationale Angelegenheiten","address":"Minoritenplatz 8","coords":[48.209347,16.364694]},
    {"name":"Bundesministerium f√ºr Bildung, Wissenschaft und Forschung","address":"Minoritenplatz 5","coords":[48.209945,16.363575]},
    {"name":"Bundesministerium f√ºr Digitalisierung und Wirtschaftsstandort","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Arbeit","address":"Taborstra√üe 1-3","coords":[48.212990,16.379061]},
    {"name":"Bundesministerium f√ºr Finanzen","address":"Johannesgasse 5","coords":[48.205108,16.372069]},
    {"name":"Bundesministerium f√ºr Klimaschutz, Umwelt, Energie, Mobilit√§t, Innovation und Technologie","address":"Radetzkystra√üe 2","coords":[48.211219,16.386589]},
    {"name":"Bundesministerium f√ºr Kunst, Kultur, √∂ffentlichen Dienst und Sport","address":"Radetzkystra√üe 2","coords":[48.211219,16.386589]},
    {"name":"Bundesministerium f√ºr Landwirtschaft, Regionen und Tourismus","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Soziales, Gesundheit, Pflege und Konsumentenschutz","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Justiz","address":"Museumstra√üe 7","coords":[48.205833,16.355278]},
    {"name":"Bundesministerium f√ºr Landesverteidigung","address":"Ro√üauer L√§nde 1","coords":[48.218186,16.367650]},
    {"name":"Landesregierung und B√ºrgermeister/Landeshauptmann (Rathaus)","address":"Rathausplatz 1","coords":[48.210800,16.357400]}
  ],

  "gerichte": [
    {"name":"Verfassungsgerichtshof","address":"Freyung 8","coords":[48.211478,16.366125]},
    {"name":"Verwaltungsgerichtshof","address":"Judenplatz 11","coords":[48.211600,16.370111]},
    {"name":"Oberster Gerichtshof","address":"Schmerlingplatz 10-11","coords":[48.206450,16.357230]},
    {"name":"Oberlandesgericht Wien","address":"Schmerlingplatz 10-11","coords":[48.206450,16.357230]},
    {"name":"Landesgericht f√ºr Zivilrechtssachen Wien","address":"Schmerlingplatz 10-11","coords":[48.206710,16.357590]},
    {"name":"Landesgericht f√ºr Strafsachen","address":"Landesgerichtsstra√üe 11","coords":[48.213820,16.354970]},
    {"name":"Justizanstalt Wien Josefstadt","address":"Wickenburggasse 18-20","coords":[48.213727,16.354119]},
    {"name":"Rechnungshof","address":"Dampfschiffstra√üe 2","coords":[48.212610,16.388150]}
  ],

  "tarif": [
    {"q":"Wie hoch ist die Grundtaxe am Tag?","a":"3,80 ‚Ç¨","distractors":["4,30 ‚Ç¨","3,50 ‚Ç¨","2,90 ‚Ç¨"]},
    {"q":"Wie hoch ist die Grundtaxe in der Nacht / an Sonn- und Feiertagen?","a":"4,30 ‚Ç¨","distractors":["3,80 ‚Ç¨","5,00 ‚Ç¨","4,90 ‚Ç¨"]},
    {"q":"Wie hoch ist die Zeittaxe f√ºr eine Stunde Wartezeit?","a":"34,80 ‚Ç¨","distractors":["28,00 ‚Ç¨","40,00 ‚Ç¨","20,00 ‚Ç¨"]}
  ]
}
</script>

<script>
/* ================= helpers ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toast = (m,ms=1900)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); };
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]] } return x; }

/* ================= map ================= */
let map=null;
try{
  if(window.L){
    map = L.map('map',{zoomControl:true}).setView([48.2082,16.3738],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'¬© OpenStreetMap' }).addTo(map);
  }
} catch(e){}
let currentMarker = null;
let currentPopup = null;

function icon(status='blue', pulse=false){
  const sym = status==='green'?'‚úì':status==='red'?'‚úó':'‚Ä¢';
  const cls = `mk ${status==='green'?'green':status==='red'?'red':'blue'} ${pulse?'pulse':''}`;
  return (window.L && L.divIcon) ? L.divIcon({className:'', html:`<div class="${cls}">${sym}</div>`, iconSize:[26,26], iconAnchor:[13,13]}) : null;
}

function fly([lat,lng], zoom=16){ 
    if(!map) return; 
    map.flyTo([lat,lng], zoom, {duration:1.0}); 
}

function clearMap() {
    if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
    }
    if (currentPopup) {
        map.removeLayer(currentPopup);
        currentPopup = null;
    }
}

function showLocationOnMap(coords, name, address, status = 'blue') {
    clearMap();
    
    if (!coords) return;
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
    currentMarker = L.marker(coords, {icon: icon(status, true)}).addTo(map);
    
    // –°–æ–∑–¥–∞–µ–º popup —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ –∞–¥—Ä–µ—Å–æ–º
    const popupContent = `<div class="answer-popup"><b>${name}</b><br>${address}</div>`;
    currentMarker.bindPopup(popupContent).openPopup();
    
    fly(coords, 16);
}

function updateMarkerStatus(status, correctAnswer = null) {
    if (currentMarker) {
        currentMarker.setIcon(icon(status, false));
        if (correctAnswer) {
            const newContent = currentMarker.getPopup().getContent() + `<br><div style="color: ${status === 'green' ? '#16a34a' : '#dc2626'}; margin-top: 5px;"><b>${correctAnswer}</b></div>`;
            currentMarker.setPopupContent(newContent);
        }
    }
}

/* ================= –ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã (ASR) - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø ================= */
let speechRecognition = null;
let isListening = false;

function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        speechRecognition = new SpeechRecognition();
        speechRecognition.continuous = false;
        speechRecognition.interimResults = false;
        speechRecognition.lang = 'de-DE';
        
        speechRecognition.onstart = () => {
            isListening = true;
            $("#voiceBtn").innerHTML = "üé§ –°–ª—É—à–∞—é...";
            $("#voiceBtn").classList.add("voice-listening");
            toast("–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å...");
        };
        
        speechRecognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            console.log("–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:", transcript);
            processVoiceAnswer(transcript);
        };
        
        speechRecognition.onerror = (event) => {
            console.warn("Speech recognition error", event.error);
            if (event.error === 'not-allowed') {
                toast("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞");
            }
            stopVoiceRecognition();
        };
        
        speechRecognition.onend = () => {
            stopVoiceRecognition();
        };
    } else {
        console.warn("Speech Recognition not supported");
        $("#voiceBtn").style.display = "none";
        $("#voiceQuizBtn").style.display = "none";
    }
}

function startVoiceRecognition() {
    if (!speechRecognition) {
        toast("–ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ");
        return;
    }
    
    if (isListening) {
        stopVoiceRecognition();
        return;
    }
    
    try {
        speechRecognition.start();
        toast("–°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (1,2,3,4)");
    } catch (error) {
        console.warn("Speech recognition start error:", error);
        toast("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
    }
}

function stopVoiceRecognition() {
    if (speechRecognition && isListening) {
        speechRecognition.stop();
    }
    isListening = false;
    $("#voiceBtn").innerHTML = "üé§ –û—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–º";
    $("#voiceBtn").classList.remove("voice-listening");
}

function processVoiceAnswer(transcript) {
    const cleanAnswer = transcript.trim().toLowerCase();
    console.log("–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –æ—Ç–≤–µ—Ç:", cleanAnswer);
    
    const options = $$("#optionsContainer .option");
    
    // –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É (1,2,3,4)
    const numberMatch = cleanAnswer.match(/(\d)/);
    if (numberMatch && options[numberMatch[1] - 1]) {
        const selectedOption = options[numberMatch[1] - 1];
        const optionText = selectedOption.textContent.replace(/^\d+\.\s*/, "");
        selectedOption.click();
        speak(`–í—ã–±—Ä–∞–Ω–æ: ${numberMatch[1]} - ${optionText}`, 0.7);
        return;
    }
    
    // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –æ—Ç–≤–µ—Ç–∞
    for (let i = 0; i < options.length; i++) {
        const optionText = options[i].textContent.toLowerCase().replace(/^\d+\.\s*/, "");
        if (cleanAnswer.includes(optionText) || optionText.includes(cleanAnswer)) {
            options[i].click();
            speak(`–í—ã —Å–∫–∞–∑–∞–ª–∏: ${optionText}`, 0.7);
            return;
        }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    speak("–ù–µ –ø–æ–Ω—è–ª –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞: 1, 2, 3 –∏–ª–∏ 4.", 0.7);
    toast(`–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}". –°–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—Ç–≤–µ—Ç–∞.`);
}

/* ================= TTS ================= */
let ttsOn=true;
const DEFAULT_RATE = 0.5;
const SLOW_RATE = 0.25;

function speak(text, rate=DEFAULT_RATE){
  if(!ttsOn || !text) return;
  if(!('speechSynthesis' in window)) return;
  
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ä–µ—á—å
  window.speechSynthesis.cancel();
  
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "de-DE";
  u.rate = rate;
  window.speechSynthesis.speak(u);
}

/* ================= –î–∞–Ω–Ω—ã–µ ================= */
const PACK = JSON.parse(document.getElementById('data-pack').textContent);

const THEMEN = [
  {key:"regierungs", title:"1) Regierungsgeb√§ude (Ministerien)", pages:"S.6", official:16},
  {key:"gerichte",   title:"2) Gerichtsgeb√§ude", pages:"S.6‚Äì7", official:8},
  {key:"tarif", title:"III) Wiener Tarif", pages:"S.58-61", official:3}
];

function buildQuestionsFromPack(){
  const data={};
  for(const [key,items] of Object.entries(PACK)){
    if(!Array.isArray(items)) continue;
    
    data[key]=items.map(it=>{
      const q = it.question || `Wo befindet sich ${it.name}?`;
      const right = it.a || it.address;
      const distractors = it.distractors || shuffle(items.filter(o=>(o.a||o.address)!==right).map(o=>o.a||o.address)).slice(0,3);
      return {
        name:it.name||it.q, 
        address:it.address, 
        coords:it.coords||null, 
        question:q, 
        options:shuffle([right,...distractors]), 
        correct:right
      };
    });
  }
  return data;
}
const DATA = buildQuestionsFromPack();

/* ================= Quiz engine ================= */
let selected=[], pool=[], idx=0, score=0, examMode=false, officialMode=false;
let lastQuestionText="";
let currentQuestion = null;

function availableCount(key){ return (DATA[key]||[]).length; }
function buildPool(keys){ const out=[]; keys.forEach(k=>{ if(DATA[k]) out.push(...DATA[k]); }); return shuffle(out); }

function openQuiz(){
  $("#quizPanel").style.display="block"; $("#sidebar").style.display="none";
}

async function showQuestion(first=false){
  const q=pool[idx]; 
  if(!q) return;
  
  currentQuestion = q;

  $("#progress").textContent=`Frage ${idx+1} von ${pool.length}`;
  $("#progressFill").style.width=`${Math.round((idx)/pool.length*100)}%`;
  $("#questionText").textContent=q.question;

  const cont=$("#optionsContainer"); cont.innerHTML="";
  const options = (q.options && q.options.length) ? q.options : [q.correct || q.address];
  shuffle(options).forEach((opt,i)=>{
    const d=document.createElement("div");
    d.className="option"; d.tabIndex=0; d.dataset.correct=(opt===(q.correct||q.address));
    d.innerHTML=`<strong>${i+1}.</strong> ${opt}`;
    d.onclick=()=>checkAnswer(d,opt);
    d.onkeydown=(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); d.click(); } };
    cont.appendChild(d);
  });
  $("#nextBtn").style.display="none"; $("#endBtns").style.display="none";

  // –ü–û–ö–ê–ó–´–í–ê–ï–ú –ú–ê–†–ö–ï–† –°–†–ê–ó–£ –ü–†–ò –í–û–ü–†–û–°–ï
  if (q.coords) {
    showLocationOnMap(q.coords, q.name || q.q, q.address || q.correct, 'blue');
  }

  lastQuestionText = `${q.name||""}. ${q.question}`;
  speak(lastQuestionText, 0.5);
}

async function checkAnswer(el,opt){
  const q=currentQuestion; 
  const right=(opt===(q.correct||q.address));
  
  $$("#optionsContainer .option").forEach(o=>o.onclick=null);
  el.classList.add(right?"correct":"incorrect");
  
  if(!right){ 
    const r=$$("#optionsContainer .option").find(x=>x.dataset.correct==="true"); 
    if(r) r.classList.add("correct"); 
  }
  
  if(right) score++;

  // –û–ë–ù–û–í–õ–Ø–ï–ú –ú–ê–†–ö–ï–† –° –ü–†–ê–í–ò–õ–¨–ù–´–ú –û–¢–í–ï–¢–û–ú
  if (q.coords) {
    updateMarkerStatus(right ? 'green' : 'red', q.address || q.correct);
  }

  $("#nextBtn").style.display="block";

  if(right){
    speak(`Richtig. ${q.correct || q.address}.`, 0.5);
  }else{
    speak(`Leider falsch. Richtig ist: ${q.correct || q.address}.`, 0.5);
  }
}

function nextQuestion(){
  idx++;
  if(idx<pool.length){ 
    showQuestion(); 
  } else {
    $("#questionText").textContent=`Fertig! Punkte: ${score}/${pool.length}`;
    $("#optionsContainer").innerHTML=""; $("#progress").textContent=""; $("#progressFill").style.width="100%";
    $("#nextBtn").style.display="none"; $("#endBtns").style.display="block"; 
    clearMap();
    speak(`Fertig. Punkte: ${score} von ${pool.length}.`, 0.5);
  }
}

function backToMenu(){ 
  $("#quizPanel").style.display="none"; 
  $("#sidebar").style.display="block"; 
  $("#endBtns").style.display="none"; 
  clearMap(); 
}

function restartQuiz(){ 
  $("#endBtns").style.display="none"; 
  idx=0; score=0; 
  pool=shuffle(pool); 
  showQuestion(true); 
}

async function startQuiz(mode="normal"){
  const checked=$$("#catList input[type=checkbox]:checked").map(x=>x.value);
  if(checked.length===0){ toast("Bitte Kategorie w√§hlen!"); return; }
  selected=checked; examMode=(mode==="exam"); officialMode=false;
  pool=buildPool(selected);
  if(examMode && pool.length>10) pool=pool.slice(0,10);
  idx=0; score=0; openQuiz();
  await showQuestion(true);
}

function startVoiceQuiz() {
    startQuiz("normal");
}

/* ================= UI Events ================= */
function loadCats(){
  const wrap=$("#catList"); wrap.innerHTML="";
  THEMEN.forEach(t=>{
    const have=availableCount(t.key); const need=t.official||have;
    const div=document.createElement("label"); div.className="cat";
    div.innerHTML=`<input type="checkbox" value="${t.key}" ${["regierungs","gerichte"].includes(t.key) ? "checked" : ""}> <div>${t.title} <span class="small">(${t.pages})</span></div> <span class="meta">${have}/${need}</span>`;
    wrap.appendChild(div);
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.addEventListener("load", ()=>{
    loadCats();
    initSpeechRecognition();
    toast("Wiener Taxi Pr√ºfungsassistent geladen");
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
$("#menuBtn").onclick = ()=>{ $("#sidebar").style.display = $("#sidebar").style.display==="none"?"block":"none"; };
$("#startBtn").onclick = ()=>{ startQuiz("normal"); };
$("#examBtn").onclick  = ()=>{ startQuiz("exam"); };
$("#officialBtn").onclick = ()=>{ startQuiz("official"); };
$("#voiceQuizBtn").onclick = ()=>{ startVoiceQuiz(); };
$("#nextBtn").onclick  = nextQuestion;
$("#againBtn").onclick = restartQuiz;
$("#backBtn").onclick  = backToMenu;
$("#voiceBtn").onclick = startVoiceRecognition;
$("#replayBtn").onclick = ()=>{ speak(lastQuestionText, DEFAULT_RATE); };
$("#replaySlowBtn").onclick = ()=>{ speak(lastQuestionText, SLOW_RATE); };
$("#ttsToggleBtn").onclick = ()=>{ ttsOn=!ttsOn; toast(ttsOn?"üîä –û–∑–≤—É—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞":"üîá –û–∑–≤—É—á–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞"); };

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
document.addEventListener("keydown",(e)=>{
  if($("#quizPanel").style.display!=="block") return;
  const i=["1","2","3","4","5","6"].indexOf(e.key);
  if(i>=0){ const opt=$$("#optionsContainer .option")[i]; if(opt && opt.onclick) opt.click(); }
  if(e.key==="Enter" && getComputedStyle($("#nextBtn")).display!=="none") nextQuestion();
});

// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
$("#loginModal").style.display = "none";
$("#sidebar").style.display = "block";
</script>
</body>
</html>
