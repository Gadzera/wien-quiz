<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wiener Taxi Pr√ºfungsassistent</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --brand:#2563eb; --brand-2:#60a5fa;
  --ok:#16a34a; --err:#dc2626;
  --bg:#ffffff; --panel:#ffffff; --text:#0f172a; --muted:#6b7280;
  --chip:#f8fafc; --border:#e5e7eb;
  --shadow:0 10px 30px rgba(2,6,23,.15);
  --radius:14px;
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b1020; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --chip:#0b1225; --border:#1f2937; --shadow:0 10px 40px rgba(0,0,0,.45);
  }
}
*{ box-sizing:border-box }
html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,sans-serif; }
#map{ position:fixed; inset:0; z-index:1; }

.topbar{
  position:fixed; top:12px; left:12px; right:12px; z-index:1001;
  display:flex; gap:8px; align-items:center; justify-content:flex-start;
  pointer-events:none;
}
.btn{ pointer-events:auto; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
      color:white; background:linear-gradient(180deg,var(--brand),#1e40af); box-shadow:var(--shadow); margin-right: auto; }
.btn.secondary{ background:#334155; }
.iconbtn{ pointer-events:auto; border:none; border-radius:10px; padding:10px 12px; background:#111827; color:#fff; opacity:.9; cursor:pointer; }
.iconbtn:hover{ opacity:1; }
.spacer{ flex:1 }

.sidebar{
  position:fixed; top:64px; left:12px; z-index:1000; width:360px; max-height:78vh; overflow:auto;
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); display:block;
}
.sidebar h3{ margin:0 0 8px 0; }
.cat{ display:flex; align-items:center; gap:8px; padding:8px; margin:8px 0; background:var(--chip); border-left:4px solid var(--brand); border-radius:10px; }
.cat .count{ margin-left:auto; color:var(--muted); font-size:12px; }

.quiz-panel{
  position:fixed; top:64px; right:12px; z-index:1000; width:380px; max-height:78vh; overflow:auto;
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none;
}
.question{ font-weight:700; margin:8px 0 10px; text-align:center; }
.progress{ text-align:center; font-size:13px; color:var(--muted); }
.progressbar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px 0 12px; }
.progressbar-fill{ height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }

.options{ display:grid; gap:8px; }
.option{ padding:12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:transparent; }
.option:hover{ border-color:var(--brand); background:rgba(37,99,235,.07); }
.option.correct{ border-color:var(--ok); background:#f0fdf4; }
.option.incorrect{ border-color:var(--err); background:#fef2f2; }

.next-btn,.end-btn{ margin-top:10px; width:100%; font-weight:800; border:none; border-radius:10px; padding:10px 14px; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); cursor:pointer; }
.end-btn.secondary{ background:#334155; }

.panel{
  position:fixed; top:64px; right:410px; z-index:1000; width:460px; max-height:78vh; overflow:auto;
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none;
}
.panel h3{ margin:0 0 10px 0 }
.row{ display:flex; gap:10px; flex-wrap:wrap; }
.kbd{ font-family:ui-monospace,monospace; background:#111827; color:#fff; padding:2px 6px; border-radius:6px; }

.toast{
  position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(20px);
  background:rgba(17,24,39,.95); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:var(--shadow);
  opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:3000; font-size:13px;
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

/* G√ºrtel highlight */
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }
.badge-inner{ background:#0ea5e9; color:#fff; }
.badge-outer{ background:#f59e0b; color:#111; }
.small{ font-size:12px; color:var(--muted); }
hr{ border:none; border-top:1px solid var(--border); margin:10px 0; }

.stats-panel {
  background: var(--panel);
  padding: 15px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.question-editor {
  background: var(--chip);
  padding: 15px;
  border-radius: var(--radius);
  margin: 10px 0;
  border: 1px solid var(--border);
}

.question-editor textarea, .question-editor input {
  width: 100%;
  padding: 8px;
  margin: 5px 0;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
}

.question-editor button {
  margin: 5px;
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  background: var(--brand);
  color: white;
  cursor: pointer;
}
</style>
</head>
<body>

<div id="map"></div>

<!-- Topbar -->
<div class="topbar">
  <button class="btn" id="menuBtn">‚ò∞ Themen</button>
  <div class="spacer"></div>
  <button class="iconbtn" id="studyBtn" title="G√ºrtel lernen">üß≠ G√ºrtel</button>
  <button class="iconbtn" id="editBtn" title="Fragen bearbeiten">‚úèÔ∏è</button>
  <button class="iconbtn" id="statsBtn" title="Statistik">üìä</button>
  <button class="iconbtn" id="ttsToggleBtn" title="Sprachausgabe">üîä</button>
</div>

<!-- Sidebar: Kategorien -->
<div class="sidebar" id="sidebar">
  <h3>üóÇÔ∏è Pr√ºfungsfragen Taxilenker</h3>
  <div id="catList"></div>
  <button id="startBtn" class="btn" style="margin-top:10px;width:100%;">‚ñ∂Ô∏è Quiz starten</button>
  <button id="examBtn" class="btn secondary" style="margin-top:8px;width:100%;">üìù Pr√ºfungsmodus (10 Fragen)</button>
  <p class="small" style="margin-top:8px">Tasten: <span class="kbd">1-4</span> = Antworten, <span class="kbd">Enter</span> = Weiter</p>
</div>

<!-- Quiz Panel -->
<div class="quiz-panel" id="quizPanel" aria-live="polite">
  <div class="progress" id="progress"></div>
  <div class="progressbar"><div class="progressbar-fill" id="progressFill"></div></div>
  <div class="question" id="questionText"></div>
  <div class="options" id="optionsContainer"></div>
  <button class="next-btn" id="nextBtn" style="display:none;">Weiter ‚Üí</button>
  <div id="endBtns" style="display:none;">
    <button class="end-btn" id="againBtn">üîÑ Nochmal spielen</button>
    <button class="end-btn secondary" id="backBtn">üìñ Zur√ºck</button>
  </div>
</div>

<!-- Panel: G√ºrtel Study -->
<div class="panel" id="studyPanel">
  <h3>üß≠ G√ºrtel lernen</h3>
  <p class="small">Klicken Sie auf eine Kreuzung, um sie auf der Karte zu sehen</p>
  <div id="studyList"></div>
</div>

<!-- Panel: Question Editor -->
<div class="panel" id="editPanel">
  <h3>‚úèÔ∏è Fragen bearbeiten</h3>
  <div class="question-editor">
    <select id="categorySelect">
      <option value="">Kategorie w√§hlen</option>
    </select>
    <input type="text" id="questionName" placeholder="Fragenname">
    <textarea id="questionTextEdit" placeholder="Fragentext"></textarea>
    <input type="text" id="option1" placeholder="Antwort 1">
    <input type="text" id="option2" placeholder="Antwort 2">
    <input type="text" id="option3" placeholder="Antwort 3">
    <input type="text" id="option4" placeholder="Antwort 4">
    <select id="correctAnswer">
      <option value="">Richtige Antwort</option>
      <option value="0">Antwort 1</option>
      <option value="1">Antwort 2</option>
      <option value="2">Antwort 3</option>
      <option value="3">Antwort 4</option>
    </select>
    <button id="saveQuestion">üíæ Frage speichern</button>
    <button id="loadDefault" class="secondary">üîÑ Standardfragen laden</button>
  </div>
</div>

<!-- Panel: Stats -->
<div class="panel" id="statsPanel">
  <h3>üìä Statistik</h3>
  <div class="stats-panel" id="myStats">
    <p>Richtige Antworten: <span id="correctCount">0</span> von <span id="totalCount">0</span></p>
    <p>Erfolgsquote: <span id="accuracy">0%</span></p>
    <button class="btn secondary" id="resetStats" style="margin-top:10px;">Statistik zur√ºcksetzen</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
// ============ KONFIGURATION ============
const ELEVEN_API_KEY = "YOUR_API_KEY_HERE"; // Hier ElevenLabs API Key eintragen
const ELEVEN_VOICE_ID = "ROYWaqtov1Lot9vQBM3y";

// Themen aus dem PDF - nur relevante Kategorien
const THEMEN = [
 {key:"orte", title:"Ortskunde - wichtige Adressen", pages:"S.6-22"},
 {key:"betrieb", title:"Betriebsordnung", pages:"S.39-51"},
 {key:"tarif", title:"Wiener Tarif", pages:"S.52-61"},
 {key:"stvo", title:"Stra√üenverkehrsordnung", pages:"S.62-75"},
 {key:"kfg", title:"Kraftfahrgesetz", pages:"S.76-80"},
 {key:"arbeit", title:"Arbeits- und Sozialrecht", pages:"S.84-95"}
];

// ECHTE FRAGEN AUS DEM PDF - mit 4 Antwortm√∂glichkeiten
const DEFAULT_QUESTIONS = {
  orte: [
    { 
      name: "Parlament", 
      question: "Wo befindet sich das Parlament?", 
      options: [
        "1., Dr.-Karl-Renner-Ring 3", 
        "1., Ballhausplatz 2", 
        "1., Herrengasse 7", 
        "1., Stubenring 1"
      ], 
      correct: 0, 
      coords: [48.2079, 16.3593] 
    },
    { 
      name: "Bundeskanzleramt", 
      question: "Wo befindet sich das Bundeskanzleramt?", 
      options: [
        "1., Ballhausplatz 2", 
        "1., Herrengasse 7", 
        "1., Minoritenplatz 5", 
        "1., Johannesgasse 5"
      ], 
      correct: 0, 
      coords: [48.2084, 16.3637] 
    },
    { 
      name: "Verfassungsgerichtshof", 
      question: "Wo befindet sich der Verfassungsgerichtshof?", 
      options: [
        "1., Freyung 8", 
        "1., Schmerlingplatz 10-11", 
        "1., Judenplatz 11", 
        "3., Radetzkystra√üe 2"
      ], 
      correct: 0, 
      coords: [48.2115, 16.3655] 
    },
    { 
      name: "Bundespolizeidirektion", 
      question: "Wo befindet sich die Bundespolizeidirektion Wien?", 
      options: [
        "1., Schottenring 7-9", 
        "8., Hernalser G√ºrtel 6-12", 
        "3., Dietrichgasse 27", 
        "1., Deutschmeisterplatz 3"
      ], 
      correct: 0, 
      coords: [48.2180, 16.3630] 
    },
    { 
      name: "Hauptbahnhof", 
      question: "Wo befindet sich der Wiener Hauptbahnhof?", 
      options: [
        "10., Am Hauptbahnhof 1", 
        "1., Franz-Josefs-Kai", 
        "15., Europaplatz 2", 
        "9., Alfred-Adler-Stra√üe 107"
      ], 
      correct: 0, 
      coords: [48.1848, 16.3785] 
    }
  ],

  betrieb: [
    { 
      name: "Fahrdienst T√§tigkeit", 
      question: "Welche Personen d√ºrfen im Fahrdienst t√§tig sein?", 
      options: [
        "Nur vertrauensw√ºrdige Personen", 
        "Jeder mit F√ºhrerschein", 
        "Nur Personen √ºber 25 Jahre", 
        "Nur √∂sterreichische Staatsb√ºrger"
      ], 
      correct: 0 
    },
    { 
      name: "Lenkverbot", 
      question: "Unter welchen Voraussetzungen ist es dem Lenker untersagt, ein Fahrzeug zu lenken?", 
      options: [
        "Bei Alkohol oder Drogen", 
        "Bei Regenwetter", 
        "Bei Nachtfahrten", 
        "Bei Stau"
      ], 
      correct: 0 
    },
    { 
      name: "Taxilenkerausweis", 
      question: "Wem ist der Taxilenkerausweis auf Verlangen zur √úberpr√ºfung auszuh√§ndigen?", 
      options: [
        "Polizei und Stra√üenaufsichtsbeh√∂rde", 
        "Nur dem Fahrgast", 
        "Nur dem Arbeitgeber", 
        "Niemandem"
      ], 
      correct: 0 
    },
    { 
      name: "Ausweis Verlust", 
      question: "Wie verhalten Sie sich, wenn Sie den Taxilenkerausweis verloren haben?", 
      options: [
        "Unverz√ºglich Verlustanzeige machen", 
        "Weiterfahren bis zur n√§chsten Polizeistation", 
        "Neuen Ausweis im Internet bestellen", 
        "Einen Monat warten"
      ], 
      correct: 0 
    }
  ],

  tarif: [
    { 
      name: "Grundtaxe Tag", 
      question: "Wie hoch ist die Grundtaxe am Tag?", 
      options: [
        "3,80 ‚Ç¨", 
        "4,30 ‚Ç¨", 
        "3,50 ‚Ç¨", 
        "2,90 ‚Ç¨"
      ], 
      correct: 0 
    },
    { 
      name: "Grundtaxe Nacht", 
      question: "Wie hoch ist die Grundtaxe nachts/So/Feiertag?", 
      options: [
        "4,30 ‚Ç¨", 
        "3,80 ‚Ç¨", 
        "5,00 ‚Ç¨", 
        "4,90 ‚Ç¨"
      ], 
      correct: 0 
    },
    { 
      name: "Zeittaxe", 
      question: "Wie hoch ist die Zeittaxe f√ºr eine Stunde Wartezeit?", 
      options: [
        "34,80 ‚Ç¨", 
        "28,00 ‚Ç¨", 
        "40,00 ‚Ç¨", 
        "25,00 ‚Ç¨"
      ], 
      correct: 0 
    },
    { 
      name: "Zuschlag", 
      question: "Wie hoch ist der Zuschlag f√ºr bestellte Fahrten?", 
      options: [
        "2,00 ‚Ç¨", 
        "3,00 ‚Ç¨", 
        "1,00 ‚Ç¨", 
        "5,00 ‚Ç¨"
      ], 
      correct: 0 
    }
  ],

  stvo: [
    { 
      name: "Wohnstra√üe", 
      question: "D√ºrfen Taxis durch Wohnstra√üen durchfahren?", 
      options: [
        "Nur mit Schrittgeschwindigkeit", 
        "Ja, ohne Einschr√§nkung", 
        "Nein, verboten", 
        "Nur tags√ºber"
      ], 
      correct: 0 
    },
    { 
      name: "Einsatzfahrzeug", 
      question: "Wie verhalten Sie sich gegen√ºber einem Einsatzfahrzeug?", 
      options: [
        "Platz machen f√ºr Durchfahrt", 
        "Weiterfahren wie bisher", 
        "Schneller fahren", 
        "Anhalten wo man ist"
      ], 
      correct: 0 
    },
    { 
      name: "Alkoholgrenze", 
      question: "Wie hoch ist die Promillegrenze f√ºr Taxilenker?", 
      options: [
        "0,1 ‚Ä∞", 
        "0,5 ‚Ä∞", 
        "0,0 ‚Ä∞", 
        "0,3 ‚Ä∞"
      ], 
      correct: 0 
    },
    { 
      name: "Handy am Steuer", 
      question: "Darf man als Taxilenker das Handy benutzen?", 
      options: [
        "Nur mit Freisprecheinrichtung", 
        "Ja, ohne Einschr√§nkung", 
        "Nein, niemals", 
        "Nur im Stand"
      ], 
      correct: 0 
    }
  ],

  kfg: [
    { 
      name: "Winterreifenpflicht", 
      question: "F√ºr Taxis gilt Winterreifenpflicht ‚Ä¶", 
      options: [
        "1. Nov ‚Äì 15. Apr bei winterlichen Verh√§ltnissen", 
        "1. Okt ‚Äì 1. M√§rz", 
        "Ganzj√§hrig", 
        "Nur bei Schnee"
      ], 
      correct: 0 
    },
    { 
      name: "Mindestprofiltiefe", 
      question: "Mindestprofiltiefe der Sommerreifen bei PKW?", 
      options: [
        "1,6 mm", 
        "2,0 mm", 
        "3,0 mm", 
        "1,0 mm"
      ], 
      correct: 0 
    },
    { 
      name: "Hauptuntersuchung", 
      question: "Wie oft muss ein Taxi zur Hauptuntersuchung?", 
      options: [
        "Einmal j√§hrlich", 
        "Alle 2 Jahre", 
        "Alle 6 Monate", 
        "Alle 3 Jahre"
      ], 
      correct: 0 
    }
  ],

  arbeit: [
    { 
      name: "Mindestlohn", 
      question: "Der kollektivvertragliche Mindestlohn im Taxigewerbe gilt ‚Ä¶", 
      options: [
        "√ñsterreichweit", 
        "Nur in Wien", 
        "Nur f√ºr Unternehmer", 
        "Nur f√ºr Angestellte"
      ], 
      correct: 0 
    },
    { 
      name: "Arbeitszeit", 
      question: "Wie lange darf die t√§gliche Arbeitszeit maximal sein?", 
      options: [
        "12 Stunden", 
        "8 Stunden", 
        "10 Stunden", 
        "9 Stunden"
      ], 
      correct: 0 
    },
    { 
      name: "K√ºndigungsfrist", 
      question: "Wie lange betr√§gt die K√ºndigungsfrist im Taxigewerbe?", 
      options: [
        "6 Wochen", 
        "4 Wochen", 
        "8 Wochen", 
        "2 Wochen"
      ], 
      correct: 0 
    }
  ]
};

// G√ºrtel-Kreuzungen f√ºr Lernmodus
const GUERTEL_INTERSECTIONS = [
  { title: "Mariahilfer Stra√üe √ó Mariahilfer G√ºrtel", side: "innerer", coords: [48.1956, 16.3394] },
  { title: "Burggasse √ó Neubaug√ºrtel", side: "innerer", coords: [48.2058, 16.3389] },
  { title: "Lerchenfelder Stra√üe √ó Lerchenfelder G√ºrtel", side: "innerer", coords: [48.2094, 16.3367] },
  { title: "Hernalser Hauptstra√üe √ó Hernalser G√ºrtel", side: "innerer", coords: [48.2185, 16.3326] }
];

// ============ HILFSFUNKTIONEN ============
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toast = (m, ms = 1500) => { 
  const t = $("#toast"); 
  t.textContent = m; 
  t.classList.add("show"); 
  setTimeout(() => t.classList.remove("show"), ms); 
};

function shuffle(a) { 
  const x = a.slice(); 
  for (let i = x.length - 1; i > 0; i--) { 
    const j = Math.floor(Math.random() * (i + 1)); 
    [x[i], x[j]] = [x[j], x[i]]; 
  } 
  return x; 
}

// ============ KARTE ============
const map = L.map('map', { zoomControl: true }).setView([48.2082, 16.3738], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
  attribution: '¬© OpenStreetMap' 
}).addTo(map);

let answerMarker = null, gLayer = null;

function fly([lat, lng], zoom = 16) { 
  map.flyTo([lat, lng], zoom, { duration: 1.0 }); 
}

// ============ DATENVERWALTUNG ============
let DATA = {};

function loadQuestions() {
  const saved = localStorage.getItem('taxiQuizQuestions');
  if (saved) {
    DATA = JSON.parse(saved);
  } else {
    DATA = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
    saveQuestions();
  }
  updateCategoryCounts();
}

function saveQuestions() {
  localStorage.setItem('taxiQuizQuestions', JSON.stringify(DATA));
}

function updateCategoryCounts() {
  THEMEN.forEach(t => {
    const count = DATA[t.key]?.length || 0;
    const countElement = $(`.cat input[value="${t.key}"]`)?.closest('.cat')?.querySelector('.count');
    if (countElement) {
      countElement.textContent = count;
    }
  });
}

// ============ STATISTIK ============
let stats = {
  total: 0,
  correct: 0,
  get accuracy() {
    return this.total > 0 ? Math.round((this.correct / this.total) * 100) : 0;
  }
};

function updateStatsDisplay() {
  $("#correctCount").textContent = stats.correct;
  $("#totalCount").textContent = stats.total;
  $("#accuracy").textContent = stats.accuracy + '%';
}

function saveStats() {
  localStorage.setItem('taxiQuizStats', JSON.stringify(stats));
}

function loadStats() {
  const saved = localStorage.getItem('taxiQuizStats');
  if (saved) {
    stats = JSON.parse(saved);
  }
  updateStatsDisplay();
}

function resetStats() {
  stats = { total: 0, correct: 0 };
  saveStats();
  updateStatsDisplay();
  toast("Statistik zur√ºckgesetzt");
}

// ============ QUIZ-ENGINE ============
let selected = [], pool = [], idx = 0, score = 0, examMode = false;

function buildPool(keys) {
  const out = [];
  keys.forEach(k => { 
    if (DATA[k]) out.push(...DATA[k]); 
  });
  return shuffle(out);
}

function startQuiz(mode = "normal") {
  const checked = $$("#catList input[type=checkbox]:checked").map(x => x.value);
  if (checked.length === 0) { 
    toast("Bitte Kategorie w√§hlen!"); 
    return; 
  }
  
  selected = checked; 
  examMode = (mode === "exam"); 
  pool = buildPool(selected);
  
  if (examMode && pool.length > 10) pool = pool.slice(0, 10);
  
  idx = 0; 
  score = 0;
  $("#quizPanel").style.display = "block";
  $("#sidebar").style.display = "none";
  $("#studyPanel").style.display = "none";
  $("#statsPanel").style.display = "none";
  $("#editPanel").style.display = "none";
  
  showQuestion(true);
}

function showQuestion(first = false) {
  const q = pool[idx]; 
  if (!q) return;
  
  $("#progress").textContent = `Frage ${idx + 1} von ${pool.length}`;
  $("#progressFill").style.width = `${Math.round((idx) / pool.length * 100)}%`;
  $("#questionText").textContent = q.question;
  
  const cont = $("#optionsContainer"); 
  cont.innerHTML = "";
  
  // Nur 4 Antwortm√∂glichkeiten verwenden
  const validOptions = q.options.filter(opt => opt && opt.trim() !== '');
  
  shuffle(validOptions).forEach((opt, i) => {
    const d = document.createElement("div");
    d.className = "option"; 
    d.tabIndex = 0; 
    d.dataset.correct = (opt === q.correct);
    d.innerHTML = `<strong>${i + 1}.</strong> ${opt}`;
    d.onclick = () => checkAnswer(d, opt);
    d.onkeydown = (e) => { 
      if (e.key === "Enter" || e.key === " ") { 
        e.preventDefault(); 
        d.click(); 
      } 
    };
    cont.appendChild(d);
  });
  
  $("#nextBtn").style.display = "none";
  $("#endBtns").style.display = "none";
  
  // Sprachausgabe
  speak(q.question);
  
  // Auf Karte zeigen wenn Koordinaten vorhanden
  if (answerMarker) { 
    map.removeLayer(answerMarker); 
    answerMarker = null; 
  }
  
  if (Array.isArray(q.coords)) { 
    fly(q.coords, 16); 
    answerMarker = L.marker(q.coords)
      .addTo(map)
      .bindPopup(`<b>${q.name}</b><br>${q.question}`)
      .openPopup(); 
  }
}

function checkAnswer(el, opt) {
  const q = pool[idx];
  const ok = (opt === q.correct);
  
  // Klick-Events entfernen
  $$("#optionsContainer .option").forEach(o => o.onclick = null);
  
  // Antwort markieren
  el.classList.add(ok ? "correct" : "incorrect");
  
  if (!ok) { 
    const correctOption = $$("#optionsContainer .option").find(x => x.dataset.correct === "true"); 
    if (correctOption) correctOption.classList.add("correct"); 
  }
  
  if (ok) score++;

  // Statistik aktualisieren
  stats.total++;
  if (ok) stats.correct++;
  saveStats();
  updateStatsDisplay();

  // Sprachfeedback
  speak(ok ? "Richtig. Gut gemacht." : `Leider falsch. Richtig ist: ${q.correct}.`);
  
  $("#nextBtn").style.display = "block";
}

function nextQuestion() {
  idx++;
  if (idx < pool.length) { 
    showQuestion(); 
  } else {
    // Quiz beendet
    $("#questionText").textContent = `Fertig! Punkte: ${score}/${pool.length}`;
    $("#optionsContainer").innerHTML = "";
    $("#progress").textContent = ""; 
    $("#progressFill").style.width = "100%";
    $("#nextBtn").style.display = "none"; 
    $("#endBtns").style.display = "block";
    speak(`Fertig. Punkte: ${score} von ${pool.length}.`);
  }
}

function backToMenu() { 
  $("#quizPanel").style.display = "none"; 
  $("#sidebar").style.display = "block"; 
  $("#endBtns").style.display = "none"; 
}

function restartQuiz() { 
  $("#endBtns").style.display = "none"; 
  idx = 0; 
  score = 0; 
  pool = shuffle(pool); 
  showQuestion(true); 
}

// ============ G√úRTEL LERNMODUS ============
function openStudy() {
  $("#studyPanel").style.display = "block";
  $("#statsPanel").style.display = "none";
  $("#sidebar").style.display = "none";
  $("#quizPanel").style.display = "none";
  $("#editPanel").style.display = "none";
  
  const list = $("#studyList"); 
  list.innerHTML = "";
  
  GUERTEL_INTERSECTIONS.forEach((g, i) => {
    const div = document.createElement("div");
    div.className = "item";
    div.style.cssText = "padding:8px 10px;border-bottom:1px dashed var(--border);cursor:pointer";
    div.innerHTML = `${i + 1}. ${g.title} ‚Äî <span class="badge ${g.side === 'innerer' ? 'badge-inner' : 'badge-outer'}">${g.side} G√ºrtel</span>`;
    div.onclick = () => {
      fly(g.coords, 16);
      if (gLayer) map.removeLayer(gLayer);
      gLayer = L.marker(g.coords)
        .addTo(map)
        .bindPopup(`<b>${g.title}</b><br><span class="badge ${g.side === 'innerer' ? 'badge-inner' : 'badge-outer'}">${g.side} G√ºrtel</span>`)
        .openPopup();
    };
    list.appendChild(div);
  });
  
  toast("G√ºrtel-Lernmodus ge√∂ffnet");
}

// ============ FRAGEN-EDITOR ============
function openEditor() {
  $("#editPanel").style.display = "block";
  $("#statsPanel").style.display = "none";
  $("#sidebar").style.display = "none";
  $("#quizPanel").style.display = "none";
  $("#studyPanel").style.display = "none";
  
  // Kategorien f√ºllen
  const categorySelect = $("#categorySelect");
  categorySelect.innerHTML = '<option value="">Kategorie w√§hlen</option>';
  THEMEN.forEach(t => {
    const option = document.createElement("option");
    option.value = t.key;
    option.textContent = `${t.title} (${DATA[t.key]?.length || 0} Fragen)`;
    categorySelect.appendChild(option);
  });
}

function saveNewQuestion() {
  const category = $("#categorySelect").value;
  const name = $("#questionName").value.trim();
  const question = $("#questionTextEdit").value.trim();
  const options = [
    $("#option1").value.trim(),
    $("#option2").value.trim(),
    $("#option3").value.trim(),
    $("#option4").value.trim()
  ].filter(opt => opt !== '');
  
  const correctIndex = parseInt($("#correctAnswer").value);
  
  if (!category || !name || !question || options.length < 2 || isNaN(correctIndex)) {
    toast("Bitte alle Felder korrekt ausf√ºllen!");
    return;
  }
  
  if (!DATA[category]) {
    DATA[category] = [];
  }
  
  const newQuestion = {
    name,
    question,
    options,
    correct: options[correctIndex]
  };
  
  DATA[category].push(newQuestion);
  saveQuestions();
  updateCategoryCounts();
  
  // Formular zur√ºcksetzen
  $("#questionName").value = "";
  $("#questionTextEdit").value = "";
  $("#option1").value = "";
  $("#option2").value = "";
  $("#option3").value = "";
  $("#option4").value = "";
  $("#correctAnswer").value = "";
  
  toast("Frage gespeichert!");
}

function loadDefaultQuestions() {
  if (confirm("Standardfragen laden? Aktuelle Fragen gehen verloren.")) {
    DATA = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
    saveQuestions();
    updateCategoryCounts();
    toast("Standardfragen geladen");
  }
}

// ============ SPRACHAUSGABE ============
let ttsOn = false; // Standardm√§√üig aus, da API Key ben√∂tigt wird
const audioEl = new Audio(); 
audioEl.volume = 1;
let queue = [], playing = false;

function speak(text) {
  if (!ttsOn || !text) return;
  queue.push(text);
  if (!playing) nextSpeak();
}

async function nextSpeak() {
  if (queue.length === 0) { 
    playing = false; 
    return; 
  }
  
  playing = true; 
  const text = queue.shift();
  
  try {
    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVEN_VOICE_ID}?optimize_streaming_latency=3`, {
      method: "POST",
      headers: { 
        "xi-api-key": ELEVEN_API_KEY, 
        "Content-Type": "application/json", 
        "Accept": "audio/mpeg" 
      },
      body: JSON.stringify({ 
        text: text, 
        model_id: "eleven_multilingual_v2", 
        voice_settings: { 
          stability: 0.4, 
          similarity_boost: 0.8, 
          style: 0, 
          use_speaker_boost: true 
        } 
      })
    });
    
    if (res.ok) {
      const blob = await res.blob();
      audioEl.src = URL.createObjectURL(blob);
      await audioEl.play();
      audioEl.onended = () => nextSpeak();
    }
  } catch (e) {
    console.warn("TTS error", e); 
    playing = false;
  }
}

function stopSpeak() { 
  try { 
    audioEl.pause(); 
    audioEl.currentTime = 0; 
  } catch {} 
  queue = []; 
  playing = false; 
}

// ============ UI-BINDINGS ============
function loadCats() {
  const wrap = $("#catList"); 
  wrap.innerHTML = "";
  
  THEMEN.forEach(t => {
    const count = DATA[t.key]?.length || 0;
    const div = document.createElement("label"); 
    div.className = "cat";
    div.innerHTML = `
      <input type="checkbox" value="${t.key}" checked> 
      <div>${t.title} <span class="small">(${t.pages})</span></div> 
      <span class="count">${count}</span>
    `;
    wrap.appendChild(div);
  });
}

// Event Listeners
$("#menuBtn").onclick = () => { 
  const s = $("#sidebar"); 
  s.style.display = (s.style.display === "block" ? "none" : "block"); 
};

$("#startBtn").onclick = () => startQuiz("normal");
$("#examBtn").onclick = () => startQuiz("exam");
$("#nextBtn").onclick = nextQuestion;
$("#againBtn").onclick = restartQuiz;
$("#backBtn").onclick = backToMenu;
$("#studyBtn").onclick = openStudy;
$("#editBtn").onclick = openEditor;
$("#statsBtn").onclick = () => { 
  $("#statsPanel").style.display = "block"; 
  $("#studyPanel").style.display = "none"; 
  $("#sidebar").style.display = "none"; 
  $("#quizPanel").style.display = "none"; 
  $("#editPanel").style.display = "none";
};

$("#ttsToggleBtn").onclick = () => { 
  ttsOn = !ttsOn; 
  toast(ttsOn ? "üîä Sprachausgabe eingeschaltet" : "üîá Sprachausgabe ausgeschaltet"); 
  if (!ttsOn) stopSpeak(); 
};

$("#resetStats").onclick = resetStats;
$("#saveQuestion").onclick = saveNewQuestion;
$("#loadDefault").onclick = loadDefaultQuestions;

// Tastatursteuerung
document.addEventListener("keydown", (e) => {
  if ($("#quizPanel").style.display !== "block") return;
  
  const i = ["1", "2", "3", "4"].indexOf(e.key);
  if (i >= 0) { 
    const opt = $$("#optionsContainer .option")[i]; 
    if (opt && opt.onclick) opt.click(); 
  }
  
  if (e.key === "Enter" && $("#nextBtn").style.display === "block") nextQuestion();
});

// ============ INITIALISIERUNG ============
window.addEventListener("load", () => { 
  loadQuestions();
  loadStats();
  loadCats();
  toast("Willkommen! W√§hlen Sie Themen aus."); 
  
  // Alle Panels au√üer Sidebar ausblenden
  $("#statsPanel").style.display = "none";
  $("#editPanel").style.display = "none";
  $("#studyPanel").style.display = "none";
  $("#quizPanel").style.display = "none";
});
</script>
</body>
</html>
