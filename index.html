<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wiener Taxi Pr√ºfungsassistent</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --brand:#2563eb; --brand-2:#60a5fa; --ok:#16a34a; --err:#dc2626; --warn:#f59e0b;
  --bg:#ffffff; --panel:#ffffff; --text:#0f172a; --muted:#6b7280;
  --chip:#f8fafc; --border:#e5e7eb; --shadow:0 10px 30px rgba(2,6,23,.15); --radius:14px;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1020; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --chip:#0b1225; --border:#1f2937; --shadow:0 10px 40px rgba(0,0,0,.45); }
}
*{ box-sizing:border-box } html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,sans-serif; }
#map{ position:fixed; inset:0; z-index:1; }

/* topbar */
.topbar{
  position:fixed;
  top:12px;
  left:12px;
  right:12px;
  display:flex;
  justify-content:space-between;
  gap:8px;
  z-index:1500;
}

.btn{ pointer-events:auto; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); box-shadow:var(--shadow); }
.btn.secondary{ background:#334155; }
.iconbtn{ pointer-events:auto; border:none; border-radius:10px; padding:10px 12px; background:#111827; color:#fff; opacity:.95; cursor:pointer; }
.spacer{ flex:1 }

/* sidebar */
.sidebar{ position:fixed; top:64px; right:12px; z-index:1000; width:420px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); display:none; }
.sidebar h3{ margin:0 0 8px 0; }
.cat{ display:flex; align-items:center; gap:8px; padding:8px; margin:8px 0; background:var(--chip); border-left:4px solid var(--brand); border-radius:10px; }
.cat .meta{ margin-left:auto; font-size:12px; color:var(--muted); }
.small{ font-size:12px; color:var(--muted); }
hr{ border:none; border-top:1px solid var(--border); margin:10px 0; }

/* quiz */
.quiz-panel{ position:fixed; top:64px; right:12px; z-index:1000; width:500px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none; }
.question{ font-weight:800; margin:8px 0 10px; text-align:center; }
.progress{ text-align:center; font-size:13px; color:var(--muted); }
.progressbar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px 0 12px; }
.progressbar-fill{ height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }
.options{ display:grid; gap:8px; }
.option{ padding:12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:transparent; }
.option:hover{ border-color:var(--brand); background:rgba(37,99,235,.07); }
.option.correct{ border-color:var(--ok); background:#f0fdf4; }
.option.incorrect{ border-color:var(--err); background:#fef2f2; }
.replay-row{ display:flex; gap:8px; justify-content:center; margin:6px 0 4px; }
.next-btn,.end-btn{ margin-top:10px; width:100%; font-weight:800; border:none; border-radius:10px; padding:10px 14px; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); cursor:pointer; }
.end-btn.secondary{ background:#334155; }

/* voice button */
.voice-btn{ background:linear-gradient(180deg,#8b5cf6,#7c3aed) !important; }
.voice-listening{ background:linear-gradient(180deg,#dc2626,#b91c1c) !important; animation:pulse 1.5s infinite; }
@keyframes pulse{ 0%{ opacity:1; } 50%{ opacity:0.7; } 100%{ opacity:1; } }

/* Marker icons */
.leaflet-div-icon { background: transparent; border: none; }
.mk{ width:26px; height:26px; border-radius:50%; display:grid; place-items:center; color:#fff; font-weight:900; font-size:14px; box-shadow:0 2px 10px rgba(0,0,0,.35); border:2px solid rgba(255,255,255,.9); }
.mk.blue{ background:#2563eb; }
.mk.green{ background:#16a34a; }
.mk.red{ background:#dc2626; }
.mk.pulse{ box-shadow:0 0 0 0 rgba(37,99,235,.45); animation:mkpulse 1.4s infinite; }
@keyframes mkpulse{ 0%{ box-shadow:0 0 0 0 rgba(37,99,235,.45);} 70%{ box-shadow:0 0 0 16px rgba(37,99,235,0);} 100%{ box-shadow:0 0 0 0 rgba(37,99,235,0);} }

/* map popup */
.answer-popup { font-weight: bold; color: #1e40af; }
</style>
</head>
<body>

<div id="map"></div>

<div class="topbar">
  <button class="btn" id="menuBtn">‚ò∞ Themen</button>
  <div class="spacer"></div>
  <button class="iconbtn" id="voiceModeBtn" title="Sprachmodus">üéôÔ∏è</button>
  <button class="iconbtn" id="ttsToggleBtn" title="Sprachausgabe ein/aus">üîä</button>
</div>

<div class="sidebar" id="sidebar">
  <h3>üóÇÔ∏è Wiener Taxi Pr√ºfungsassistent</h3>
  <div style="text-align:center; margin:10px 0;">
    <button class="btn voice-btn" id="voiceQuizBtn">üéôÔ∏è Sprachpr√ºfung</button>
  </div>
  <div id="catList"></div>
  <hr/>
  <button id="startBtn" class="btn" style="width:100%;margin-top:6px;">‚ñ∂Ô∏è Freies Quiz</button>
  <button id="examBtn" class="btn secondary" style="width:100%;margin-top:8px;">üìù Pr√ºfungsmodus (10 Fragen)</button>
  <button id="officialBtn" class="btn secondary" style="width:100%;margin-top:8px;">‚úÖ Amtlicher Block starten</button>
  <p class="small" style="margin-top:8px">Tastatur: <b>1..6</b> f√ºr Antworten, <b>Enter</b> = Weiter.</p>
</div>

<div class="quiz-panel" id="quizPanel" aria-live="polite">
  <div class="progress" id="progress"></div>
  <div class="progressbar"><div class="progressbar-fill" id="progressFill"></div></div>

  <div class="question" id="questionText"></div>

  <div class="replay-row">
    <button class="btn secondary" id="replayBtn" title="Frage wiederholen">üîÅ Wiederholen</button>
    <button class="btn secondary" id="replaySlowBtn" title="Frage langsamer wiederholen">üê¢ Langsamer</button>
    <button class="btn voice-btn" id="voiceBtn">üé§ Sprachantwort</button>
  </div>
  
  <div class="small" style="text-align:center;margin-top:-6px;margin-bottom:6px;">Sagen Sie die Antwortnummer (1,2,3,4) oder Stra√üenname</div>

  <div class="options" id="optionsContainer"></div>
  <button class="next-btn" id="nextBtn" style="display:none;">Weiter ‚Üí</button>
  <div id="endBtns" style="display:none;">
    <button class="end-btn" id="againBtn">üîÑ Nochmal spielen</button>
    <button class="end-btn secondary" id="backBtn">üìñ Zur√ºck</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- ====== VOLLST√ÑNDIGER DATENPAKET ====== -->
<script type="application/json" id="data-pack">
{
  "regierungs": [
    {"name":"Parlament (Nationalrat und Bundesrat)","address":"Dr.-Karl-Renner-Ring 3","coords":[48.207989,16.359167]},
    {"name":"Bundespr√§sident (Pr√§sidentschaftskanzlei)","address":"Ballhausplatz 1","coords":[48.208025,16.364581]},
    {"name":"Bundeskanzleramt","address":"Ballhausplatz 2","coords":[48.208386,16.363781]},
    {"name":"Bundesministerium f√ºr Inneres","address":"Herrengasse 7","coords":[48.209108,16.365931]},
    {"name":"Bundesministerium f√ºr Europ√§ische und Internationale Angelegenheiten","address":"Minoritenplatz 8","coords":[48.209347,16.364694]},
    {"name":"Bundesministerium f√ºr Bildung, Wissenschaft und Forschung","address":"Minoritenplatz 5","coords":[48.209945,16.363575]},
    {"name":"Bundesministerium f√ºr Digitalisierung und Wirtschaftsstandort","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Arbeit","address":"Taborstra√üe 1-3","coords":[48.212990,16.379061]},
    {"name":"Bundesministerium f√ºr Finanzen","address":"Johannesgasse 5","coords":[48.205108,16.372069]},
    {"name":"Bundesministerium f√ºr Klimaschutz, Umwelt, Energie, Mobilit√§t, Innovation und Technologie","address":"Radetzkystra√üe 2","coords":[48.211219,16.386589]},
    {"name":"Bundesministerium f√ºr Kunst, Kultur, √∂ffentlichen Dienst und Sport","address":"Radetzkystra√üe 2","coords":[48.211219,16.386589]},
    {"name":"Bundesministerium f√ºr Landwirtschaft, Regionen und Tourismus","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Soziales, Gesundheit, Pflege und Konsumentenschutz","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Justiz","address":"Museumstra√üe 7","coords":[48.205833,16.355278]},
    {"name":"Bundesministerium f√ºr Landesverteidigung","address":"Ro√üauer L√§nde 1","coords":[48.218186,16.367650]},
    {"name":"Landesregierung und B√ºrgermeister/Landeshauptmann (Rathaus)","address":"Rathausplatz 1","coords":[48.210800,16.357400]}
  ],

  "gerichte": [
    {"name":"Verfassungsgerichtshof","address":"Freyung 8","coords":[48.211478,16.366125]},
    {"name":"Verwaltungsgerichtshof","address":"Judenplatz 11","coords":[48.211600,16.370111]},
    {"name":"Oberster Gerichtshof","address":"Schmerlingplatz 10-11","coords":[48.206450,16.357230]},
    {"name":"Oberlandesgericht Wien","address":"Schmerlingplatz 10-11","coords":[48.206450,16.357230]},
    {"name":"Landesgericht f√ºr Zivilrechtssachen Wien","address":"Schmerlingplatz 10-11","coords":[48.206710,16.357590]},
    {"name":"Landesgericht f√ºr Strafsachen","address":"Landesgerichtsstra√üe 11","coords":[48.213820,16.354970]},
    {"name":"Justizanstalt Wien Josefstadt","address":"Wickenburggasse 18-20","coords":[48.213727,16.354119]},
    {"name":"Rechnungshof","address":"Dampfschiffstra√üe 2","coords":[48.212610,16.388150]}
  ],

  "polizei": [
    {"name":"Bundespolizeidirektion Wien - Sicherheitsdirektion","address":"Schottenring 7-9","coords":[48.2175,16.3736]},
    {"name":"Verkehrsamt (F√ºhrerschein/Taxireferat)","address":"Dietrichgasse 27","coords":[48.2028,16.3917]}
  ],

  "stadtpolizei": [
    {"name":"Polizeikommando Innere Stadt","address":"Deutschmeisterplatz 3","coords":[48.2122,16.3694]},
    {"name":"Polizeikommando Landstra√üe","address":"Juchgasse 19","coords":[48.2025,16.3911]},
    {"name":"Polizeikommando Margareten","address":"Viktor Christ-Gasse 19","coords":[48.1886,16.3564]}
  ],

  "hotels": [
    {"name":"Hotel Sacher Wien","address":"Philharmonikerstra√üe 4","coords":[48.2044,16.3697]},
    {"name":"Hotel Imperial","address":"K√§rntner Ring 16","coords":[48.2025,16.3736]},
    {"name":"Hotel Bristol","address":"K√§rntner Ring 1","coords":[48.2042,16.3731]},
    {"name":"Hotel Marriott","address":"Parkring 12a","coords":[48.2078,16.3797]}
  ],

  "cafes": [
    {"name":"Caf√© Central","address":"Herrengasse 14","coords":[48.2106,16.3664]},
    {"name":"Caf√© Landtmann","address":"Universit√§tsring 4","coords":[48.2128,16.3619]},
    {"name":"Caf√© Hawelka","address":"Dorotheergasse 6","coords":[48.2086,16.3686]},
    {"name":"Caf√© Mozart","address":"Albertinaplatz 2","coords":[48.2044,16.3683]}
  ],

  "krankenhaus": [
    {"name":"Allgemeines Krankenhaus (AKH)","address":"W√§hringer G√ºrtel 18-20","coords":[48.2200,16.3475]},
    {"name":"Krankenhaus Hietzing","address":"Wolkersbergenstra√üe 1","coords":[48.1750,16.2667]},
    {"name":"Krankenhaus Rudolfstiftung","address":"Juchgasse 25","coords":[48.2022,16.3914]}
  ],

  "kultur": [
    {"name":"Burgtheater","address":"Universit√§tsring 2","coords":[48.2106,16.3619]},
    {"name":"Staatsoper","address":"Opernring 2","coords":[48.2036,16.3692]},
    {"name":"Volksoper","address":"W√§hringer Stra√üe 78","coords":[48.2300,16.3483]},
    {"name":"Theater an der Wien","address":"Linke Wienzeile 6","coords":[48.1992,16.3542]}
  ],

  "museen": [
    {"name":"Kunsthistorisches Museum","address":"Burgring 5","coords":[48.2039,16.3617]},
    {"name":"Naturhistorisches Museum","address":"Burgring 7","coords":[48.2053,16.3600]},
    {"name":"Albertina","address":"Albertinaplatz 1","coords":[48.2047,16.3683]},
    {"name":"Weltmuseum Wien","address":"Heldenplatz","coords":[48.2058,16.3636]}
  ],

  "universit√§ten": [
    {"name":"Universit√§t Wien","address":"Universit√§tsring 1","coords":[48.2131,16.3597]},
    {"name":"Technische Universit√§t Wien","address":"Karlsplatz 13","coords":[48.1992,16.3694]},
    {"name":"Wirtschaftsuniversit√§t Wien","address":"Welthandelsplatz 1","coords":[48.2333,16.4167]}
  ],

  "betriebsordnung": [
    {"q":"Welche Personen d√ºrfen im Fahrdienst t√§tig sein?","a":"Nur vertrauensw√ºrdige Personen"},
    {"q":"Wem ist der Taxilenkerausweis auf Verlangen zur √úberpr√ºfung auszuh√§ndigen?","a":"Organen des √∂ffentlichen Sicherheitsdienstes"},
    {"q":"Wie verhalten Sie sich, wenn Sie den Taxilenkerausweis verloren haben?","a":"Unverz√ºglich Verlustanzeige machen"},
    {"q":"Wer hat den Taxilenkerausweis auszustellen?","a":"Die zust√§ndige Beh√∂rde"},
    {"q":"Unter welchen Voraussetzungen ist es dem Lenker untersagt, ein Fahrzeug zu lenken?","a":"Bei Alkoholisierung, M√ºdigkeit oder Einnahme von Medikamenten"},
    {"q":"Wie hat sich der Taxilenker im Fahrdienst zu verhalten?","a":"Besonnen, r√ºcksichtsvoll, h√∂flich und hilfsbereit"},
    {"q":"Was haben Sie als Taxilenker nach Dienstende zu tun?","a":"Pr√ºfen ob Gegenst√§nde im Fahrzeug zur√ºckgeblieben sind"},
    {"q":"Was ist Fahrg√§sten bei Taxifahrten untersagt?","a":"Den Lenker behindern, T√ºren eigenm√§chtig √∂ffnen, rauchen"},
    {"q":"Was verstehen Sie unter Bef√∂rderungspflicht?","a":"Die Pflicht, grunds√§tzlich jeden Fahrgast innerhalb Wiens zu bef√∂rdern"},
    {"q":"Welche Personen k√∂nnen Sie von der Bef√∂rderung ausschlie√üen?","a":"Personen die Sicherheit gef√§hrden, Betrunkene, Personen mit ansteckenden Krankheiten"}
  ],

  "tarif": [
    {"q":"Wie hoch ist die Grundtaxe am Tag?","a":"3,80 ‚Ç¨"},
    {"q":"Wie hoch ist die Grundtaxe in der Nacht / an Sonn- und Feiertagen?","a":"4,30 ‚Ç¨"},
    {"q":"Wie hoch ist die Zeittaxe f√ºr eine Stunde Wartezeit?","a":"34,80 ‚Ç¨"},
    {"q":"Der Nachtzuschlag gilt von ‚Ä¶ bis ‚Ä¶ Uhr.","a":"23:00‚Äì06:00"},
    {"q":"Wie hoch ist die Streckentaxe f√ºr die ersten 5 Kilometer am Tag?","a":"0,95 Cent pro 210,53 Meter"},
    {"q":"Wie hoch ist ein Zuschlag f√ºr bestellte Fahrten?","a":"2 Euro"},
    {"q":"Wer verordnet den Wiener Taxitarif?","a":"Der Landeshauptmann (B√ºrgermeister)"},
    {"q":"Wo verliert der Wiener Taxitarif seine G√ºltigkeit?","a":"Ab der Ortsgrenze"},
    {"q":"Wie werden Botenfahrten verrechnet?","a":"Freie Vereinbarung oder laut Taxameter"},
    {"q":"Welchen Steuersatz enth√§lt eine Botenfahrt?","a":"20% MwSt"}
  ],

  "strassenverkehr": [
    {"q":"D√ºrfen Taxis durch Wohnstra√üen durchfahren?","a":"Nein, nur zu- und abfahren in Schrittgeschwindigkeit"},
    {"q":"Was ist ein Einsatzfahrzeug?","a":"Fahrzeug mit Blaulicht und Folgetonhorn"},
    {"q":"Wie verhalten Sie sich gegen√ºber einem Einsatzfahrzeug?","a":"Platz machen f√ºr Durchfahrt"},
    {"q":"Was verstehen Sie unter Halten?","a":"Abstellen eines Fahrzeuges f√ºr maximal 10 Minuten"},
    {"q":"Was verstehen Sie unter Parken?","a":"Halten eines Fahrzeuges l√§nger als 10 Minuten"},
    {"q":"Wann gilt der Lenker eines PKW als alkoholbeeintr√§chtigt?","a":"Bei 0,5 Promille Blutalkohol (f√ºr Taxifahrer 0,1 Promille)"},
    {"q":"D√ºrfen Sie auf einer Vorrangstra√üe im Ortsgebiet links zufahren?","a":"Nein, au√üer in Einbahnstra√üen"},
    {"q":"Was verstehen Sie unter dem Rei√üverschlusssystem?","a":"Wechselseitiges Einordnen lassen von Fahrzeugen an Engstellen"},
    {"q":"D√ºrfen Sie auf einem ungeregelten Schutzweg √ºberholen?","a":"Nein"},
    {"q":"Wie verhalten Sie sich vor einem Schutzweg?","a":"Geschwindigkeit so w√§hlen, dass rechtzeitig angehalten werden kann"}
  ],

  "guertel": [
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Mariahilfer Stra√üe √ºber den G√úRTEL √ºberquert haben?","options":["Sechshauser Stra√üe","Burggasse","Thaliastra√üe","Winckelmannstra√üe"],"correct":"Sechshauser Stra√üe"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Burggasse √ºber den G√úRTEL √ºberquert haben?","options":["Gablenzgasse","Thaliastra√üe","Mariahilfer Stra√üe","Winckelmannstra√üe"],"correct":"Gablenzgasse"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Neustiftgasse √ºber den G√úRTEL √ºberquert haben?","options":["Koppstra√üe","Thaliastra√üe","Burggasse","Winckelmannstra√üe"],"correct":"Koppstra√üe"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Josefst√§dter Stra√üe √ºber den G√úRTEL √ºberquert haben?","options":["Neulerchenfelder Stra√üe","Thaliastra√üe","Burggasse","Lerchenfelder Stra√üe"],"correct":"Neulerchenfelder Stra√üe"}
  ],

  "donaukanal": [
    {"name":"Donaukanal Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Aspernbr√ºckengasse √ºber den DONAUKANAL √ºberquert haben?","options":["Franzensbr√ºckenstra√üe","Taborstra√üe","Lassallestra√üe","Rotenturmstra√üe"],"correct":"Franzensbr√ºckenstra√üe"},
    {"name":"Donaukanal Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Taborstra√üe √ºber den DONAUKANAL √ºberquert haben?","options":["Rembrandtstra√üe","Franzensbr√ºckenstra√üe","Lassallestra√üe","Rotenturmstra√üe"],"correct":"Rembrandtstra√üe"},
    {"name":"Donaukanal Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Rotenturmstra√üe √ºber den DONAUKANAL √ºberquert haben?","options":["Laurenzerberg","Franzensbr√ºckenstra√üe","Lassallestra√üe","Taborstra√üe"],"correct":"Laurenzerberg"}
  ],

  "arbeitsrecht": [
    {"q":"Wie entsteht ein Arbeitsverh√§ltnis?","a":"Durch einen Arbeitsvertrag zwischen Arbeitgeber und Arbeitnehmer"},
    {"q":"Welche Pflichten haben Arbeitnehmer?","a":"Arbeitspflicht, Sorgfaltspflicht, Treuepflicht, Weisungspflicht"},
    {"q":"Welche Pflichten haben Arbeitgeber?","a":"Anmeldepflicht, F√ºrsorgepflicht, Entgeltzahlungspflicht"},
    {"q":"Was ist die Sozialversicherung?","a":"Pflichtversicherung f√ºr Kranken-, Unfall-, Pensions- und Arbeitslosenversicherung"},
    {"q":"Wie hoch ist der kollektivvertragliche Mindestlohn im Taxigewerbe 2024?","a":"1.880 ‚Ç¨ brutto"},
    {"q":"Wie lange darf die Arbeitszeit pro Tag h√∂chstens sein?","a":"12 Stunden"},
    {"q":"Wie lange muss die t√§gliche Ruhezeit sein?","a":"Mindestens 11 Stunden"},
    {"q":"Wie lange sind die K√ºndigungsfristen in den ersten zwei Arbeitsjahren?","a":"6 Wochen"},
    {"q":"Was gilt im Taxigewerbe als Nachtarbeit?","a":"Die Zeit zwischen 00:00 Uhr und 04:00 Uhr"},
    {"q":"Wie hoch ist der Zuschlag bei der √úberstundenentlohnung?","a":"50% Zuschlag"}
  ]
}
</script>

<script>
/* ================= helpers ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toast = (m,ms=1900)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); };
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]] } return x; }

/* ================= map ================= */
let map=null;
try{
  if(window.L){
    map = L.map('map',{zoomControl:true}).setView([48.2082,16.3738],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'¬© OpenStreetMap' }).addTo(map);
  }
} catch(e){}
let currentMarker = null;
let currentPopup = null;

function icon(status='blue', pulse=false){
  const sym = status==='green'?'‚úì':status==='red'?'‚úó':'‚Ä¢';
  const cls = `mk ${status==='green'?'green':status==='red'?'red':'blue'} ${pulse?'pulse':''}`;
  return (window.L && L.divIcon) ? L.divIcon({className:'', html:`<div class="${cls}">${sym}</div>`, iconSize:[26,26], iconAnchor:[13,13]}) : null;
}

function fly([lat,lng], zoom=16){ 
    if(!map) return; 
    map.flyTo([lat,lng], zoom, {duration:1.0}); 
}

function clearMap() {
    if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
    }
    if (currentPopup) {
        map.removeLayer(currentPopup);
        currentPopup = null;
    }
}

function showLocationOnMap(coords, name, address, status = 'blue') {
    clearMap();
    
    if (!coords) return;
    
    currentMarker = L.marker(coords, {icon: icon(status, true)}).addTo(map);
    
    const popupContent = `<div class="answer-popup"><b>${name}</b><br>${address}</div>`;
    currentMarker.bindPopup(popupContent).openPopup();
    
    fly(coords, 16);
}

function updateMarkerStatus(status, correctAnswer = null) {
    if (currentMarker) {
        currentMarker.setIcon(icon(status, false));
        if (correctAnswer) {
            const newContent = currentMarker.getPopup().getContent() + `<br><div style="color: ${status === 'green' ? '#16a34a' : '#dc2626'}; margin-top: 5px;"><b>${correctAnswer}</b></div>`;
            currentMarker.setPopupContent(newContent);
        }
    }
}

/* ================= –ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã ================= */
let speechRecognition = null;
let isListening = false;

function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        speechRecognition = new SpeechRecognition();
        speechRecognition.continuous = false;
        speechRecognition.interimResults = false;
        speechRecognition.lang = 'de-DE';
        
        speechRecognition.onstart = () => {
            isListening = true;
            $("#voiceBtn").innerHTML = "üé§ H√∂re zu...";
            $("#voiceBtn").classList.add("voice-listening");
            toast("Sprechen Sie jetzt...");
        };
        
        speechRecognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            console.log("Erkannt:", transcript);
            processVoiceAnswer(transcript);
        };
        
        speechRecognition.onerror = (event) => {
            console.warn("Spracherkennungsfehler", event.error);
            if (event.error === 'not-allowed') {
                toast("Erlauben Sie Mikrofonzugriff in den Browsereinstellungen");
            }
            stopVoiceRecognition();
        };
        
        speechRecognition.onend = () => {
            stopVoiceRecognition();
        };
    } else {
        console.warn("Spracherkennung nicht unterst√ºtzt");
        $("#voiceBtn").style.display = "none";
        $("#voiceQuizBtn").style.display = "none";
    }
}

function startVoiceRecognition() {
    if (!speechRecognition) {
        toast("Spracherkennung wird in Ihrem Browser nicht unterst√ºtzt");
        return;
    }
    
    if (isListening) {
        stopVoiceRecognition();
        return;
    }
    
    try {
        speechRecognition.start();
        toast("H√∂re zu... Sagen Sie die Antwortnummer (1,2,3,4)");
    } catch (error) {
        console.warn("Spracherkennungsstartfehler:", error);
        toast("Fehler beim Mikrofonzugriff");
    }
}

function stopVoiceRecognition() {
    if (speechRecognition && isListening) {
        speechRecognition.stop();
    }
    isListening = false;
    $("#voiceBtn").innerHTML = "üé§ Sprachantwort";
    $("#voiceBtn").classList.remove("voice-listening");
}

function processVoiceAnswer(transcript) {
    const cleanAnswer = transcript.trim().toLowerCase();
    console.log("Verarbeite Antwort:", cleanAnswer);
    
    const options = $$("#optionsContainer .option");
    
    // Suche nach Nummer (1,2,3,4)
    const numberMatch = cleanAnswer.match(/(\d)/);
    if (numberMatch && options[numberMatch[1] - 1]) {
        const selectedOption = options[numberMatch[1] - 1];
        const optionText = selectedOption.textContent.replace(/^\d+\.\s*/, "");
        selectedOption.click();
        speak(`Gew√§hlt: ${numberMatch[1]} - ${optionText}`, 0.7);
        return;
    }
    
    // Suche nach Antworttext
    for (let i = 0; i < options.length; i++) {
        const optionText = options[i].textContent.toLowerCase().replace(/^\d+\.\s*/, "");
        if (cleanAnswer.includes(optionText) || optionText.includes(cleanAnswer)) {
            options[i].click();
            speak(`Sie sagten: ${optionText}`, 0.7);
            return;
        }
    }
    
    // Wenn keine √úbereinstimmung gefunden
    speak("Antwort nicht verstanden. Bitte sagen Sie die Antwortnummer: 1, 2, 3 oder 4.", 0.7);
    toast(`Nicht erkannt: "${transcript}". Sagen Sie die Antwortnummer.`);
}

/* ================= TTS mit m√§nnlicher Stimme ================= */
let ttsOn=true;
const DEFAULT_RATE = 1.0;  // Normale Geschwindigkeit
const SLOW_RATE = 0.7;     // Langsamer

function speak(text, rate=DEFAULT_RATE){
  if(!ttsOn || !text) return;
  if(!('speechSynthesis' in window)) return;
  
  window.speechSynthesis.cancel();
  
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "de-DE";
  u.rate = rate;
  
  // Versuche m√§nnliche Stimme zu finden
  const voices = window.speechSynthesis.getVoices();
  const maleVoice = voices.find(voice => 
    voice.lang === 'de-DE' && 
    (voice.name.includes('Google Deutsch') || 
     voice.name.includes('Microsoft David') ||
     voice.name.toLowerCase().includes('male'))
  );
  
  if (maleVoice) {
    u.voice = maleVoice;
  }
  
  window.speechSynthesis.speak(u);
}

/* ================= Daten ================= */
const PACK = JSON.parse(document.getElementById('data-pack').textContent);

const THEMEN = [
  {key:"regierungs", title:"I. Ortskunde - Regierungsgeb√§ude", pages:"S.6", official:16},
  {key:"gerichte", title:"I. Ortskunde - Gerichtsgeb√§ude", pages:"S.6-7", official:8},
  {key:"polizei", title:"I. Ortskunde - Polizeidienststellen", pages:"S.7", official:2},
  {key:"stadtpolizei", title:"I. Ortskunde - Stadtpolizeikommanden", pages:"S.7-10", official:3},
  {key:"hotels", title:"I. Ortskunde - Hotels", pages:"S.10-13", official:4},
  {key:"cafes", title:"I. Ortskunde - Kaffeeh√§user", pages:"S.14", official:4},
  {key:"krankenhaus", title:"I. Ortskunde - Krankenanstalten", pages:"S.17-19", official:3},
  {key:"kultur", title:"I. Ortskunde - Kultureinrichtungen", pages:"S.19", official:4},
  {key:"museen", title:"I. Ortskunde - Museen", pages:"S.20-22", official:4},
  {key:"universit√§ten", title:"I. Ortskunde - Universit√§ten", pages:"S.20", official:3},
  {key:"guertel", title:"I. Ortskunde - G√ºrtel Kreuzungen", pages:"S.23", official:4},
  {key:"donaukanal", title:"I. Ortskunde - Donaukanal Kreuzungen", pages:"S.24", official:3},
  {key:"betriebsordnung", title:"II. Betriebsordnung", pages:"S.39-56", official:10},
  {key:"tarif", title:"III. Wiener Tarif", pages:"S.58-61", official:10},
  {key:"strassenverkehr", title:"IV. Stra√üenverkehrsordnung", pages:"S.62-75", official:10},
  {key:"arbeitsrecht", title:"VI. Arbeits- und Sozialrecht", pages:"S.78-89", official:10}
];

function buildQuestionsFromPack(){
  const data={};
  for(const [key,items] of Object.entries(PACK)){
    if(!Array.isArray(items)) continue;
    
    data[key]=items.map(it=>{
      const q = it.question || `Wo befindet sich ${it.name}?`;
      const right = it.a || it.address;
      
      // F√ºr Fragen ohne vordefinierte Distraktoren, erstelle welche
      let distractors = it.distractors;
      if (!distractors && it.a) {
        // F√ºr Textfragen: nimm andere Antworten aus derselben Kategorie
        distractors = shuffle(items.filter(o => o.a && o.a !== right).map(o => o.a)).slice(0, 3);
      } else if (!distractors) {
        // F√ºr Ortsfragen: nimm andere Adressen
        distractors = shuffle(items.filter(o => o.address && o.address !== right).map(o => o.address)).slice(0, 3);
      }
      
      const options = shuffle([right, ...distractors]).slice(0, 4);
      
      return {
        name: it.name || it.q, 
        address: it.address, 
        coords: it.coords || null, 
        question: q, 
        options: options, 
        correct: right
      };
    });
  }
  return data;
}
const DATA = buildQuestionsFromPack();

/* ================= Quiz engine ================= */
let selected=[], pool=[], idx=0, score=0, examMode=false, officialMode=false;
let lastQuestionText="";
let currentQuestion = null;

function availableCount(key){ return (DATA[key]||[]).length; }
function buildPool(keys){ const out=[]; keys.forEach(k=>{ if(DATA[k]) out.push(...DATA[k]); }); return shuffle(out); }

function openQuiz(){
  $("#quizPanel").style.display="block"; $("#sidebar").style.display="none";
}

async function showQuestion(first=false){
  const q=pool[idx]; 
  if(!q) return;
  
  currentQuestion = q;

  $("#progress").textContent=`Frage ${idx+1} von ${pool.length}`;
  $("#progressFill").style.width=`${Math.round((idx)/pool.length*100)}%`;
  $("#questionText").textContent=q.question;

  const cont=$("#optionsContainer"); cont.innerHTML="";
  const options = q.options || [q.correct];
  shuffle(options).forEach((opt,i)=>{
    const d=document.createElement("div");
    d.className="option"; d.tabIndex=0; d.dataset.correct=(opt===(q.correct));
    d.innerHTML=`<strong>${i+1}.</strong> ${opt}`;
    d.onclick=()=>checkAnswer(d,opt);
    d.onkeydown=(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); d.click(); } };
    cont.appendChild(d);
  });
  $("#nextBtn").style.display="none"; $("#endBtns").style.display="none";

  // ZEIGE MARKIERUNG BEI FRAGE
  if (q.coords) {
    showLocationOnMap(q.coords, q.name || q.q, q.address || q.correct, 'blue');
  } else {
    clearMap();
  }

  lastQuestionText = q.question;
  speak(lastQuestionText, DEFAULT_RATE);
}

async function checkAnswer(el,opt){
  const q=currentQuestion; 
  const right=(opt===(q.correct));
  
  $$("#optionsContainer .option").forEach(o=>o.onclick=null);
  el.classList.add(right?"correct":"incorrect");
  
  if(!right){ 
    const r=$$("#optionsContainer .option").find(x=>x.dataset.correct==="true"); 
    if(r) r.classList.add("correct"); 
  }
  
  if(right) score++;

  // AKTUALISIERE MARKIERUNG MIT RICHTIGER ANTWORT
  if (q.coords) {
    updateMarkerStatus(right ? 'green' : 'red', q.address || q.correct);
  }

  $("#nextBtn").style.display="block";

  if(right){
    speak(`Richtig. ${q.correct}.`, DEFAULT_RATE);
  }else{
    speak(`Leider falsch. Richtig ist: ${q.correct}.`, DEFAULT_RATE);
  }
}

function nextQuestion(){
  idx++;
  if(idx<pool.length){ 
    showQuestion(); 
  } else {
    $("#questionText").textContent=`Fertig! Punkte: ${score}/${pool.length}`;
    $("#optionsContainer").innerHTML=""; $("#progress").textContent=""; $("#progressFill").style.width="100%";
    $("#nextBtn").style.display="none"; $("#endBtns").style.display="block"; 
    clearMap();
    speak(`Pr√ºfung beendet. Sie haben ${score} von ${pool.length} Fragen richtig beantwortet.`, DEFAULT_RATE);
  }
}

function backToMenu(){ 
  $("#quizPanel").style.display="none"; 
  $("#sidebar").style.display="block"; 
  $("#endBtns").style.display="none"; 
  clearMap(); 
}

function restartQuiz(){ 
  $("#endBtns").style.display="none"; 
  idx=0; score=0; 
  pool=shuffle(pool); 
  showQuestion(true); 
}

async function startQuiz(mode="normal"){
  const checked=$$("#catList input[type=checkbox]:checked").map(x=>x.value);
  if(checked.length===0){ toast("Bitte w√§hlen Sie mindestens eine Kategorie!"); return; }
  selected=checked; examMode=(mode==="exam"); officialMode=false;
  pool=buildPool(selected);
  if(examMode && pool.length>10) pool=pool.slice(0,10);
  idx=0; score=0; openQuiz();
  await showQuestion(true);
}

function startVoiceQuiz() {
    startQuiz("normal");
}

/* ================= UI Events ================= */
function loadCats(){
  const wrap=$("#catList"); wrap.innerHTML="";
  THEMEN.forEach(t=>{
    const have=availableCount(t.key); const need=t.official||have;
    const div=document.createElement("label"); div.className="cat";
    div.innerHTML=`<input type="checkbox" value="${t.key}" ${["regierungs","gerichte","tarif"].includes(t.key) ? "checked" : ""}> <div>${t.title} <span class="small">(${t.pages})</span></div> <span class="meta">${have}/${need}</span>`;
    wrap.appendChild(div);
  });
}

// Initialisierung
window.addEventListener("load", ()=>{
    loadCats();
    initSpeechRecognition();
    toast("Wiener Taxi Pr√ºfungsassistent geladen");
    
    // Stimmen laden f√ºr TTS
    if ('speechSynthesis' in window) {
        window.speechSynthesis.getVoices();
    }
});

// Event-Handler
$("#menuBtn").onclick = ()=>{ $("#sidebar").style.display = $("#sidebar").style.display==="none"?"block":"none"; };
$("#startBtn").onclick = ()=>{ startQuiz("normal"); };
$("#examBtn").onclick  = ()=>{ startQuiz("exam"); };
$("#officialBtn").onclick = ()=>{ startQuiz("official"); };
$("#voiceQuizBtn").onclick = ()=>{ startVoiceQuiz(); };
$("#nextBtn").onclick  = nextQuestion;
$("#againBtn").onclick = restartQuiz;
$("#backBtn").onclick  = backToMenu;
$("#voiceBtn").onclick = startVoiceRecognition;
$("#replayBtn").onclick = ()=>{ speak(lastQuestionText, DEFAULT_RATE); };
$("#replaySlowBtn").onclick = ()=>{ speak(lastQuestionText, SLOW_RATE); };
$("#ttsToggleBtn").onclick = ()=>{ ttsOn=!ttsOn; toast(ttsOn?"üîä Sprachausgabe eingeschaltet":"üîá Sprachausgabe ausgeschaltet"); };

// Tastaturk√ºrzel
document.addEventListener("keydown",(e)=>{
  if($("#quizPanel").style.display!=="block") return;
  const i=["1","2","3","4","5","6"].indexOf(e.key);
  if(i>=0){ const opt=$$("#optionsContainer .option")[i]; if(opt && opt.onclick) opt.click(); }
  if(e.key==="Enter" && getComputedStyle($("#nextBtn")).display!=="none") nextQuestion();
});

// Vereinfachte Anwendung - kein Login ben√∂tigt
$("#sidebar").style.display = "block";
</script>
</body>
</html>
