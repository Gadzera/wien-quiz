<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wiener Ortskunde ‚Äì Interaktive Karte & Quiz</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --brand:#2563eb; --brand-2:#60a5fa;
  --ok:#16a34a; --err:#dc2626;
  --bg:#ffffff; --panel:#ffffff; --text:#0f172a; --muted:#6b7280;
  --chip:#f8fafc; --border:#e5e7eb;
  --shadow:0 10px 30px rgba(2,6,23,.15);
  --radius:14px;
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b1020; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --chip:#0b1225; --border:#1f2937; --shadow:0 10px 40px rgba(0,0,0,.45);
  }
}
*{ box-sizing:border-box }
html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,sans-serif; }
#map{ position:fixed; inset:0; z-index:1; }

.topbar{
  position:fixed; top:12px; left:12px; right:12px; z-index:1001;
  display:flex; gap:8px; align-items:center; justify-content:space-between;
  pointer-events:none;
}
.btn{ pointer-events:auto; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
      color:white; background:linear-gradient(180deg,var(--brand),#1e40af); box-shadow:var(--shadow); }
.btn.secondary{ background:#334155; }
.iconbtn{ pointer-events:auto; border:none; border-radius:10px; padding:10px 12px; background:#111827; color:#fff; opacity:.9; cursor:pointer; }
.iconbtn:hover{ opacity:1; }
.spacer{ flex:1 }

.sidebar{
  position:fixed; top:64px; left:12px; z-index:1000; width:360px; max-height:78vh; overflow:auto;
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); display:none;
}
.sidebar h3{ margin:0 0 8px 0; }
.cat{ display:flex; align-items:center; gap:8px; padding:8px; margin:8px 0; background:var(--chip); border-left:4px solid var(--brand); border-radius:10px; }
.cat .count{ margin-left:auto; color:var(--muted); font-size:12px; }

.quiz-panel{
  position:fixed; top:64px; right:12px; z-index:1000; width:380px; max-height:78vh; overflow:auto;
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none;
}
.question{ font-weight:700; margin:8px 0 10px; text-align:center; }
.progress{ text-align:center; font-size:13px; color:var(--muted); }
.progressbar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px 0 12px; }
.progressbar-fill{ height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }

.options{ display:grid; gap:8px; }
.option{ padding:12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:transparent; }
.option:hover{ border-color:var(--brand); background:rgba(37,99,235,.07); }
.option.correct{ border-color:var(--ok); background:#f0fdf4; }
.option.incorrect{ border-color:var(--err); background:#fef2f2; }

.next-btn,.end-btn{ margin-top:10px; width:100%; font-weight:800; border:none; border-radius:10px; padding:10px 14px; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); cursor:pointer; }
.end-btn.secondary{ background:#334155; }

.panel{
  position:fixed; top:64px; right:410px; z-index:1000; width:460px; max-height:78vh; overflow:auto;
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none;
}
.panel h3{ margin:0 0 10px 0 }
.row{ display:flex; gap:10px; flex-wrap:wrap; }
.kbd{ font-family:ui-monospace,monospace; background:#111827; color:#fff; padding:2px 6px; border-radius:6px; }

.leaderboard .item{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px dashed var(--border); }
.leaderboard .you{ background:rgba(37,99,235,.08); border-radius:8px; }

#loginModal{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:2000;
}
#loginBox{ width:90%; max-width:380px; background:var(--panel); color:var(--text); border-radius:14px; padding:20px; box-shadow:var(--shadow); border:1px solid var(--border); }
#loginBox h2{ margin:0 0 12px 0; }
#loginBox input{ width:100%; padding:12px; margin:8px 0; border:1px solid var(--border); border-radius:10px; background:var(--chip); color:var(--text); }
.login-btn{ width:100%; padding:12px; border:none; border-radius:10px; font-weight:800; background:linear-gradient(180deg,#ffcc66,#ff9933); cursor:pointer; }

.toast{
  position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(20px);
  background:rgba(17,24,39,.95); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:var(--shadow);
  opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:3000; font-size:13px;
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

/* G√ºrtel highlight */
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }
.badge-inner{ background:#0ea5e9; color:#fff; }
.badge-outer{ background:#f59e0b; color:#111; }
.small{ font-size:12px; color:var(--muted); }
hr{ border:none; border-top:1px solid var(--border); margin:10px 0; }
</style>
</head>
<body>

<div id="map"></div>

<!-- Topbar -->
<div class="topbar">
  <button class="btn" id="menuBtn">‚ò∞ Themen</button>
  <div class="spacer"></div>
  <button class="iconbtn" id="studyBtn" title="–£—á–µ–±–Ω—ã–π —Ä–µ–∂–∏–º G√ºrtel">üß≠ G√ºrtel</button>
  <button class="iconbtn" id="leaderBtn" title="–õ–∏–¥–µ—Ä–±–æ—Ä–¥">üèÜ</button>
  <button class="iconbtn" id="statsBtn" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">üìä</button>
  <button class="iconbtn" id="ttsToggleBtn" title="–û–∑–≤—É—á–∫–∞ –≤–∫–ª/–≤—ã–∫–ª">üîä</button>
  <button class="iconbtn" id="logoutBtn" title="–í—ã–π—Ç–∏">‚éã</button>
</div>

<!-- Sidebar: Kategorien -->
<div class="sidebar" id="sidebar">
  <h3>üóÇÔ∏è Themen (I. ORTSKUNDE ‚Äì 23 Kapitel aus dem PDF)</h3>
  <div id="catList"></div>
  <button id="startBtn" class="btn" style="margin-top:10px;width:100%;">‚ñ∂Ô∏è Quiz starten</button>
  <button id="examBtn" class="btn secondary" style="margin-top:8px;width:100%;">üìù Pr√ºfungsmodus (10 Fragen)</button>
  <p class="small" style="margin-top:8px">Hotkeys: <span class="kbd">1..6</span> f√ºr Antworten, <span class="kbd">Enter</span> = Weiter.</p>
</div>

<!-- Quiz Panel -->
<div class="quiz-panel" id="quizPanel" aria-live="polite">
  <div class="progress" id="progress"></div>
  <div class="progressbar"><div class="progressbar-fill" id="progressFill"></div></div>
  <div class="question" id="questionText"></div>
  <div class="options" id="optionsContainer"></div>
  <button class="next-btn" id="nextBtn" style="display:none;">Weiter ‚Üí</button>
  <div id="endBtns" style="display:none;">
    <button class="end-btn" id="againBtn">üîÑ Nochmal spielen</button>
    <button class="end-btn secondary" id="backBtn">üìñ Zur√ºck</button>
  </div>
</div>

<!-- Panel: G√ºrtel Study -->
<div class="panel" id="studyPanel">
  <h3>üß≠ –£—á–µ–±–Ω—ã–π —Ä–µ–∂–∏–º: G√ºrtel</h3>
  <p class="small">–ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ ‚Äî –∫–∞—Ä—Ç–∞ –ø–æ–∫–∞–∂–µ—Ç **–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫** (–æ—Å–∏ + —Å–µ–∫—Ç–æ—Ä <span class="badge badge-inner">innerer</span>/<span class="badge badge-outer">√§u√üerer</span>). –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö ¬´G√úRTEL¬ª –∏ ¬´nach dem G√úRTEL √ºberquert¬ª –≤–∞—à–µ–≥–æ –∫—É—Ä—Å–∞. :contentReference[oaicite:3]{index=3}</p>
  <div id="studyList"></div>
</div>

<!-- Panel: Leaderboard -->
<div class="panel leaderboard" id="leaderPanel">
  <h3>üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</h3>
  <div id="leaderList"></div>
</div>

<!-- Panel: Stats -->
<div class="panel" id="statsPanel">
  <h3>üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
  <div id="myStats"></div>
</div>

<!-- Login -->
<div id="loginModal">
  <div id="loginBox">
    <h2 id="formTitle">Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPass" placeholder="Password">
    <input type="password" id="loginPass2" placeholder="Repeat Password" style="display:none;">
    <button class="login-btn" id="submitBtn">Log in</button>
    <p id="loginError" style="color:#ef4444; font-size:12px;"></p>
    <div class="small">
      <a href="#" id="toRegister">Register</a> | <a href="#" id="toLogin">Login</a>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase + App -->
<script type="module">
// ============ Firebase ============
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCqVNVOXqYlPryEvjIYkOyp3BrWMtRMlGg",
  authDomain: "wien-quiz.firebaseapp.com",
  databaseURL: "https://wien-quiz-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "wien-quiz",
  storageBucket: "wien-quiz.firebasestorage.app",
  messagingSenderId: "467695563938",
  appId: "1:467695563938:web:87b15a9b5de5d3764bd3fb",
  measurementId: "G-SN0SMY9NH2"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// ============ Helpers ============
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toast = (m,ms=1500)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); };
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]] } return x; }

// ============ Map ============
const map = L.map('map',{zoomControl:true}).setView([48.2082,16.3738],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);
let answerMarker=null, gLayer=null;
function fly([lat,lng], zoom=16){ map.flyTo([lat,lng], zoom, {duration:1.0}); }

// Geo helpers (–¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–∫–æ–≤)
function project([lat,lng], bearingDeg, dist){
  const R=6378137, d=dist/R, br=bearingDeg*Math.PI/180, lat1=lat*Math.PI/180, lon1=lng*Math.PI/180;
  const lat2=Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(br));
  const lon2=lon1+Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(lat1), Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
  return [lat2*180/Math.PI, lon2*180/Math.PI];
}
function semiCircle(latlng, bearing, radius, side="innerer"){
  let start=bearing-90, end=bearing+90;
  if(side==="√§u√üerer"){ start=bearing+90; end=bearing+270; }
  const pts=[];
  for(let a=start; a<=end; a+=5){ pts.push(project(latlng,a,radius)); }
  pts.push(latlng);
  return pts;
}
function drawIntersection({coords, bearing, side, nameA, nameB}){
  if(gLayer){ map.removeLayer(gLayer); gLayer=null; }
  const len=180, r=120;
  const a1=project(coords,bearing,len/2), a2=project(coords,bearing+180,len/2);
  const b1=project(coords,bearing+90,len/2), b2=project(coords,bearing+270,len/2);
  const segA=L.polyline([a1,a2],{color:"#0ea5e9",weight:5}).addTo(map);
  const segB=L.polyline([b1,b2],{color:"#22c55e",weight:5, dashArray:"6,6"}).addTo(map);
  const wedge=L.polygon(semiCircle(coords,bearing,r,side), {color: side==="innerer"?"#0ea5e9":"#f59e0b", weight:2, fillColor: side==="innerer"?"#38bdf8":"#fbbf24", fillOpacity:.18}).addTo(map);
  const mk=L.marker(coords).addTo(map).bindPopup(`<b>${nameA}</b> √ó <b>${nameB}</b><br><span class="badge ${side==='innerer'?'badge-inner':'badge-outer'}">${side} G√ºrtel</span>`).openPopup();
  gLayer=L.layerGroup([segA,segB,wedge,mk]).addTo(map);
  fly(coords,16);
}

// ============ DATA ============
// –ö–ª—é—á ElevenLabs –∏ –≥–æ–ª–æ—Å ‚Äî –∑–∞—à–∏—Ç—ã (–∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏)
const ELEVEN_API_KEY = "f3e700c3faf18f37d5b07200c0f83b5d22059752311d8c655afc5e0e8ba1188d";
const ELEVEN_VOICE_ID = "ROYWaqtov1Lot9vQBM3y";

// 23 —Ç–µ–º—ã I. ORTSKUNDE (—Å—Ç—Ä. 5 ‚Äì –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ) + –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü. :contentReference[oaicite:4]{index=4}
const THEMEN = [
 {key:"regierungs", title:"1) Regierungsgeb√§ude", pages:"S.6"},
 {key:"gerichte",   title:"2) Gerichtsgeb√§ude", pages:"S.6‚Äì7"},
 {key:"bundespolizei", title:"3) Bundespolizeidirektion Wien", pages:"S.7"},
 {key:"stadtpolizei",  title:"4) Stadtpolizeikommanden / Polizeiinspektionen", pages:"S.7‚Äì10"},
 {key:"post", title:"5) Post", pages:"S.6"},
 {key:"medien", title:"6) Massenmedien", pages:"S.36 (APA) etc."},
 {key:"kammern", title:"7) Kammern", pages:"(WKO etc.)"},
 {key:"bezirksaemter", title:"8) Magistratische Bezirks√§mter (Amtsh√§user)", pages:"S.8‚Äì9"},
 {key:"hotels", title:"9) Beherbergungsbetriebe / Hotels (Auswahl)", pages:"S.10‚Äì13"},
 {key:"cafes", title:"10) Kaffeeh√§user", pages:"S.14"},
 {key:"heurige", title:"11) Bezirksnamen & Heurigenorte", pages:"S.15‚Äì16"},
 {key:"friedhoefe", title:"12) Friedh√∂fe", pages:"S.16‚Äì18"},
 {key:"kranken", title:"13) Krankenanstalten", pages:"S.17‚Äì19"},
 {key:"pension", title:"14) Pensionistenwohnheime", pages:"S.19"},
 {key:"kultur",  title:"15) Kulturinstitute / B√ºhnenh√§user", pages:"S.19"},
 {key:"kabarett",title:"15a) Kabaretts, Volksb√ºhnen", pages:"S.19"},
 {key:"unis",   title:"16) Universit√§ten / Bildungsanstalten", pages:"S.20"},
 {key:"museen", title:"17) Museen", pages:"S.20‚Äì22"},
 {key:"bauten", title:"18) Bauten, Sehensw√ºrdigkeiten, Hotels & Caf√©s", pages:"S.21‚Äì22"},
 {key:"guertel",title:"19) Nach dem G√úRTEL √ºberquert + G√ºrtelseiten", pages:"S.23 & S.27"},
 {key:"donau",  title:"20) Nach Br√ºcken √ºber DONAUKANAL/DONAU", pages:"S.24"},
 {key:"nummern",title:"21) Nummerierungssystem", pages:"S.24"},
 {key:"strassgeo", title:"22) Stra√üengeographie (Allgemein)", pages:"S.25"},
 {key:"wichtige", title:"23) Wichtige Stra√üen und Autobahnen", pages:"S.26"},
 // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
 {key:"tarif", title:"Wiener Tarif (zus√§tzlich)", pages:"S.58‚Äì61"},
 {key:"stvo",  title:"StVO (Auszug f√ºr Taxi)", pages:"S.62‚Äì75"},
 {key:"kfg",   title:"KFG (Kraftfahrgesetz) ‚Äì Pflichtfragen", pages:"S.76‚Äì80"},
 {key:"arbeit",title:"Arbeits- und Sozialrecht", pages:"S.84‚Äì95"}
];

// –í–æ–ø—Ä–æ—Å—ã (–æ–±—Ä–∞–∑—Ü—ã –∏ –æ—Å–Ω–æ–≤–∞). –ò—Å—Ç–æ—á–Ω–∏–∫–∏: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã PDF. :contentReference[oaicite:5]{index=5}
const DATA = {
  regierungs: [
    { name:"Parlament", question:"Wo befindet sich das Parlament?", options:["Dr.-Karl-Renner-Ring 3","Ballhausplatz 2","Minoritenplatz 5","Stubenring 1"], correct:"Dr.-Karl-Renner-Ring 3", coords:[48.208200420886755, 16.35916158251087] },
    { name:"Pr√§sidentschaftskanzlei", question:"Wo befindet sich die Pr√§sidentschaftskanzlei?", options:["Ballhausplatz 1","Herrengasse 7","Johannesgasse 5","Stubenring 1"], correct:"Ballhausplatz 1", coords:[48.20800169709753, 16.363951691458396] },
    { name:"Bundeskanzleramt", question:"Wo befindet sich das Bundeskanzleramt?", options:["Ballhausplatz 2","Minoritenplatz 8","Museumstra√üe 7","Radetzkystra√üe 2"], correct:"Ballhausplatz 2", coords:[48.20854761977208, 16.363727653675692] },
    { name:"BM Inneres", question:"Wo befindet sich das BM f√ºr Inneres?", options:["Herrengasse 7","Johannesgasse 5","Stubenring 1","Ballhausplatz 2"], correct:"Herrengasse 7", coords:[48.20925481780634, 16.365909640181602] },
    { name:"BM Justiz", question:"Wo befindet sich das BM f√ºr Justiz?", options:["Museumstra√üe 7","Herrengasse 7","Johannesgasse 5","Stubenring 1"], correct:"Museumstra√üe 7", coords:[48.20581717886796, 16.355142309499076] },
    { name:"Rathaus", question:"Wo befindet sich das Rathaus?", options:["Rathausplatz 1","Stubenring 1","Johannesgasse 5","Minoritenplatz 8"], correct:"Rathausplatz 1", coords:[48.21110695472529, 16.358082597852153] }
  ],
  gerichte: [
    { name:"VfGH", question:"Wo befindet sich der Verfassungsgerichtshof?", options:["Freyung 8","Judenplatz 11","Schmerlingplatz 10-11","Stubenring 1"], correct:"Freyung 8", coords:[48.210,16.364] },
    { name:"VwGH", question:"Wo befindet sich der Verwaltungsgerichtshof?", options:["Judenplatz 11","Freyung 8","Stubenring 1","Ballhausplatz 2"], correct:"Judenplatz 11", coords:[48.211,16.369] },
    { name:"OGH", question:"Wo befindet sich der Oberste Gerichtshof?", options:["Schmerlingplatz 10-11","Landesgerichtsstra√üe 11","Herrengasse 7","Ballhausplatz 1"], correct:"Schmerlingplatz 10-11", coords:[48.207,16.357] },
    { name:"LG Strafsachen", question:"Wo befindet sich das Landesgericht f√ºr Strafsachen?", options:["Landesgerichtsstra√üe 11","Schmerlingplatz 10-11","Herrengasse 7","Johannesgasse 5"], correct:"Landesgerichtsstra√üe 11", coords:[48.215,16.350] },
    { name:"Rechnungshof", question:"Wo befindet sich der Rechnungshof?", options:["Dampfschiffstra√üe 2","Judenplatz 11","Schmerlingplatz 10-11","Landesgerichtsstra√üe 11"], correct:"Dampfschiffstra√üe 2", coords:[48.207,16.392] }
  ],
  // –°—Ç—Ä. 7 Bundespolizei (Sicherheitsb√ºro, Fremdenpolizei, Verkehrsamt). :contentReference[oaicite:6]{index=6}
  bundespolizei: [
    { name:"Sicherheitsb√ºro (BPD Wien)", question:"Wo befindet sich das Sicherheitsb√ºro der BPD Wien?", options:["Schottenring 7-9","Hernalser G√ºrtel 6-12","Dierichgasse 27","Laxenburger Stra√üe 36"], correct:"Schottenring 7-9", coords:[48.2156,16.3704] },
    { name:"Fremdenpolizei", question:"Wo befindet sich das Fremdenpolizeiliche B√ºro (Wien)?", options:["Hernalser G√ºrtel 6-12","Schottenring 7-9","Dierichgasse 27","Wipplingerstra√üe 34"], correct:"Hernalser G√ºrtel 6-12", coords:[48.2189,16.3375] },
    { name:"Verkehrsamt (F√ºhrerschein/Taxilenker)", question:"Wo befindet sich das Verkehrsamt (F√ºhrerschein/Taxilenker)?", options:["Dierichgasse 27","Schottenring 7-9","Hernalser G√ºrtel 6-12","Wagramer Stra√üe 5"], correct:"Dierichgasse 27", coords:[48.1929,16.4075] }
  ],
  // –ü–∞—Ä—É –ø—Ä–∏–º–µ—Ä–æ–≤ PI –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º 7‚Äì10 (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–¥–æ–±–Ω–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ). :contentReference[oaicite:7]{index=7}
  stadtpolizei: [
    { name:"PI Innere Stadt", question:"Wo liegt die PI Innere Stadt (Beispiel)?", options:["Deutschmeisterplatz 3","Mariahilfer Stra√üe 1","Landesgerichtsstra√üe 11","Herrengasse 7"], correct:"Deutschmeisterplatz 3", coords:[48.2146,16.3777] },
    { name:"PI Mariahilf", question:"PI Mariahilf ‚Äì wo?", options:["Amerlingstra√üe 33","Sch√∂nbrunner Stra√üe 59","Landstra√üer Hauptstra√üe 29","Nu√üdorfer Stra√üe 28"], correct:"Amerlingstra√üe 33", coords:[48.1969,16.3483] }
  ],
  post: [
    { name:"Post (Beispiel)", question:"Hauptpost (Beispiel) liegt am ‚Ä¶", options:["Stubenring 1","Herrengasse 7","Schwedenplatz 2","K√§rntner Stra√üe 1"], correct:"Stubenring 1", coords:[48.2065,16.3819] }
  ],
  medien: [
    // S.36: APA ‚Äì Austria Presseagentur (IPZ) —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –º–∞—Ä—à—Ä—É—Ç–∞—Ö ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç. :contentReference[oaicite:8]{index=8}
    { name:"APA ‚Äì Austria Presseagentur", question:"Wo befindet sich APA (IPZ) / Media Print (Routenpunkt)?", options:["Lshaus? ‚Äì Druckzentrum Media Print","Kirchengasse 1","Schottenring 10","K√§rntner Ring 5"], correct:"Lshaus? ‚Äì Druckzentrum Media Print", coords:[48.264,16.462] }
  ],
  kammern: [
    { name:"Wirtschaftskammer Wien (Beispiel)", question:"Wo befindet sich die WKO Wien (Beispiel)?", options:["Stubenring 8-10","Getreidemarkt 10","Mariahilfer Stra√üe 123","Am Heumarkt 4"], correct:"Stubenring 8-10", coords:[48.2058,16.3797] }
  ],
  bezirksaemter: [
    { name:"Magistratisches Bezirksamt 1", question:"Amtshaus des 1. Bezirks liegt ‚Ä¶", options:["Wipplingerstra√üe 8","Rathausplatz 1","Schottenring 10","Freyung 8"], correct:"Wipplingerstra√üe 8", coords:[48.2134,16.3686] }
  ],
  // –û—Ç–µ–ª–∏/–∫–∞—Ñ–µ ‚Äì –ø–æ —Å–ø–∏—Å–∫–∞–º S.10‚Äì14 –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã. :contentReference[oaicite:9]{index=9}
  hotels: [
    { name:"Hotel Sacher", question:"Wo befindet sich das Hotel Sacher?", options:["Philharmonikerstra√üe 4","K√§rntner Ring 1","Am Heumarkt 35-37","Albertinaplatz 1"], correct:"Philharmonikerstra√üe 4", coords:[48.2039,16.3692] },
    { name:"Hilton Vienna Park", question:"Wo befindet sich Hilton Vienna Park?", options:["Am Stadtpark 1","Wagramer Stra√üe 8","Schottenring 1","Landstra√üer G√ºrtel 2"], correct:"Am Stadtpark 1", coords:[48.2055,16.3828] }
  ],
  cafes: [
    { name:"Caf√© Central", question:"Caf√© Central liegt ‚Ä¶", options:["Herrengasse 14","Rathausplatz 1","Judenplatz 11","Albertinaplatz 1"], correct:"Herrengasse 14", coords:[48.2108,16.3653] },
    { name:"Caf√© Landtmann", question:"Caf√© Landtmann liegt ‚Ä¶", options:["Universit√§tsring 4","Opernring 2","K√§rntner Stra√üe 10","Schwarzenbergplatz 1"], correct:"Universit√§tsring 4", coords:[48.2107,16.3604] }
  ],
  heurige: [
    { name:"Heurigenorte (Beispiel)", question:"Zum 19. Bezirk geh√∂rt als Heurigenort ‚Ä¶", options:["Grinzing","Stammersdorf","Sievering","Jedlesee"], correct:"Grinzing", coords:[48.2594,16.3359] }
  ],
  friedhoefe: [
    { name:"Zentralfriedhof (Tor 2)", question:"Wo befindet sich der Haupteingang (Tor 2)?", options:["Simmeringer Hauptstra√üe 234","W√§hringer G√ºrtel 14","Laxenburger Stra√üe 365","Hernalser G√ºrtel 6-12"], correct:"Simmeringer Hauptstra√üe 234", coords:[48.1528,16.4337] }
  ],
  kranken: [
    { name:"AKH Wien", question:"Wo befindet sich das AKH?", options:["W√§hringer G√ºrtel 18-20","Landstra√üer Hauptstra√üe 1","Sch√∂nbrunner Stra√üe 100","K√§rntner Ring 1"], correct:"W√§hringer G√ºrtel 18-20", coords:[48.2202,16.3451] },
    { name:"SMZ S√ºd (Kaiser-Franz-Josef-Spital)", question:"Adresse des SMZ S√ºd?", options:["Kundratstra√üe 3","Prinzenstra√üe 1","Spitalgasse 23","Sechshauser Stra√üe 10"], correct:"Kundratstra√üe 3", coords:[48.1589,16.3702] }
  ],
  pension: [
    { name:"Pensionistenwohnheim (Beispiel)", question:"Wohnheim in der Seegasse liegt im ‚Ä¶", options:["9. Bezirk","3. Bezirk","15. Bezirk","22. Bezirk"], correct:"9. Bezirk", coords:[48.2217,16.3617] }
  ],
  kultur: [
    { name:"Burgtheater", question:"Adresse vom Burgtheater?", options:["Universit√§tsring 2","Opernring 2","K√§rntner Stra√üe 1","Schottenring 10"], correct:"Universit√§tsring 2", coords:[48.2105,16.3600] }
  ],
  kabarett: [
    { name:"Kabarett Simpl", question:"Wo ist das Kabarett Simpl?", options:["Wollzeile 36","Mariahilfer Stra√üe 99","Donaukanalstra√üe 1","Herrengasse 14"], correct:"Wollzeile 36", coords:[48.2079,16.3772] }
  ],
  unis: [
    { name:"Universit√§t Wien", question:"Adresse der Universit√§t Wien?", options:["Universit√§tsring 1","Karlsplatz 13","Schottenring 8","Schillerplatz 3"], correct:"Universit√§tsring 1", coords:[48.2130,16.3607] },
    { name:"TU Wien", question:"Adresse der Technischen Universit√§t Wien?", options:["Karlsplatz 13","Universit√§tsring 1","W√§hringer Stra√üe 25","Schottenring 10"], correct:"Karlsplatz 13", coords:[48.1995,16.3690] }
  ],
  museen: [
    { name:"Albertina", question:"Wo liegt die Albertina?", options:["Albertinaplatz 1","Museumsplatz 1","Mariahilfer Stra√üe 1","Stephansplatz 1"], correct:"Albertinaplatz 1", coords:[48.2043,16.3686] },
    { name:"Naturhistorisches Museum", question:"Wo liegt das NHM?", options:["Maria-Theresien-Platz","Heldenplatz","Museumsplatz 1","Burgring 1"], correct:"Maria-Theresien-Platz", coords:[48.2056,16.3613] }
  ],
  bauten: [
    { name:"Hofburg ‚Äì Heldenplatz", question:"Hofburg/Heldenplatz geh√∂rt zu ‚Ä¶", options:["Ringstra√üe","K√§rntnerring","G√ºrtel","Franz-Josefs-Kai"], correct:"Ringstra√üe", coords:[48.2066,16.3636] }
  ],
  // G√úRTEL-–ø–∞—Ä—ã (S.23) –∏ ¬´innerer/√§u√üerer¬ª (S.27). :contentReference[oaicite:10]{index=10}
  guertel: [
    // –¢–∏–ø 1: inner/outer –≤–æ–ø—Ä–æ—Å + –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
    { name:"G√ºrtel-Kreuzung", question:"Ist diese Kreuzung am inneren oder am √§u√üeren G√ºrtel? (Mariahilfer Stra√üe √ó Mariahilfer G√ºrtel)", options:["innerer G√ºrtel","√§u√üerer G√ºrtel"], correct:"innerer G√ºrtel", coords:[48.1956,16.3394], viz:{coords:[48.1956,16.3394], bearing:45, side:"innerer", nameA:"G√ºrtel", nameB:"Mariahilfer Stra√üe"} },
    { name:"G√ºrtel-Kreuzung", question:"Ist diese Kreuzung am inneren oder am √§u√üeren G√ºrtel? (Nu√üdorfer Stra√üe √ó W√§hringer G√ºrtel)", options:["innerer G√ºrtel","√§u√üerer G√ºrtel"], correct:"innerer G√ºrtel", coords:[48.2332,16.3554], viz:{coords:[48.2332,16.3554], bearing:120, side:"innerer", nameA:"G√ºrtel", nameB:"Nu√üdorfer Stra√üe"} },
    // –¢–∏–ø 2: ¬´–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ G√ºrtel¬ª
    { name:"nach dem G√ºrtel", question:"Wie hei√üt die Stra√üe weiter, nachdem Sie die Mariahilfer Stra√üe √ºber den G√ºrtel gequert haben?", options:["Sechshauser Stra√üe","Burggasse","Thaliastra√üe","Winckelmannstra√üe"], correct:"Sechshauser Stra√üe", coords:[48.1935,16.3354], viz:{coords:[48.1956,16.3394], bearing:45, side:"innerer", nameA:"Mariahilfer Stra√üe", nameB:"Sechshauser Stra√üe"} },
    { name:"nach dem G√ºrtel", question:"Wie hei√üt die Stra√üe weiter, nachdem Sie die Burggasse √ºber den G√ºrtel gequert haben?", options:["Lerchenfelder G√ºrtel","Gablenzgasse","Thaliastra√üe","Mariahilfer Stra√üe"], correct:"Gablenzgasse", coords:[48.2058,16.3389], viz:{coords:[48.2058,16.3389], bearing:45, side:"innerer", nameA:"Burggasse", nameB:"Gablenzgasse"} },
  ],
  // DONAUKANAL ‚Äî –ø—Ä–∏–º–µ—Ä (–æ—Å—Ç–∞–ª—å–Ω–æ–µ —É–¥–æ–±–Ω–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å). :contentReference[oaicite:11]{index=11}
  donau: [
    { name:"Schwedenbr√ºcke", question:"Welche Br√ºcke verbindet Rotenturmstra√üe mit der Taborstra√üe (√ºber den Donaukanal)?", options:["Schwedenbr√ºcke","Aspernbr√ºcke","Salztorbr√ºcke","Marienbr√ºcke"], correct:"Schwedenbr√ºcke", coords:[48.2125,16.3783] }
  ],
  nummern: [
    { name:"Nummerierung", question:"Wie werden die H√§user in Wien nummeriert?", options:[
      "Ungerade links / gerade rechts stadtausw√§rts", "Gerade links / ungerade rechts stadtausw√§rts", "Fortlaufend im Uhrzeigersinn", "Nur ungerade Nummern in Wien"
    ], correct:"Ungerade links / gerade rechts stadtausw√§rts", coords:[48.206,16.372] }
  ],
  strassgeo: [
    { name:"Praterstern ‚Äì ausw√§rts f√ºhrende Stra√üen", question:"Nennen Sie zwei stadtausw√§rts f√ºhrende Stra√üen vom Praterstern.", options:["Praterstra√üe & Ausstellungsstra√üe","K√§rntner Stra√üe & Opernring","Mariahilfer Stra√üe & Burggasse","W√§hringer Stra√üe & Hernalser Hauptstra√üe"], correct:"Praterstra√üe & Ausstellungsstra√üe", coords:[48.2167,16.3925] }
  ],
  wichtige: [
    { name:"Ringstra√üe ‚Äì Teil", question:"Zum Ring geh√∂ren ‚Ä¶", options:["Opernring / Burgring / Universit√§tsring","K√§rntner Stra√üe / Graben","G√ºrtel / Triester Stra√üe","Donauufer Autobahn"], correct:"Opernring / Burgring / Universit√§tsring", coords:[48.2053,16.3685] }
  ],
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: Wiener Tarif (S.58‚Äì61) :contentReference[oaicite:12]{index=12}
  tarif: [
    { name:"Grundtaxe", question:"Wie hoch ist die Grundtaxe am Tag?", options:["3,80 ‚Ç¨","4,30 ‚Ç¨","3,50 ‚Ç¨","2,90 ‚Ç¨"], correct:"3,80 ‚Ç¨" },
    { name:"Grundtaxe Nacht", question:"Wie hoch ist die Grundtaxe nachts/So/Feiertag?", options:["4,30 ‚Ç¨","3,80 ‚Ç¨","5,00 ‚Ç¨","4,90 ‚Ç¨"], correct:"4,30 ‚Ç¨" },
    { name:"Wartezeit", question:"Wie hoch ist die Zeittaxe f√ºr eine Stunde Wartezeit?", options:["34,80 ‚Ç¨","28,00 ‚Ç¨","40,00 ‚Ç¨","20,00 ‚Ç¨"], correct:"34,80 ‚Ç¨" },
    { name:"Nachtzeit", question:"Ab wann gilt der Nachtzuschlag?", options:["23:00‚Äì06:00","22:00‚Äì05:00","00:00‚Äì06:00","21:00‚Äì05:00"], correct:"23:00‚Äì06:00" }
  ],
  // StVO/KFG/Arbeitsrecht ‚Äì –ø–æ –≤–∏–¥–∞–º —Ç–∏–ø–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. :contentReference[oaicite:13]{index=13}
  stvo: [
    { name:"Wohnstra√üe", question:"D√ºrfen Taxis durch Wohnstra√üen durchfahren?", options:["Nur Schrittgeschwindigkeit (4‚Äì5 km/h)","Ja, ohne Einschr√§nkung","Nein, verboten"], correct:"Nur Schrittgeschwindigkeit (4‚Äì5 km/h)" },
    { name:"Rettungsgasse", question:"Wo muss eine Rettungsgasse gebildet werden?", options:["Auf Autobahnen & Schnellstra√üen","Nur im Ortsgebiet","Nirgendwo"], correct:"Auf Autobahnen & Schnellstra√üen" }
  ],
  kfg: [
    { name:"Winterreifenpflicht", question:"F√ºr Taxis gilt Winterreifenpflicht ‚Ä¶", options:["1. Nov ‚Äì 15. Apr (bei winterlichen Fahrbahnverh√§ltnissen)","1. Okt ‚Äì 1. M√§rz","Ganzj√§hrig","Nur bei Schnee"], correct:"1. Nov ‚Äì 15. Apr (bei winterlichen Fahrbahnverh√§ltnissen)" }
  ],
  arbeit: [
    { name:"Mindestlohn (Kollektivvertrag) ‚Äì Info", question:"Der KV-Mindestlohn im Taxigewerbe gilt ‚Ä¶", options:["√ñsterreichweit (Bundesgebiet)","Nur in Wien","Nur f√ºr Unternehmer"], correct:"√ñsterreichweit (Bundesgebiet)" }
  ]
};

// G√ºrtel-—É–∑–ª—ã –¥–ª—è —É—á–µ–±–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (–æ—Å–Ω–æ–≤–Ω—ã–µ –∏–∑ –∫—É—Ä—Å–∞). :contentReference[oaicite:14]{index=14}
const GUERTEL_INTERSECTIONS = [
  { title:"Mariahilfer Stra√üe √ó Mariahilfer G√ºrtel", side:"innerer", coords:[48.1956,16.3394], bearing:45 },
  { title:"Nu√üdorfer Stra√üe √ó W√§hringer G√ºrtel", side:"innerer", coords:[48.2332,16.3554], bearing:120 },
  { title:"Burggasse √ó Neubaug√ºrtel", side:"innerer", coords:[48.2058,16.3389], bearing:45 },
  { title:"Thaliastra√üe √ó Lerchenfelder G√ºrtel", side:"innerer", coords:[48.2094,16.3367], bearing:45 },
  { title:"Hernalser Hauptstra√üe √ó Hernalser G√ºrtel", side:"innerer", coords:[48.2185,16.3326], bearing:45 },
  { title:"Ottakringer Stra√üe √ó Ottakringer G√ºrtel", side:"√§u√üerer", coords:[48.2148,16.3200], bearing:45 },
  { title:"Triester Stra√üe √ó G√ºrtel", side:"√§u√üerer", coords:[48.1748,16.3558], bearing:30 },
  { title:"Sch√∂nbrunner Stra√üe √ó Margareten G√ºrtel", side:"innerer", coords:[48.1876,16.3419], bearing:35 }
];

// ============ Quiz Engine ============
let selected=[], pool=[], idx=0, score=0, examMode=false;

function buildPool(keys){
  const out=[];
  keys.forEach(k=>{ if(DATA[k]) out.push(...DATA[k]); });
  return shuffle(out);
}
function startQuiz(mode="normal"){
  const checked = $$("#catList input[type=checkbox]:checked").map(x=>x.value);
  if(checked.length===0){ toast("Bitte Kategorie w√§hlen!"); return; }
  selected=checked; examMode=(mode==="exam"); pool=buildPool(selected);
  if(examMode && pool.length>10) pool=pool.slice(0,10);
  idx=0; score=0;
  $("#quizPanel").style.display="block";
  $("#sidebar").style.display="none";
  $("#studyPanel").style.display="none";
  $("#leaderPanel").style.display="none";
  $("#statsPanel").style.display="none";
  showQuestion(true);
}
function showQuestion(first=false){
  const q = pool[idx]; if(!q) return;
  $("#progress").textContent=`Frage ${idx+1} von ${pool.length}`;
  $("#progressFill").style.width = `${Math.round((idx)/pool.length*100)}%`;
  $("#questionText").textContent=q.question;
  const cont=$("#optionsContainer"); cont.innerHTML="";
  shuffle(q.options).forEach((opt,i)=>{
    const d=document.createElement("div");
    d.className="option"; d.tabIndex=0; d.dataset.correct=(opt===q.correct);
    d.innerHTML=`<strong>${i+1}.</strong> ${opt}`;
    d.onclick = ()=>checkAnswer(d,opt);
    d.onkeydown = (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); d.click(); } };
    cont.appendChild(d);
  });
  $("#nextBtn").style.display="none";
  $("#endBtns").style.display="none";
  // –û–∑–≤—É—á–∫–∞
  speak(`${q.name}. ${q.question}`);
  // –ï—Å–ª–∏ —ç—Ç–æ G√ºrtel-–≤–æ–ø—Ä–æ—Å —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π ‚Äî –Ω–∞—Ä–∏—Å—É–µ–º –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫ (–±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ –æ—Ç–≤–µ—Ç—É)
  if(q.viz){ drawIntersection({coords:q.viz.coords, bearing:q.viz.bearing, side:q.viz.side, nameA:q.viz.nameA||"G√ºrtel", nameB:q.viz.nameB||"Stra√üe"}); }
}
function checkAnswer(el,opt){
  const q=pool[idx];
  const ok=(opt===q.correct);
  $$("#optionsContainer .option").forEach(o=>o.onclick=null);
  el.classList.add(ok?"correct":"incorrect");
  if(!ok){ const r=$$("#optionsContainer .option").find(x=>x.dataset.correct==="true"); if(r) r.classList.add("correct"); }
  if(ok) score++;

  if(answerMarker){ map.removeLayer(answerMarker); answerMarker=null; }
  if(Array.isArray(q.coords)){ fly(q.coords,16); answerMarker=L.marker(q.coords).addTo(map).bindPopup(`<b>${q.name}</b><br>${q.correct}`).openPopup(); }

  speak(ok ? "Richtig. Gut gemacht." : `Leider falsch. Richtig ist: ${q.correct}.`);
  $("#nextBtn").style.display="block";

  // session stats
  sess.total++; if(ok) sess.correct++;
  const cat = detectCat(q); if(!sess.byCat[cat]) sess.byCat[cat]={total:0,correct:0}; sess.byCat[cat].total++; if(ok) sess.byCat[cat].correct++;
}
function nextQuestion(){
  idx++;
  if(idx<pool.length){ showQuestion(); }
  else{
    $("#questionText").textContent=`Fertig! Punkte: ${score}/${pool.length}`;
    $("#optionsContainer").innerHTML="";
    $("#progress").textContent=""; $("#progressFill").style.width="100%";
    $("#nextBtn").style.display="none"; $("#endBtns").style.display="block";
    speak(`Fertig. Punkte: ${score} von ${pool.length}.`);
    saveSession();
  }
}
function backToMenu(){ $("#quizPanel").style.display="none"; $("#sidebar").style.display="block"; $("#endBtns").style.display="none"; }
function restartQuiz(){ $("#endBtns").style.display="none"; idx=0; score=0; pool=shuffle(pool); showQuestion(true); }
function detectCat(q){
  for(const k of Object.keys(DATA)) if(DATA[k].includes(q)) return k;
  return "misc";
}

// ============ G√ºrtel Study ============
function openStudy(){
  $("#studyPanel").style.display="block";
  $("#leaderPanel").style.display="none";
  $("#statsPanel").style.display="none";
  $("#sidebar").style.display="none";
  $("#quizPanel").style.display="none";
  const list=$("#studyList"); list.innerHTML="";
  GUERTEL_INTERSECTIONS.forEach((g,i)=>{
    const div=document.createElement("div");
    div.className="item";
    div.style.cssText="padding:8px 10px;border-bottom:1px dashed var(--border);cursor:pointer";
    div.innerHTML = `${i+1}. ${g.title} ‚Äî <span class="badge ${g.side==='innerer'?'badge-inner':'badge-outer'}">${g.side}</span>`;
    div.onclick = ()=> drawIntersection({coords:g.coords, bearing:g.bearing, side:g.side, nameA:"G√ºrtel", nameB:g.title.split(' √ó ')[0]});
    list.appendChild(div);
  });
  toast("–£—á–µ–±–Ω—ã–π —Ä–µ–∂–∏–º G√ºrtel –æ—Ç–∫—Ä—ã—Ç");
}

// ============ Auth ============
let isReg=false;
$("#toRegister").onclick=(e)=>{e.preventDefault();isReg=true;$("#formTitle").textContent="Register";$("#loginPass2").style.display="block";$("#submitBtn").textContent="Register";};
$("#toLogin").onclick=(e)=>{e.preventDefault();isReg=false;$("#formTitle").textContent="Login";$("#loginPass2").style.display="none";$("#submitBtn").textContent="Log in";};
$("#submitBtn").onclick=async()=>{
  const email=$("#loginEmail").value.trim(), p1=$("#loginPass").value.trim(), p2=$("#loginPass2").value.trim();
  try{
    if(isReg){ if(p1!==p2){ $("#loginError").textContent="Passwords do not match!"; return; } await createUserWithEmailAndPassword(auth,email,p1); toast("‚úÖ Registration successful!"); }
    else{ await signInWithEmailAndPassword(auth,email,p1); toast("‚úÖ Login successful!"); }
  }catch(err){ $("#loginError").textContent="‚ö†Ô∏è "+err.message; }
};
$("#logoutBtn").onclick=()=>signOut(auth);
onAuthStateChanged(auth, async (user)=>{ if(user){ $("#loginModal").style.display="none"; toast("Willkommen!"); loadCats(); loadMyStats(); loadLeaderboard(); } else { $("#loginModal").style.display="flex"; } });

// ============ Stats & Leaderboard ============
const sess={total:0,correct:0,byCat:{}};
function resetSess(){ sess.total=0; sess.correct=0; sess.byCat={}; }
async function saveSession(){
  const u=auth.currentUser; if(!u) return;
  const ts=Date.now();
  await set(ref(db, `sessions/${u.uid}/${ts}`), {ts, total:sess.total, correct:sess.correct, byCat:sess.byCat, cats:selected, examMode, score, poolLen:pool.length});
  const sref=ref(db, `stats/${u.uid}`); const snap=await get(sref);
  let agg=snap.exists()? snap.val():{total:0,correct:0,byCat:{}, last:0};
  agg.total += sess.total; agg.correct += sess.correct; agg.last = ts;
  for(const k of Object.keys(sess.byCat)){ if(!agg.byCat[k]) agg.byCat[k]={total:0,correct:0}; agg.byCat[k].total+=sess.byCat[k].total; agg.byCat[k].correct+=sess.byCat[k].correct; }
  await set(sref, agg);
  const acc = agg.total? Math.round(100*agg.correct/agg.total):0;
  await set(ref(db, `leaderboard/${u.uid}`), { user:u.email||u.uid, correct:agg.correct, total:agg.total, acc, last:ts });
  resetSess(); loadMyStats(); loadLeaderboard();
}
async function loadMyStats(){
  const u=auth.currentUser; if(!u) return;
  const snap=await get(ref(db,`stats/${u.uid}`)); const el=$("#myStats");
  if(!snap.exists()){ el.innerHTML="<p class='small'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É.</p>"; return; }
  const st=snap.val(); const acc = st.total? Math.round(100*st.correct/st.total):0;
  const cats=Object.entries(st.byCat||{}).map(([k,v])=>`<li>${k}: ${v.correct}/${v.total}</li>`).join("");
  el.innerHTML = `<p><b>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö:</b> ${st.correct} / ${st.total} <span class="small">(${acc}%)</span></p><ul>${cats}</ul><p class="small">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(st.last).toLocaleString()}</p>`;
}
async function loadLeaderboard(){
  const snap=await get(ref(db,'leaderboard')); const el=$("#leaderList"); el.innerHTML="";
  if(!snap.exists()){ el.innerHTML="<p class='small'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</p>"; return; }
  const items=Object.values(snap.val()); items.sort((a,b)=> b.correct-a.correct || a.last-b.last);
  const me=auth.currentUser?(auth.currentUser.email||auth.currentUser.uid):"";
  items.slice(0,30).forEach((it,i)=>{ const row=document.createElement("div"); row.className="item"+(it.user===me?" you":""); row.innerHTML = `<div>#${i+1} <b>${it.user}</b></div><div>${it.correct}/${it.total} <span class="small">(${it.acc}%)</span></div>`; el.appendChild(row); });
}

// ============ TTS (ElevenLabs) ============
let ttsOn=true; const audioEl=new Audio(); audioEl.volume=1;
let queue=[], playing=false;
function speak(text){
  if(!ttsOn || !text) return;
  queue.push(...text.replace(/\s+/g," ").split(/(?<=[\.\!\?])/g).map(s=>s.trim()).filter(Boolean));
  if(!playing) nextSpeak();
}
async function nextSpeak(){
  if(queue.length===0){ playing=false; return; }
  playing=true; const part=queue.shift();
  try{
    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVEN_VOICE_ID}?optimize_streaming_latency=3`,{
      method:"POST",
      headers:{ "xi-api-key": ELEVEN_API_KEY, "Content-Type":"application/json", "Accept":"audio/mpeg" },
      body: JSON.stringify({ text: part, model_id:"eleven_multilingual_v2", voice_settings:{ stability:0.4, similarity_boost:0.8, style:0, use_speaker_boost:true } })
    });
    const blob = await res.blob();
    audioEl.src = URL.createObjectURL(blob);
    await audioEl.play();
    audioEl.onended = ()=> nextSpeak();
  }catch(e){
    console.warn("TTS error",e); playing=false;
  }
}
function stopSpeak(){ try{ audioEl.pause(); audioEl.currentTime=0; }catch{} queue=[]; playing=false; }

// ============ UI Bindings ============
function loadCats(){
  const wrap=$("#catList"); wrap.innerHTML="";
  THEMEN.forEach(t=>{
    const count = DATA[t.key]?.length || 0;
    const div=document.createElement("label"); div.className="cat";
    div.innerHTML = `<input type="checkbox" value="${t.key}"> <div>${t.title} <span class="small">(${t.pages})</span></div> <span class="count">${count}</span>`;
    wrap.appendChild(div);
  });
}
$("#menuBtn").onclick = ()=>{ const s=$("#sidebar"); s.style.display=(s.style.display==="block"?"none":"block"); };
$("#startBtn").onclick = ()=>{ resetSess(); startQuiz("normal"); };
$("#examBtn").onclick  = ()=>{ resetSess(); startQuiz("exam"); };
$("#nextBtn").onclick  = nextQuestion;
$("#againBtn").onclick = restartQuiz;
$("#backBtn").onclick  = backToMenu;
$("#studyBtn").onclick = openStudy;
$("#leaderBtn").onclick= ()=>{ $("#leaderPanel").style.display="block"; $("#studyPanel").style.display="none"; $("#statsPanel").style.display="none"; $("#sidebar").style.display="none"; $("#quizPanel").style.display="none"; loadLeaderboard(); };
$("#statsBtn").onclick = ()=>{ $("#statsPanel").style.display="block"; $("#leaderPanel").style.display="none"; $("#studyPanel").style.display="none"; $("#sidebar").style.display="none"; $("#quizPanel").style.display="none"; loadMyStats(); };
$("#ttsToggleBtn").onclick = ()=>{ ttsOn=!ttsOn; toast(ttsOn?"üîä –û–∑–≤—É—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞":"üîá –û–∑–≤—É—á–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞"); if(!ttsOn) stopSpeak(); };

document.addEventListener("keydown",(e)=>{
  if($("#quizPanel").style.display!=="block") return;
  const i=["1","2","3","4","5","6"].indexOf(e.key);
  if(i>=0){ const opt=$$("#optionsContainer .option")[i]; if(opt && opt.onclick) opt.click(); }
  if(e.key==="Enter" && $("#nextBtn").style.display==="block") nextQuestion();
});
window.addEventListener("load", ()=>{ toast("Bereit. Melden Sie sich an."); loadCats(); });
</script>
</body>
</html
