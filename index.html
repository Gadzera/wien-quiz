<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wiener Ortskunde ‚Äì Interaktive Karte & Pr√ºfungs‚ÄëQuiz</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- pdf.js (–¥–ª—è OCR-–∏–º–ø–æ—Ä—Ç–∞) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>

<!-- Tesseract.js (OCR, —á–∏—Ç–∞—Ç—å kurs.pdf –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -->
<script src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

<style>
:root{
  --brand:#2563eb; --brand-2:#60a5fa; --ok:#16a34a; --err:#dc2626; --warn:#f59e0b;
  --bg:#ffffff; --panel:#ffffff; --text:#0f172a; --muted:#6b7280;
  --chip:#f8fafc; --border:#e5e7eb; --shadow:0 10px 30px rgba(2,6,23,.15); --radius:14px;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1020; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --chip:#0b1225; --border:#1f2937; --shadow:0 10px 40px rgba(0,0,0,.45); }
}
*{ box-sizing:border-box } html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,sans-serif; }
#map{ position:fixed; inset:0; z-index:1; }

/* topbar */
.topbar{ position:fixed; top:12px; left:12px; right:12px; z-index:1100; display:flex; gap:8px; align-items:center; pointer-events:none; }
.btn{ pointer-events:auto; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); box-shadow:var(--shadow); }
.btn.secondary{ background:#334155; }
.iconbtn{ pointer-events:auto; border:none; border-radius:10px; padding:10px 12px; background:#111827; color:#fff; opacity:.95; cursor:pointer; }
.spacer{ flex:1 }

/* sidebar */
.sidebar{ position:fixed; top:64px; left:12px; z-index:1000; width:420px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); display:none; }
.sidebar h3{ margin:0 0 8px 0; }
.cat{ display:flex; align-items:center; gap:8px; padding:8px; margin:8px 0; background:var(--chip); border-left:4px solid var(--brand); border-radius:10px; }
.cat .meta{ margin-left:auto; font-size:12px; color:var(--muted); }
.small{ font-size:12px; color:var(--muted); }
hr{ border:none; border-top:1px solid var(--border); margin:10px 0; }

/* quiz */
.quiz-panel{ position:fixed; top:64px; right:12px; z-index:1000; width:500px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none; }
.question{ font-weight:800; margin:8px 0 10px; text-align:center; }
.progress{ text-align:center; font-size:13px; color:var(--muted); }
.progressbar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px 0 12px; }
.progressbar-fill{ height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }
.options{ display:grid; gap:8px; }
.option{ padding:12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:transparent; }
.option:hover{ border-color:var(--brand); background:rgba(37,99,235,.07); }
.option.correct{ border-color:var(--ok); background:#f0fdf4; }
.option.incorrect{ border-color:var(--err); background:#fef2f2; }
.replay-row{ display:flex; gap:8px; justify-content:center; margin:6px 0 4px; }
.next-btn,.end-btn{ margin-top:10px; width:100%; font-weight:800; border:none; border-radius:10px; padding:10px 14px; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); cursor:pointer; }
.end-btn.secondary{ background:#334155; }

.panel{ position:fixed; top:64px; right:520px; z-index:1000; width:540px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none; }

/* login */
#loginModal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:2000; }
#loginBox{ width:90%; max-width:380px; background:var(--panel); color:var(--text); border-radius:14px; padding:20px; box-shadow:var(--shadow); border:1px solid var(--border); }
#loginBox h2{ margin:0 0 12px 0; }
#loginBox input{ width:100%; padding:12px; margin:8px 0; border:1px solid var(--border); border-radius:10px; background:var(--chip); color:var(--text); }
.login-btn{ width:100%; padding:12px; border:none; border-radius:10px; font-weight:800; background:linear-gradient(180deg,#ffcc66,#ff9933); cursor:pointer; }

/* toast */
.toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(20px); background:rgba(17,24,39,.95); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:3000; font-size:13px; }
.toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

/* G√ºrtel */
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }
.badge-inner{ background:#0ea5e9; color:#fff; }
.badge-outer{ background:#f59e0b; color:#111; }

/* –ø—É–ª—å—Å–∏—Ä—É—é—â–∞—è –Ω–µ–º–∞—è –º–µ—Ç–∫–∞ */
.pulse{ width:16px; height:16px; margin-top:-8px; margin-left:-8px; border-radius:50%; background:#2563ebaa; box-shadow:0 0 0 rgba(37,99,235,.5); animation:pulse 1.8s infinite; }
@keyframes pulse{ 0%{ box-shadow:0 0 0 0 rgba(37,99,235,.5);} 70%{ box-shadow:0 0 0 15px rgba(37,99,235,0);} 100%{ box-shadow:0 0 0 0 rgba(37,99,235,0);} }

/* –æ–≤–µ—Ä–ª–µ–π –ø—Ä–æ—Ü–µ—Å—Å–∞ OCR */
#ocrOverlay{ position:fixed; inset:0; background:rgba(15,23,42,.84); color:#fff; z-index:5000; display:none; align-items:center; justify-content:center; flex-direction:column; gap:8px; }
#ocrBar{ width:66%; height:12px; background:#0b1225; border-radius:999px; overflow:hidden; box-shadow:inset 0 0 0 1px #334155; }
#ocrBar > div{ height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#84cc16); transition:width .25s; }
</style>
</head>
<body>

<div id="map"></div>

<div class="topbar">
  <button class="btn" id="menuBtn">‚ò∞ Themen</button>
  <div class="spacer"></div>
  <button class="iconbtn" id="importBtn" title="–ò–º–ø–æ—Ä—Ç –∏–∑ kurs.pdf (OCR)">üì•</button>
  <button class="iconbtn" id="studyBtn" title="–£—á–µ–±–Ω—ã–π —Ä–µ–∂–∏–º G√ºrtel">üß≠</button>
  <button class="iconbtn" id="leaderBtn" title="–õ–∏–¥–µ—Ä–±–æ—Ä–¥">üèÜ</button>
  <button class="iconbtn" id="statsBtn" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">üìä</button>
  <button class="iconbtn" id="ttsToggleBtn" title="–û–∑–≤—É—á–∫–∞ –≤–∫–ª/–≤—ã–∫–ª">üîä</button>
  <button class="iconbtn" id="logoutBtn" title="–í—ã–π—Ç–∏">‚éã</button>
</div>

<div class="sidebar" id="sidebar">
  <h3>üóÇÔ∏è I. ORTSKUNDE ‚Äì offizieller Fragenkatalog</h3>
  <div id="catList"></div>
  <hr/>
  <button id="startBtn" class="btn" style="width:100%;margin-top:6px;">‚ñ∂Ô∏è Freies Quiz</button>
  <button id="examBtn" class="btn secondary" style="width:100%;margin-top:8px;">üìù Pr√ºfungsmodus (10 gemischt)</button>
  <button id="officialBtn" class="btn secondary" style="width:100%;margin-top:8px;">‚úÖ Amtlicher Block starten</button>
  <p class="small" style="margin-top:8px">Hotkeys: <b>1..6</b> f√ºr Antworten, <b>Enter</b> = Weiter.</p>
  <p class="small">Grundlage: Tabellen auf S. 6‚Äì28 (Adressen/Paare G√úRTEL), Tarif ‚Äì S. 58‚Äì61. :contentReference[oaicite:1]{index=1}</p>
</div>

<div class="quiz-panel" id="quizPanel" aria-live="polite">
  <div class="progress" id="progress"></div>
  <div class="progressbar"><div class="progressbar-fill" id="progressFill"></div></div>

  <div class="question" id="questionText"></div>

  <div class="replay-row">
    <button class="btn secondary" id="replayBtn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–æ–ø—Ä–æ—Å">üîÅ Wiederholen</button>
    <button class="btn secondary" id="replaySlowBtn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–æ–ø—Ä–æ—Å –º–µ–¥–ª–µ–Ω–Ω–µ–µ">üê¢ Langsamer</button>
  </div>
  <div class="small" style="text-align:center;margin-top:-6px;margin-bottom:6px;">ElevenLabs‚ÄëTTS: ¬´Langsamer¬ª = 0.6√ó</div>

  <div class="options" id="optionsContainer"></div>
  <button class="next-btn" id="nextBtn" style="display:none;">Weiter ‚Üí</button>
  <div id="endBtns" style="display:none;">
    <button class="end-btn" id="againBtn">üîÑ Nochmal spielen</button>
    <button class="end-btn secondary" id="backBtn">üìñ Zur√ºck</button>
  </div>
</div>

<div class="panel" id="studyPanel" style="display:none;">
  <h3>üß≠ G√ºrtel ‚Äì Interaktive Kreuzungen</h3>
  <p class="small">–ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ ‚Äî –æ—Ç—Ä–∏—Å—É—é –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫ (–æ—Å–∏ + —Å–µ–∫—Ç–æ—Ä <span class="badge badge-inner">innerer</span>/<span class="badge badge-outer">√§u√üerer</span>). –ü–∞—Ä—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç S.23 –∏ —Ç–∞–±–ª–∏—Ü–µ ¬´G√úRTEL¬ª S.27. :contentReference[oaicite:2]{index=2}</p>
  <div id="studyList"></div>
</div>

<div class="panel" id="leaderPanel" style="display:none;">
  <h3>üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</h3>
  <div id="leaderList"></div>
</div>
<div class="panel" id="statsPanel" style="display:none;">
  <h3>üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
  <div id="myStats"></div>
</div>

<!-- Login -->
<div id="loginModal">
  <div id="loginBox">
    <h2 id="formTitle">Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPass" placeholder="Password">
    <input type="password" id="loginPass2" placeholder="Repeat Password" style="display:none;">
    <button class="login-btn" id="submitBtn">Log in</button>
    <button class="login-btn" id="guestBtn" style="margin-top:8px;background:linear-gradient(180deg,#94a3b8,#475569);color:#fff;">Weiter ohne Login</button>
    <p id="loginError" style="color:#ef4444; font-size:12px;"></p>
    <div class="small">
      <a href="#" id="toRegister">Register</a> | <a href="#" id="toLogin">Login</a>
    </div>
    <p class="small" style="margin-top:8px">
      Hinweis: Wenn Auth‚ÄëFehler <b>auth/unauthorized-domain</b>, –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω GitHub Pages –≤
      <i>Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains</i>.
    </p>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- ====== –î–ê–¢–ê–ü–ê–ö (–Ω–∞—á–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ: 1‚Äì3 –ø–æ–ª–Ω—ã–µ, + Museen/Universit√§ten/Kaffeeh√§user/Friedh√∂fe/Hotels ‚Äî –æ—Å–Ω–æ–≤—É —è –≤–Ω—ë—Å) ====== -->
<script type="application/json" id="data-pack">
{
  "meta": {
    "source": "Kurs-PDF I. ORTSKUNDE (S. 6‚Äì28), Wiener Tarif (S. 58‚Äì61)",
    "note": "–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –æ–¥–∏–Ω –≤ –æ–¥–∏–Ω —Å PDF; –∞–¥—Ä–µ—Å–∞ ‚Äî –∏–∑ —Ç–∞–±–ª–∏—Ü. –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –º–æ–∂–Ω–æ ¬´–¥–æ—Ç—è–Ω—É—Ç—å –¥–æ 100%¬ª –∫–Ω–æ–ø–∫–æ–π OCR‚Äë–∏–º–ø–æ—Ä—Ç–∞."
  },
  "regierungs": [
    {"name":"Parlament (Nationalrat und Bundesrat)","address":"Dr.-Karl-Renner-Ring 3"},
    {"name":"Bundespr√§sident (Pr√§sidentschaftskanzlei) [Hofburg]","address":"Ballhausplatz 1"},
    {"name":"Bundeskanzleramt","address":"Ballhausplatz 2"},
    {"name":"Bundesministerium f√ºr Inneres","address":"Herrengasse 7"},
    {"name":"Bundesministerium f√ºr Europ√§ische und Internationale Angelegenheiten","address":"Minoritenplatz 8"},
    {"name":"Bundesministerium f√ºr Bildung, Wissenschaft und Forschung","address":"Minoritenplatz 5"},
    {"name":"Bundesministerium f√ºr Digitalisierung und Wirtschaftsstandort","address":"Stubenring 1"},
    {"name":"Bundesministerium f√ºr Arbeit","address":"Taborstra√üe 1-3"},
    {"name":"Bundesministerium f√ºr Finanzen","address":"Johannesgasse 5"},
    {"name":"Bundesministerium f√ºr Klimaschutz, Umwelt, Energie, Mobilit√§t, Innovation und Technologie","address":"Radetzkystra√üe 2"},
    {"name":"Bundesministerium f√ºr Kunst, Kultur, √∂ffentlichen Dienst und Sport","address":"Radetzkystra√üe 2"},
    {"name":"Bundesministerium f√ºr Landwirtschaft, Regionen und Tourismus","address":"Stubenring 1"},
    {"name":"Bundesministerium f√ºr Soziales, Gesundheit, Pflege und Konsumentenschutz","address":"Stubenring 1"},
    {"name":"Bundesministerium f√ºr Justiz","address":"Museumstra√üe 7"},
    {"name":"Bundesministerium f√ºr Landesverteidigung","address":"Ro√üauer L√§nde 1"},
    {"name":"Landesregierung und B√ºrgermeister/Landeshauptmann (Rathaus)","address":"Rathausplatz 1"}
  ],
  "gerichte": [
    {"name":"Verfassungsgerichtshof","address":"Freyung 8"},
    {"name":"Verwaltungsgerichtshof","address":"Judenplatz 11"},
    {"name":"Oberster Gerichtshof","address":"Schmerlingplatz 10-11"},
    {"name":"Oberlandesgericht Wien","address":"Schmerlingplatz 10-11"},
    {"name":"Oberstaatsanwaltschaft Wien","address":"Schmerlingplatz 10-11"},
    {"name":"Landesgericht f√ºr Zivilrechtssachen Wien","address":"Schmerlingplatz 10-11"},
    {"name":"Landesgericht f√ºr Strafsachen","address":"Landesgerichtsstra√üe 11"},
    {"name":"Justizanstalt Wien Josefstadt","address":"Wickenburggasse 18-20"},
    {"name":"Rechnungshof","address":"Dampfschiffstra√üe 2"}
  ],
  "bundespolizei":[
    {"name":"Bundespolizeidirektion Wien ‚Äì Sicherheitsb√ºro","address":"Schottenring 7-9"},
    {"name":"Fremdenpolizeiliches B√ºro","address":"Hernalser G√ºrtel 6-12"},
    {"name":"Verkehrsamt (F√ºhrerschein/Taxilenker)","address":"Dierichgasse 27"}
  ],

  /* ===== –ø—Ä–∏–º–µ—Ä—ã –±–æ–ª—å—à–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤; ¬´–ò–º–ø–æ—Ä—Ç –∏–∑ PDF¬ª –∑–∞–ø–æ–ª–Ω–∏—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ===== */
  "museen": [
    {"name":"Albertina","address":"Albertinaplatz 1"},
    {"name":"Museum f√ºr angewandte Kunst (MAK)","address":"Stubenring 5"},
    {"name":"Kunsthistorisches Museum","address":"Burgring 5"},
    {"name":"Naturhistorisches Museum","address":"Burgring 7"},
    {"name":"Secession","address":"Friedrichstra√üe 12"},
    {"name":"√ñsterreichische Nationalbibliothek (Prunksaal)","address":"Josefsplatz 1"},
    {"name":"Heeresgeschichtliches Museum","address":"Arsenal, Objekt 1"},
    {"name":"Technisches Museum Wien","address":"Mariahilfer Stra√üe 212"},
    {"name":"Kunst Haus Wien ‚Äì Museum Hundertwasser","address":"Untere Wei√ügerberstra√üe 13"},
    {"name":"Leopold Museum (MuseumsQuartier)","address":"Museumsplatz 1"},
    {"name":"MUMOK ‚Äì Museum moderner Kunst (MQ)","address":"Museumsplatz 1"}
  ],
  "unis": [
    {"name":"Universit√§t Wien","address":"Universit√§tsring 1"},
    {"name":"Universit√§t f√ºr angewandte Kunst","address":"Oskar-Kokoschka-Platz 2"},
    {"name":"Akademie der bildenden K√ºnste","address":"Schillerplatz 3"},
    {"name":"Universit√§t f√ºr Musik und darstellende Kunst","address":"Lothringerstra√üe 20"},
    {"name":"Technische Universit√§t Wien","address":"Karlsplatz 13"},
    {"name":"Wirtschaftsuniversit√§t (WU) (Campus)","address":"Welthandelsplatz 1"},
    {"name":"Universit√§t f√ºr Bodenkultur (BOKU)","address":"Gregor-Mendel-Stra√üe 33"},
    {"name":"Veterin√§rmedizinische Universit√§t","address":"Veterin√§rplatz 1"},
    {"name":"P√§dagogische Hochschule Wien","address":"Grenzackerstra√üe 18"}
  ],
  "cafes":[
    {"name":"Caf√© Central","address":"Herrengasse 14 (Palais Ferstel)"},
    {"name":"Caf√© Landtmann","address":"Universit√§tsring 4"},
    {"name":"Caf√© Pr√ºckel","address":"Stubenring 24"},
    {"name":"Caf√© Schwarzenberg","address":"K√§rntner Ring 17"},
    {"name":"Caf√© Sperl","address":"Gumpendorfer Stra√üe 11"},
    {"name":"Caf√© Museum","address":"Operngasse 7"}
  ],
  "friedhoefe":[
    {"name":"Zentralfriedhof (Tor 2 / Verwaltung)","address":"Simmeringer Hauptstra√üe 234"},
    {"name":"Friedhof Hietzing (Maxing)","address":"Maxingstra√üe 15"},
    {"name":"Friedhof D√∂bling","address":"Billrothstra√üe 26"},
    {"name":"Friedhof Hernals","address":"Hernalser Hauptstra√üe 137"},
    {"name":"Friedhof Ottakring","address":"Gallitzinstra√üe 5"},
    {"name":"Friedhof Grinzing","address":"An den langen L√ºssen 1"},
    {"name":"Friedhof Sievering","address":"Nottebohmstra√üe 51"},
    {"name":"Stammersdorfer Zentralfriedhof","address":"Stammersdorfer Stra√üe 244-260"},
    {"name":"S√ºdwestfriedhof","address":"Wundtgasse 14"}
  ],
  "hotels": [
    {"name":"Hotel Sacher Wien","address":"Philharmonikerstra√üe 4"},
    {"name":"Hotel Imperial","address":"K√§rntner Ring 16"},
    {"name":"Hotel Bristol","address":"K√§rntner Ring 1"},
    {"name":"Palais Coburg Residenz","address":"Coburgbastei 4"},
    {"name":"Palais Hansen Kempinski Vienna","address":"Schottenring 24"},
    {"name":"Vienna Marriott Hotel","address":"Parkring 12"},
    {"name":"Hilton Vienna Park","address":"Am Stadtpark 1"},
    {"name":"Hilton Vienna Danube Waterfront","address":"Handelskai 269"},
    {"name":"NH Danube City","address":"Wagramer Stra√üe 21"},
    {"name":"NH Wien City","address":"Mariahilfer Stra√üe 32-34"},
    {"name":"Novotel Wien City","address":"Aspernbr√ºckengasse 1"},
    {"name":"Mercure Josefshof Wien am Rathaus","address":"Josefsgasse 4-6"},
    {"name":"Mercure Wien Westbahnhof","address":"Felberstra√üe 4"},
    {"name":"Hotel Am Konzerthaus ‚Äì MGallery","address":"Am Heumarkt 35-37"},
    {"name":"Regina Hotel","address":"Rooseveltplatz 15"},
    {"name":"Schloss Wilhelminenberg","address":"Savoyenstra√üe 2"},
    {"name":"Austria Trend Hotel Savoyen","address":"Rennweg 16"},
    {"name":"Grand Ferdinand","address":"Schubertring 10-12"}
  ],

  /* G√úRTEL (S.23 und S.27) ‚Äî –ø—Ä–∏–º–µ—Ä—ã; –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å, –∞ –≤ —Ä–µ–∂–∏–º–µ ¬´–£—á–µ–±–Ω—ã–π G√ºrtel¬ª —Ç–æ—á–∫–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è */
  "guertel": [
    {"pair":"Mariahilfer Stra√üe ‚Üí Sechshauser Stra√üe","type":"nachGUE"},
    {"pair":"Burggasse ‚Üí Gablenzgasse","type":"nachGUE"},
    {"pair":"Nu√üdorfer Stra√üe √ó W√§hringer G√ºrtel = innerer G√ºrtel","type":"seite"}
  ],

  /* –¢–∞—Ä–∏—Ñ ‚Äî –≤—ã–¥–µ—Ä–∂–∫–∏ –∏–∑ S.58‚Äì61 */
  "tarif": [
    {"q":"Wie hoch ist die Grundtaxe am Tag?","a":"3,80 ‚Ç¨","distractors":["4,30 ‚Ç¨","3,50 ‚Ç¨","2,90 ‚Ç¨"]},
    {"q":"Wie hoch ist die Grundtaxe in der Nacht / an Sonn- und Feiertagen?","a":"4,30 ‚Ç¨","distractors":["3,80 ‚Ç¨","5,00 ‚Ç¨","4,90 ‚Ç¨"]},
    {"q":"Wie hoch ist die Zeittaxe f√ºr eine Stunde Wartezeit?","a":"34,80 ‚Ç¨","distractors":["28,00 ‚Ç¨","40,00 ‚Ç¨","20,00 ‚Ç¨"]},
    {"q":"Der Nachtzuschlag gilt von ‚Ä¶ bis ‚Ä¶ Uhr.","a":"23:00‚Äì06:00","distractors":["22:00‚Äì05:00","00:00‚Äì06:00","21:00‚Äì05:00"]}
  ]
}
</script>

<!-- ====== –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (–ª–æ–≥–∏–∫–∞) ====== -->
<script type="module">
/* ================= CONFIG ================= */
const ELEVEN_API_KEY  = "f3e700c3faf18f37d5b07200c0f83b5d22059752311d8c655afc5e0e8ba1188d"; // ElevenLabs
const ELEVEN_VOICE_ID = "ROYWaqtov1Lot9vQBM3y";
const GOOGLE_MAPS_API_KEY = ""; // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî OSM)

/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCqVNVOXqYlPryEvjIYkOyp3BrWMtRMlGg",
  authDomain: "wien-quiz.firebaseapp.com",
  databaseURL: "https://wien-quiz-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "wien-quiz",
  storageBucket: "wien-quiz.appspot.com",
  messagingSenderId: "467695563938",
  appId: "1:467695563938:web:87b15a9b5de5d3764bd3fb",
  measurementId: "G-SN0SMY9NH2"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
setPersistence(auth, browserLocalPersistence).catch(()=>{});
const db = getDatabase(app);

/* ================= helpers ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toast = (m,ms=1900)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); };
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]] } return x; }

/* ================= map ================= */
const map = L.map('map',{zoomControl:true}).setView([48.2082,16.3738],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);
let answerMarker=null, preMarker=null, gLayer=null, blinkTimer=null;
const PulseIcon = L.DivIcon.extend({ options:{ className:'', html:'<div class="pulse"></div>', iconSize:[16,16] }});

function fly([lat,lng], zoom=15){ map.flyTo([lat,lng], zoom, {duration:1.0}); }
function clearViz(){ if(gLayer){ map.removeLayer(gLayer); gLayer=null; } if(blinkTimer){ clearInterval(blinkTimer); blinkTimer=null; } }
function cleanMarkers(){ if(answerMarker){ map.removeLayer(answerMarker); answerMarker=null; } if(preMarker){ map.removeLayer(preMarker); preMarker=null; } }

/* ‚Äî‚Äî‚Äî –≥–µ–æ–º–µ—Ç—Ä–∏—è –¥–ª—è G√ºrtel-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π ‚Äî‚Äî‚Äî */
function project([lat,lng], bearingDeg, dist){
  const R=6378137, d=dist/R, br=bearingDeg*Math.PI/180, lat1=lat*Math.PI/180, lon1=lng*Math.PI/180;
  const lat2=Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(br));
  const lon2=lon1+Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(lat1), Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
  return [lat2*180/Math.PI, lon2*180/Math.PI];
}
function semiCircle(latlng, bearing, radius, side){
  let start=bearing-90, end=bearing+90;
  if(side==="√§u√üerer"){ start=bearing+90; end=bearing+270; }
  const pts=[]; for(let a=start; a<=end; a+=5) pts.push(project(latlng,a,radius)); pts.push(latlng); return pts;
}
function drawIntersectionViz({center, gurtelBearing, side, streetName, continueName, blink="before"}){
  clearViz();
  const len=240, r=140;
  const g1=project(center,gurtelBearing,len/2), g2=project(center,gurtelBearing+180,len/2);
  const s1=project(center,gurtelBearing+90,len/2), s2=project(center,gurtelBearing+270,len/2);
  const segG=L.polyline([g1,g2],{color:"#0ea5e9",weight:5}).addTo(map);
  const segS=L.polyline([s1,s2],{color:"#22c55e",weight:5, dashArray:"6,6"}).addTo(map);
  const wedge=L.polygon(semiCircle(center,gurtelBearing,r,side), {color:side==="innerer"?"#0ea5e9":"#f59e0b", weight:2, fillColor:side==="innerer"?"#38bdf8":"#fbbf24", fillOpacity:.18}).addTo(map);
  const beforeSeg=L.polyline([s1,center],{color:"#ef4444",weight:6}).addTo(map);
  const afterSeg=L.polyline([center,s2],{color:"#10b981",weight:6,opacity:0.25}).addTo(map);
  const mk=L.marker(center).addTo(map).bindPopup(`<b>${streetName}</b> ‚áÑ <b>${continueName||"‚Äî"}</b><br><span class="badge ${side==='innerer'?'badge-inner':'badge-outer'}">${side} G√ºrtel</span>`).openPopup();
  gLayer=L.layerGroup([segG,segS,wedge,beforeSeg,afterSeg,mk]).addTo(map); map.flyTo(center,17,{duration:1.0});
  const blinkTarget=(blink==="after")? afterSeg : beforeSeg; let vis=true; blinkTimer=setInterval(()=>{ vis=!vis; blinkTarget.setStyle({opacity:vis?1:0.3}); }, 550);
  return {beforeSeg, afterSeg};
}

/* ================= Geocoding (Google -> OSM) + cache ================= */
const GEO_CACHE = new Map(JSON.parse(localStorage.getItem("geo-cache")||"[]"));
function saveGeoCache(){ localStorage.setItem("geo-cache", JSON.stringify(Array.from(GEO_CACHE.entries()))); }

async function geocode(address){
  if(!address) return null;
  const citySuffix = address.match(/Wien/i) ? "" : ", Wien, √ñsterreich";
  const full = address + citySuffix;
  if(GEO_CACHE.has(full)) return GEO_CACHE.get(full);

  // 1) Google
  if(GOOGLE_MAPS_API_KEY){
    try{
      const u=`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(full)}&key=${GOOGLE_MAPS_API_KEY}`;
      const r=await fetch(u); const j=await r.json();
      if(j.status==="OK" && j.results && j.results[0]){
        const g=j.results[0].geometry.location; const c=[g.lat,g.lng];
        GEO_CACHE.set(full,c); saveGeoCache(); return c;
      }
    }catch(e){ console.warn("Google geocode fail",e); }
  }
  // 2) OSM / Nominatim
  try{
    const u=`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&addressdetails=0&q=${encodeURIComponent(full)}&email=wien-quiz@example.com`;
    const r=await fetch(u, {headers:{'Accept-Language':'de'}});
    const j=await r.json(); if(j && j[0]){ const c=[parseFloat(j[0].lat), parseFloat(j[0].lon)]; GEO_CACHE.set(full,c); saveGeoCache(); return c; }
  }catch(e){ console.warn("OSM geocode fail",e); }
  return null;
}

/* ================= Daten (–ø–∞–∫ + –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–≤–µ—Ä—Ä–∞–π–¥ –ø–æ—Å–ª–µ OCR) ================= */
const PACK_BASE = JSON.parse(document.getElementById('data-pack').textContent);
const PACK_LOCAL = JSON.parse(localStorage.getItem("pack-override")||"{}");
const PACK = {...PACK_BASE, ...PACK_LOCAL};

/* –¢–µ–º—ã –∏ ¬´–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ¬ª —á–∏—Å–ª–æ –≤–æ–ø—Ä–æ—Å–æ–≤ (–æ—Ç S.6-28) */
const THEMEN = [
  {key:"regierungs", title:"1) Regierungsgeb√§ude (Ministerien)", pages:"S.6", official:16},
  {key:"gerichte",   title:"2) Gerichtsgeb√§ude", pages:"S.6‚Äì7", official:9},
  {key:"bundespolizei", title:"3) Bundespolizeidirektion Wien (Polizeidienststellen)", pages:"S.7", official:3},
  {key:"stadtpolizei",  title:"4) Stadtpolizeikommanden / Polizeiinspektionen", pages:"S.7‚Äì10", official:31},
  {key:"post", title:"5) Post", pages:"S.6"},
  {key:"medien", title:"6) Massenmedien", pages:"S.36"},
  {key:"kammern", title:"7) Kammern", pages:"S.6"},
  {key:"bezirksaemter", title:"8) Magistratische Bezirks√§mter (Amtsh√§user)", pages:"S.8‚Äì9"},
  {key:"hotels", title:"9) Beherbergungsbetriebe (Auswahl)", pages:"S.10‚Äì13"},
  {key:"cafes", title:"10) Kaffeeh√§user", pages:"S.14"},
  {key:"heurige", title:"11) Bezirksnamen & Heurigenorte", pages:"S.15‚Äì16"},
  {key:"friedhoefe", title:"12) Friedh√∂fe", pages:"S.16‚Äì18"},
  {key:"kranken", title:"13) Krankenanstalten", pages:"S.17‚Äì19"},
  {key:"pension", title:"14) Pensionistenwohnheime", pages:"S.19"},
  {key:"kultur", title:"15) Kulturinstitute / B√ºhnenh√§user", pages:"S.19"},
  {key:"kabarett", title:"15a) Kabaretts, Volksb√ºhnen", pages:"S.19"},
  {key:"unis", title:"16) Universit√§ten / Bildungsanstalten", pages:"S.20"},
  {key:"museen", title:"17) Museen", pages:"S.20‚Äì22"},
  {key:"bauten", title:"18) Bauten, Sehensw√ºrdigkeiten, Hotels & Caf√©s", pages:"S.21‚Äì22"},
  {key:"guertel", title:"19) ‚Ä¶ nachdem Sie den G√úRTEL √ºberquert haben / G√úRTEL (Seiten)", pages:"S.23 & 27"},
  {key:"donau", title:"20) ‚Ä¶ nachdem Sie die Br√ºcke √ºber DONAUKANAL / DONAU √ºberquert haben", pages:"S.24"},
  {key:"nummern", title:"21) Nummerierungssystem", pages:"S.24"},
  {key:"strassgeo", title:"22) Stra√üengeographie (Allgemein)", pages:"S.25"},
  {key:"wichtige", title:"23) Wichtige Stra√üen und Autobahnen", pages:"S.26"},
  {key:"tarif", title:"Wiener Tarif", pages:"S.58‚Äì61"}
];

/* –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è ¬´–∏–º—ë–Ω + –∞–¥—Ä–µ—Å–æ–≤¬ª –≤ –≤–æ–ø—Ä–æ—Å—ã ¬´Wo befindet sich ‚Ä¶?¬ª */
function buildQuestionsFromPack(){
  const data={};
  for(const [key,items] of Object.entries(PACK)){
    if(["meta","guertel","tarif"].includes(key)) continue;
    if(!Array.isArray(items)) continue;
    data[key]=items.map(it=>{
      const q=`Wo befindet sich ${it.name}?`;
      // –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
      const right = it.address;
      // 3 —Å–ª—É—á–∞–π–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–∑ —Ç–æ–≥–æ –∂–µ —Ä–∞–∑–¥–µ–ª–∞
      const distractors = shuffle(items.filter(o=>o.address!==right).map(o=>o.address)).slice(0,3);
      return {name:it.name, address:it.address, question:q, options:shuffle([right,...distractors]), correct:right};
    });
  }
  // G√úRTEL ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è (–ø–∞—Ä—ã/—Å—Ç–æ—Ä–æ–Ω—ã)
  data.guertel = [
    {
      name:"Wie hei√üen die nachfolgenden Stra√üen, nachdem Sie den G√úRTEL √ºberquert haben?",
      question:"Wie hei√üt die Stra√üe weiter, nachdem Sie die Mariahilfer Stra√üe √ºber den G√úRTEL √ºberquert haben?",
      options:["Sechshauser Stra√üe","Burggasse","Thaliastra√üe","Winckelmannstra√üe"],
      correct:"Sechshauser Stra√üe",
      viz:{center:[48.19555,16.33935], gurtelBearing:45, side:"innerer", streetName:"Mariahilfer Stra√üe", continueName:"Sechshauser Stra√üe"}
    },
    {
      name:"Wie hei√üen die nachfolgenden Stra√üen, nachdem Sie den G√úRTEL √ºberquert haben?",
      question:"Wie hei√üt die Stra√üe weiter, nachdem Sie die Burggasse √ºber den G√úRTEL √ºberquert haben?",
      options:["Gablenzgasse","Thaliastra√üe","Mariahilfer Stra√üe","Winckelmannstra√üe"],
      correct:"Gablenzgasse",
      viz:{center:[48.20580,16.33890], gurtelBearing:45, side:"innerer", streetName:"Burggasse", continueName:"Gablenzgasse"}
    },
    {
      name:"G√úRTEL (Seiten)",
      question:"Ist die Kreuzung Nu√üdorfer Stra√üe √ó W√§hringer G√ºrtel am inneren oder am √§u√üeren G√ºrtel?",
      options:["innerer G√ºrtel","√§u√üerer G√ºrtel"],
      correct:"innerer G√ºrtel",
      viz:{center:[48.2332,16.3554], gurtelBearing:120, side:"innerer", streetName:"Nu√üdorfer Stra√üe", continueName:"‚Äî"}
    }
  ];
  // —Ç–∞—Ä–∏—Ñ ‚Äî Q/A
  data.tarif = (PACK.tarif||[]).map(t=>{
    const opts=shuffle([t.a,...(t.distractors||[])]).slice(0,4);
    return {name:"Fragen & Antworten Wiener Tarif", question:t.q, options:opts, correct:t.a};
  });
  return data;
}
const DATA = buildQuestionsFromPack();

/* ================= G√ºrtel Study ================= */
const GUERTEL_INTERSECTIONS = [
  { title:"Mariahilfer Stra√üe √ó Mariahilfer G√ºrtel", side:"innerer", coords:[48.19555,16.33935], bearing:45 },
  { title:"Burggasse √ó Neubaug√ºrtel",                side:"innerer", coords:[48.20580,16.33890], bearing:45 },
  { title:"Thaliastra√üe √ó Lerchenfelder G√ºrtel",     side:"innerer", coords:[48.20940,16.33670], bearing:45 },
  { title:"Hernalser Hauptstra√üe √ó Hernalser G√ºrtel",side:"innerer", coords:[48.21850,16.33260], bearing:45 },
  { title:"Nu√üdorfer Stra√üe √ó W√§hringer G√ºrtel",     side:"innerer", coords:[48.23320,16.35540], bearing:120 },
  { title:"Triester Stra√üe √ó G√ºrtel",                side:"√§u√üerer", coords:[48.17480,16.35580], bearing:30 }
];

/* ================= Quiz engine ================= */
let selected=[], pool=[], idx=0, score=0, examMode=false, officialMode=false;
let lastQuestionText="";

function availableCount(key){ return (DATA[key]||[]).length; }
function buildPool(keys){ const out=[]; keys.forEach(k=>{ if(DATA[k]) out.push(...DATA[k]); }); return shuffle(out); }

function openQuiz(){
  $("#quizPanel").style.display="block"; $("#sidebar").style.display="none";
  $("#studyPanel").style.display="none"; $("#leaderPanel").style.display="none"; $("#statsPanel").style.display="none";
}

function detectCat(q){ for(const k of Object.keys(DATA)) if(DATA[k].includes(q)) return k; return "misc"; }

async function preLocateIfAddress(q){
  if(!q.address) return;
  const coords = await geocode(q.address);
  if(!coords) return;
  cleanMarkers(); clearViz();
  preMarker = L.marker(coords, {icon:new PulseIcon()}).addTo(map);
  fly(coords, 15);
}

async function showQuestion(first=false){
  const q=pool[idx]; if(!q) return;

  // –ø–æ–ª—ë—Ç –∫ –º–µ—Å—Ç—É –î–û –≤–æ–ø—Ä–æ—Å–∞
  await preLocateIfAddress(q);

  $("#progress").textContent=`Frage ${idx+1} von ${pool.length}`;
  $("#progressFill").style.width=`${Math.round((idx)/pool.length*100)}%`;
  $("#questionText").textContent=q.question;

  const cont=$("#optionsContainer"); cont.innerHTML="";
  const options = (q.options && q.options.length) ? q.options : [q.correct];
  shuffle(options).forEach((opt,i)=>{
    const d=document.createElement("div");
    d.className="option"; d.tabIndex=0; d.dataset.correct=(opt===(q.correct||q.address));
    d.innerHTML=`<strong>${i+1}.</strong> ${opt}`; d.onclick=()=>checkAnswer(d,opt);
    d.onkeydown=(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); d.click(); } };
    cont.appendChild(d);
  });
  $("#nextBtn").style.display="none"; $("#endBtns").style.display="none";

  if(q.viz){
    const v=drawIntersectionViz(q.viz);
    q._vizSegments=v;
  }

  lastQuestionText = `${q.name||""}. ${q.question}`;
  speak(lastQuestionText, 1.0);
}

async function checkAnswer(el,opt){
  const q=pool[idx]; const right=(opt===(q.correct||q.address));
  $$("#optionsContainer .option").forEach(o=>o.onclick=null);
  el.classList.add(right?"correct":"incorrect");
  if(!right){ const r=$$("#optionsContainer .option").find(x=>x.dataset.correct==="true"); if(r) r.classList.add("correct"); }
  if(right) score++;

  // –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –∞–¥—Ä–µ—Å–∞
  try{
    if(q.address){
      const coords = await geocode(q.address);
      if(coords){
        cleanMarkers();
        answerMarker=L.marker(coords).addTo(map).bindPopup(`<b>${q.name}</b><br>${q.address}`).openPopup();
        fly(coords, 17);
      }
    }
  }catch{}

  if(q._vizSegments){
    if(blinkTimer){ clearInterval(blinkTimer); blinkTimer=null; }
    q._vizSegments.beforeSeg.setStyle({opacity:0.25});
    q._vizSegments.afterSeg.setStyle({opacity:1});
  }

  speak(right ? "Richtig. Gut gemacht." : `Leider falsch. Richtig ist: ${q.correct||q.address}.`, 1.0);
  $("#nextBtn").style.display="block";

  // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  sess.total++; if(right) sess.correct++;
  const cat=detectCat(q); if(!sess.byCat[cat]) sess.byCat[cat]={total:0,correct:0}; sess.byCat[cat].total++; if(right) sess.byCat[cat].correct++;
}

function nextQuestion(){
  idx++;
  if(idx<pool.length){ showQuestion(); }
  else{
    $("#questionText").textContent=`Fertig! Punkte: ${score}/${pool.length}`;
    $("#optionsContainer").innerHTML=""; $("#progress").textContent=""; $("#progressFill").style.width="100%";
    $("#nextBtn").style.display="none"; $("#endBtns").style.display="block"; clearViz(); cleanMarkers();
    speak(`Fertig. Punkte: ${score} von ${pool.length}.`, 1.0);
    saveSession();
  }
}
function backToMenu(){ $("#quizPanel").style.display="none"; $("#sidebar").style.display="block"; $("#endBtns").style.display="none"; clearViz(); cleanMarkers(); }
function restartQuiz(){ $("#endBtns").style.display="none"; idx=0; score=0; pool=shuffle(pool); showQuestion(true); }

async function startQuiz(mode="normal"){
  const checked=$$("#catList input[type=checkbox]:checked").map(x=>x.value);
  if(checked.length===0){ toast("Bitte Kategorie w√§hlen!"); return; }
  selected=checked; examMode=(mode==="exam"); officialMode=false;
  pool=buildPool(selected);
  if(examMode && pool.length>10) pool=pool.slice(0,10);
  idx=0; score=0; openQuiz();
  await showQuestion(true);
}

async function startOfficialBlock(){
  const checked=$$("#catList input[type=checkbox]:checked").map(x=>x.value);
  if(checked.length!==1){ toast("W√§hlen Sie genau EINEN Block (z.B. 1,2,3‚Ä¶)"); return; }
  const key=checked[0];
  const def=THEMEN.find(t=>t.key===key);
  const needed=def?.official || availableCount(key);
  const arr=(DATA[key]||[]).slice(0,needed);
  if(arr.length<needed){ toast(`Block unvollst√§ndig: ${arr.length}/${needed}. Nutzen Sie üì• OCR‚ÄëImport.`); }
  selected=[key]; officialMode=true; examMode=false;
  pool=shuffle(arr); idx=0; score=0; openQuiz();
  await showQuestion(true);
}

/* ================= G√ºrtel Study ================= */
function openStudy(){
  $("#studyPanel").style.display="block"; $("#leaderPanel").style.display="none"; $("#statsPanel").style.display="none";
  $("#sidebar").style.display="none"; $("#quizPanel").style.display="none";
  const list=$("#studyList"); list.innerHTML="";
  [
    ...GUERTEL_INTERSECTIONS
  ].forEach((g,i)=>{
    const div=document.createElement("div");
    div.style.cssText="padding:8px 10px;border-bottom:1px dashed var(--border);cursor:pointer";
    div.innerHTML=`${i+1}. ${g.title} ‚Äî <span class="badge ${g.side==='innerer'?'badge-inner':'badge-outer'}">${g.side}</span>`;
    div.onclick=()=> drawIntersectionViz({center:g.coords, gurtelBearing:g.bearing, side:g.side, streetName:g.title.split(' √ó ')[0], continueName:g.title.split(' √ó ')[1], blink:"before"});
    list.appendChild(div);
  });
  toast("–£—á–µ–±–Ω—ã–π —Ä–µ–∂–∏–º G√ºrtel –æ—Ç–∫—Ä—ã—Ç");
}

/* ================= Auth ================= */
let isReg=false, guest=false;
$("#toRegister").onclick=(e)=>{e.preventDefault();isReg=true;$("#formTitle").textContent="Register";$("#loginPass2").style.display="block";$("#submitBtn").textContent="Register";};
$("#toLogin").onclick=(e)=>{e.preventDefault();isReg=false;$("#formTitle").textContent="Login";$("#loginPass2").style.display="none";$("#submitBtn").textContent="Log in";};
$("#guestBtn").onclick=()=>{ guest=true; $("#loginModal").style.display="none"; loadCats(); loadMyStats(); loadLeaderboard(); toast("Gastmodus: Daten nur lokal"); };
$("#submitBtn").onclick=async()=>{
  const email=$("#loginEmail").value.trim(), p1=$("#loginPass").value.trim(), p2=$("#loginPass2").value.trim();
  $("#loginError").textContent="";
  try{
    if(isReg){ if(p1!==p2){ $("#loginError").textContent="Passwords do not match!"; return; } await createUserWithEmailAndPassword(auth,email,p1); toast("‚úÖ Registrierung erfolgreich"); }
    else { await signInWithEmailAndPassword(auth,email,p1); toast("‚úÖ Login erfolgreich"); }
  }catch(err){
    const code=err?.code||"";
    if(code.includes("auth/unauthorized-domain")) $("#loginError").innerHTML="‚ùó <b>auth/unauthorized-domain</b> ‚Äì –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω GitHub Pages –≤ Firebase ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains.";
    else if(code.includes("network-request-failed")) $("#loginError").textContent="‚ö†Ô∏è Netzwerkfehler. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTTPS –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.";
    else if(code.includes("user-not-found")) $("#loginError").textContent="Benutzer nicht gefunden.";
    else if(code.includes("wrong-password")) $("#loginError").textContent="Falsches Passwort.";
    else $("#loginError").textContent="‚ö†Ô∏è "+(err.message||err);
    return;
  }
};
$("#logoutBtn").onclick=()=>{ guest=false; signOut(auth); };

onAuthStateChanged(auth, async (user)=>{ if(user){ $("#loginModal").style.display="none"; toast("Willkommen!"); loadCats(); loadMyStats(); loadLeaderboard(); } else if(!guest){ $("#loginModal").style.display="flex"; } });

/* ================= Stats & Leaderboard ================= */
const sess={total:0,correct:0,byCat:{}};
function resetSess(){ sess.total=0; sess.correct=0; sess.byCat={}; }
async function saveSession(){
  if(guest){ // –ª–æ–∫–∞–ª—å–Ω–æ
    const hist = JSON.parse(localStorage.getItem("guest-sessions")||"[]");
    hist.push({ts:Date.now(), total:sess.total, correct:sess.correct, byCat:sess.byCat, cats:selected, examMode, officialMode, score, poolLen:pool.length});
    localStorage.setItem("guest-sessions", JSON.stringify(hist));
    resetSess(); loadMyStats(); loadLeaderboard(); return;
  }
  const u=auth.currentUser; if(!u) return;
  const ts=Date.now();
  await set(ref(db, `sessions/${u.uid}/${ts}`), {ts, total:sess.total, correct:sess.correct, byCat:sess.byCat, cats:selected, examMode, officialMode, score, poolLen:pool.length});
  const sref=ref(db, `stats/${u.uid}`); const snap=await get(sref);
  let agg=snap.exists()? snap.val():{total:0,correct:0,byCat:{}, last:0};
  agg.total+=sess.total; agg.correct+=sess.correct; agg.last=ts;
  for(const k of Object.keys(sess.byCat)){ if(!agg.byCat[k]) agg.byCat[k]={total:0,correct:0}; agg.byCat[k].total+=sess.byCat[k].total; agg.byCat[k].correct+=sess.byCat[k].correct; }
  await set(sref, agg);
  const acc=agg.total? Math.round(100*agg.correct/agg.total):0;
  await set(ref(db, `leaderboard/${u.uid}`), {user:u.email||u.uid, correct:agg.correct, total:agg.total, acc, last:ts});
  resetSess(); loadMyStats(); loadLeaderboard();
}
async function loadMyStats(){
  if(guest){
    const hist=JSON.parse(localStorage.getItem("guest-sessions")||"[]");
    const total=hist.reduce((s,x)=>s+x.total,0), correct=hist.reduce((s,x)=>s+x.correct,0);
    const acc=total? Math.round(100*correct/total):0;
    $("#myStats").innerHTML=`<p><b>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö:</b> ${correct} / ${total} <span class="small">(${acc}%)</span></p><p class="small">Gastmodus: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>`;
    return;
  }
  const u=auth.currentUser; if(!u){ $("#myStats").innerHTML="<p class='small'>Bitte einloggen.</p>"; return; }
  const snap=await get(ref(db,`stats/${u.uid}`)); const el=$("#myStats");
  if(!snap.exists()){ el.innerHTML="<p class='small'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É.</p>"; return; }
  const st=snap.val(); const acc=st.total? Math.round(100*st.correct/st.total):0;
  const cats=Object.entries(st.byCat||{}).map(([k,v])=>`<li>${k}: ${v.correct}/${v.total}</li>`).join("");
  el.innerHTML=`<p><b>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö:</b> ${st.correct} / ${st.total} <span class="small">(${acc}%)</span></p><ul>${cats}</ul><p class="small">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(st.last).toLocaleString()}</p>`;
}
async function loadLeaderboard(){
  if(guest){ $("#leaderList").innerHTML="<p class='small'>–õ–∏–¥–µ—Ä–±–æ—Ä–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞.</p>"; return; }
  const snap=await get(ref(db,'leaderboard')); const el=$("#leaderList"); el.innerHTML="";
  if(!snap.exists()){ el.innerHTML="<p class='small'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</p>"; return; }
  const items=Object.values(snap.val()); items.sort((a,b)=> b.correct-a.correct || a.last-b.last);
  const me=auth.currentUser?(auth.currentUser.email||auth.currentUser.uid):"";
  items.slice(0,30).forEach((it,i)=>{ const row=document.createElement("div"); row.style.cssText="display:flex;justify-content:space-between;padding:8px 10px;border-bottom:1px dashed var(--border);"+(it.user===me?" background:rgba(37,99,235,.08);border-radius:8px;":""); row.innerHTML=`<div>#${i+1} <b>${it.user}</b></div><div>${it.correct}/${it.total} <span class="small">(${it.acc}%)</span></div>`; el.appendChild(row); });
}

/* ================= TTS ================= */
let ttsOn=true; const audioEl=new Audio(); audioEl.volume=1;
let queue=[], playing=false, pendingRate=1.0;
function speak(text, rate=1.0){
  if(!ttsOn || !text) return;
  const parts=text.replace(/\s+/g," ").split(/(?<=[\.\!\?])/g).map(s=>s.trim()).filter(Boolean);
  queue.push(...parts); pendingRate=rate; if(!playing) nextSpeak();
}
async function nextSpeak(){
  if(queue.length===0){ playing=false; return; }
  playing=true; const part=queue.shift();
  try{
    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVEN_VOICE_ID}?optimize_streaming_latency=3`,{
      method:"POST", headers:{ "xi-api-key": ELEVEN_API_KEY, "Content-Type":"application/json", "Accept":"audio/mpeg" },
      body: JSON.stringify({ text: part, model_id:"eleven_multilingual_v2", voice_settings:{ stability:0.4, similarity_boost:0.8, style:0, use_speaker_boost:true } })
    });
    const blob=await res.blob(); audioEl.src=URL.createObjectURL(blob); audioEl.playbackRate=pendingRate; await audioEl.play(); audioEl.onended=()=> nextSpeak();
  }catch(e){ console.warn("TTS error",e); playing=false; }
}
function stopSpeak(){ try{ audioEl.pause(); audioEl.currentTime=0; }catch{} queue=[]; playing=false; }
$("#replayBtn").onclick = ()=>{ stopSpeak(); speak(lastQuestionText, 1.0); };
$("#replaySlowBtn").onclick = ()=>{ stopSpeak(); speak(lastQuestionText, 0.6); };

/* ================= OCR‚Äë–∏–º–ø–æ—Ä—Ç –∏–∑ kurs.pdf (100% –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ) ================= */
const OCR = {
  pages:[6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28], // —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é I. ORTSKUNDE
  async run(){
    const overlay=document.getElementById('ocrOverlay'); overlay.style.display="flex";
    const bar=overlay.querySelector('#ocrBar>div'); const label=overlay.querySelector('#ocrLabel');
    const pack = {...PACK}; // —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    // –∑–∞–≥—Ä—É–∑–∫–∞ PDF
    let pdf; try{ pdf=await pdfjsLib.getDocument('kurs.pdf').promise; }catch{ label.textContent="–ù–µ –Ω–∞—à—ë–ª kurs.pdf (–ø–æ–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª –≤ –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞)."; return; }
    let done=0, total=OCR.pages.length;
    for(const p of OCR.pages){
      label.textContent=`–ß—Ç–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${p}‚Ä¶`; 
      const page=await pdf.getPage(p);
      const viewport=page.getViewport({scale:2});
      const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
      canvas.width=viewport.width; canvas.height=viewport.height;
      await page.render({canvasContext:ctx, viewport}).promise;
      // OCR
      label.textContent=`OCR ${p}‚Ä¶`; 
      const result=await Tesseract.recognize(canvas, 'deu+eng', { logger:m=>{ if(m.progress) bar.style.width=(100*(done/total + m.progress/total))+"%"; }});
      let text=result.data.text.replace(/\r/g,"").split('\n').map(s=>s.trim()).filter(Boolean);
      // –ø—Ä–æ—Å—Ç—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ ¬´–Ω–∞–∑–≤–∞–Ω–∏–µ ‚Äî –∞–¥—Ä–µ—Å¬ª:
      function pushPair(dst,name,addr){ if(!name||!addr) return; if(!pack[dst]) pack[dst]=[]; if(!pack[dst].some(x=>x.name===name)){ pack[dst].push({name, address:addr}); } }
      function parsePairs(dst, lines){
        lines.forEach(line=>{
          // –∏—â–µ–º –∞–¥—Ä–µ—Å–Ω—ã–µ —Å–ª–æ–≤–∞
          const m=line.match(/(.+?)\s{2,}(.+?(stra√üe|gasse|platz|ring|kai|markt|allee|l√§nde|ufer|kai|Objekt|Tor)\s*[\w\s\-\./]*\d*.*)$/i);
          if(m){ pushPair(dst, m[1].replace(/\s{2,}/g,' ').trim(), m[2].trim()); }
        });
      }
      const pageTxt = text.join(' ');
      // –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
      if(/REGIERUNGSGEB√ÑUDE|Ministerien/i.test(pageTxt)) parsePairs('regierungs', text);
      if(/GERICHTSGEB√ÑUDE/i.test(pageTxt))             parsePairs('gerichte', text);
      if(/BUNDESPOLIZEIDIREKTION/i.test(pageTxt))      parsePairs('bundespolizei', text);
      if(/STADTPOLIZEIKOMMANDEN|POLIZEIINSPEKTIONEN/i.test(pageTxt)) parsePairs('stadtpolizei', text);
      if(/MAGISTRATISCHE BEZIRKS√ÑMTER|AMTSH√ÑUSER/i.test(pageTxt))    parsePairs('bezirksaemter', text);
      if(/BEHERBERGUNGSBETRIEBE/i.test(pageTxt))       parsePairs('hotels', text);
      if(/KAFFEEH√ÑUSER|KAFFEEHAEUSER/i.test(pageTxt))  parsePairs('cafes', text);
      if(/FRIEDH√ñFE|FRIEDHOEFE/i.test(pageTxt))        parsePairs('friedhoefe', text);
      if(/KRANKENANSTALTEN/i.test(pageTxt))            parsePairs('kranken', text);
      if(/PENSIONISTENWOHNHEIME/i.test(pageTxt))       parsePairs('pension', text);
      if(/KULTURINSTITUTE|B√úHNENH√ÑUSER|BUEHNENHAEUSER/i.test(pageTxt)) parsePairs('kultur', text);
      if(/KABARETTS|VOLKSB√úHNEN|VOLKSBUEHNEN/i.test(pageTxt)) parsePairs('kabarett', text);
      if(/UNIVERSIT√ÑTEN|BILDUNGSANSTALTEN|UNIVERSITAETEN/i.test(pageTxt)) parsePairs('unis', text);
      if(/MUSEEN/i.test(pageTxt))                      parsePairs('museen', text);
      if(/BAUTEN|SEHENSW√úRDIGKEITEN/i.test(pageTxt))   parsePairs('bauten', text);
      if(/WICHTIGE STRA√üEN|AUTBAHNEN|RINGSTRASSE/i.test(pageTxt)) parsePairs('wichtige', text);
      if(/NUMMERIERUNG/i.test(pageTxt))                pack.nummern = pack.nummern||[{name:"Nummerierungssystem in Wien", address:"Gerade links/ungerade rechts ‚Äì vom Zentrum aus"}];
      if(/STRASSENGEOGRAPHIE|STRASSEN-GEOGRAPHIE/i.test(pageTxt)) pack.strassgeo = pack.strassgeo||[{name:"Stra√üengeographie (Allgemein)", address:"Gem√§√ü S.25 ‚Äì Knoten/Verteiler nach Tabelle"}];
      done++;
      bar.style.width=(100*done/total)+"%";
    }
    // –°–æ—Ö—Ä–∞–Ω–∏–º –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –¥–∞—Ç–∞—Å–µ—Ç
    localStorage.setItem("pack-override", JSON.stringify(pack));
    overlay.style.display="none";
    toast("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.");
    // –ü–µ—Ä–µ—Å–æ–±–µ—Ä—ë–º DATA/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    location.reload();
  }
};
document.body.insertAdjacentHTML('beforeend', `
  <div id="ocrOverlay">
    <div id="ocrLabel" style="font-weight:800">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶</div>
    <div id="ocrBar"><div></div></div>
    <div class="small">–ò—Å—Ç–æ—á–Ω–∏–∫: I. ORTSKUNDE (S.6‚Äì28) –∏–∑ kurs.pdf. :contentReference[oaicite:3]{index=3}</div>
  </div>
`);

/* ================= UI ================= */
function loadCats(){
  const wrap=$("#catList"); wrap.innerHTML="";
  THEMEN.forEach(t=>{
    const have=availableCount(t.key); const need=t.official||have;
    const div=document.createElement("label"); div.className="cat";
    div.innerHTML=`<input type="checkbox" value="${t.key}"> <div>${t.title} <span class="small">(${t.pages})</span></div> <span class="meta">${have}/${need}</span>`;
    wrap.appendChild(div);
  });
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∏–º –∫–ª—é—á–µ–≤—ã–µ –±–ª–æ–∫–∏
  $$("#catList input[type=checkbox]").forEach(cb=>{ if(["regierungs","gerichte","bundespolizei","museen","unis","cafes","friedhoefe","hotels","guertel"].includes(cb.value)) cb.checked=true; });
}

// –∫–Ω–æ–ø–∫–∏
$("#menuBtn").onclick = ()=>{ const s=$("#sidebar"); s.style.display=(s.style.display==="block"?"none":"block"); };
$("#startBtn").onclick = ()=>{ resetSess(); startQuiz("normal"); };
$("#examBtn").onclick  = ()=>{ resetSess(); startQuiz("exam"); };
$("#officialBtn").onclick = ()=>{ resetSess(); startOfficialBlock(); };

$("#nextBtn").onclick  = nextQuestion;
$("#againBtn").onclick = restartQuiz;
$("#backBtn").onclick  = backToMenu;
$("#studyBtn").onclick = openStudy;
$("#leaderBtn").onclick= ()=>{ $("#leaderPanel").style.display="block"; $("#studyPanel").style.display="none"; $("#statsPanel").style.display="none"; $("#sidebar").style.display="none"; $("#quizPanel").style.display="none"; loadLeaderboard(); };
$("#statsBtn").onclick = ()=>{ $("#statsPanel").style.display="block"; $("#leaderPanel").style.display="none"; $("#studyPanel").style.display="none"; $("#sidebar").style.display="none"; $("#quizPanel").style.display="none"; loadMyStats(); };
$("#ttsToggleBtn").onclick = ()=>{ ttsOn=!ttsOn; toast(ttsOn?"üîä –û–∑–≤—É—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞":"üîá –û–∑–≤—É—á–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞"); if(!ttsOn) stopSpeak(); };
$("#importBtn").onclick = ()=>{ OCR.run(); };

document.addEventListener("keydown",(e)=>{
  if($("#quizPanel").style.display!=="block") return;
  const i=["1","2","3","4","5","6"].indexOf(e.key);
  if(i>=0){ const opt=$$("#optionsContainer .option")[i]; if(opt && opt.onclick) opt.click(); }
  if(e.key==="Enter" && $("#nextBtn").style.display==="block") nextQuestion();
});

window.addEventListener("load", ()=>{ toast("Bereit. Melden Sie sich an (oder Gastmodus)."); loadCats(); });
</script>
</body>
</html>
