<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wiener Taxi Pr√ºfungsassistent</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --brand:#2563eb; --brand-2:#60a5fa; --ok:#16a34a; --err:#dc2626; --warn:#f59e0b;
  --bg:#ffffff; --panel:#ffffff; --text:#0f172a; --muted:#6b7280;
  --chip:#f8fafc; --border:#e5e7eb; --shadow:0 10px 30px rgba(2,6,23,.15); --radius:14px;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1020; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --chip:#0b1225; --border:#1f2937; --shadow:0 10px 40px rgba(0,0,0,.45); }
}
*{ box-sizing:border-box } html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,sans-serif; }
#map{ position:fixed; inset:0; z-index:1; }

/* topbar - –£–ë–ò–†–ê–ï–ú –ö–ù–û–ü–ö–£ THEMEN –û–¢–°–Æ–î–ê */
.topbar{
  position:fixed;
  top:12px;
  left:12px;
  right:12px;
  display:flex;
  justify-content:flex-end; /* –¢–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏ —Å–ø—Ä–∞–≤–∞ */
  gap:8px;
  z-index:1500;
}

.btn{ pointer-events:auto; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); box-shadow:var(--shadow); }
.btn.secondary{ background:#334155; }
.iconbtn{ pointer-events:auto; border:none; border-radius:10px; padding:10px 12px; background:#111827; color:#fff; opacity:.95; cursor:pointer; }
.spacer{ flex:1 }

/* sidebar - –î–û–ë–ê–í–õ–Ø–ï–ú –ö–ù–û–ü–ö–£ MENU –°–õ–ï–í–ê */
.sidebar-toggle{
  position:fixed;
  top:12px;
  left:12px;
  z-index:1600;
}
.sidebar{ position:fixed; top:64px; left:12px; z-index:1000; width:420px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); display:none; }
.sidebar h3{ margin:0 0 8px 0; }
.cat{ display:flex; align-items:center; gap:8px; padding:8px; margin:8px 0; background:var(--chip); border-left:4px solid var(--brand); border-radius:10px; }
.cat .meta{ margin-left:auto; font-size:12px; color:var(--muted); }
.small{ font-size:12px; color:var(--muted); }
hr{ border:none; border-top:1px solid var(--border); margin:10px 0; }

/* quiz */
.quiz-panel{ position:fixed; top:64px; right:12px; z-index:1000; width:500px; max-height:78vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:none; }
.question{ font-weight:800; margin:8px 0 10px; text-align:center; }
.progress{ text-align:center; font-size:13px; color:var(--muted); }
.progressbar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px 0 12px; }
.progressbar-fill{ height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0%; transition:width .25s ease; }
.options{ display:grid; gap:8px; }
.option{ padding:12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:transparent; }
.option:hover{ border-color:var(--brand); background:rgba(37,99,235,.07); }
.option.correct{ border-color:var(--ok); background:#f0fdf4; }
.option.incorrect{ border-color:var(--err); background:#fef2f2; }
.replay-row{ display:flex; gap:8px; justify-content:center; margin:6px 0 4px; }
.next-btn,.end-btn{ margin-top:10px; width:100%; font-weight:800; border:none; border-radius:10px; padding:10px 14px; color:white; background:linear-gradient(180deg,var(--brand),#1e40af); cursor:pointer; }
.end-btn.secondary{ background:#334155; }

/* voice button */
.voice-btn{ background:linear-gradient(180deg,#8b5cf6,#7c3aed) !important; }
.voice-listening{ background:linear-gradient(180deg,#dc2626,#b91c1c) !important; animation:pulse 1.5s infinite; }
@keyframes pulse{ 0%{ opacity:1; } 50%{ opacity:0.7; } 100%{ opacity:1; } }

/* Marker icons */
.leaflet-div-icon { background: transparent; border: none; }
.mk{ width:26px; height:26px; border-radius:50%; display:grid; place-items:center; color:#fff; font-weight:900; font-size:14px; box-shadow:0 2px 10px rgba(0,0,0,.35); border:2px solid rgba(255,255,255,.9); }
.mk.blue{ background:#2563eb; }
.mk.green{ background:#16a34a; }
.mk.red{ background:#dc2626; }
.mk.pulse{ box-shadow:0 0 0 0 rgba(37,99,235,.45); animation:mkpulse 1.4s infinite; }
@keyframes mkpulse{ 0%{ box-shadow:0 0 0 0 rgba(37,99,235,.45);} 70%{ box-shadow:0 0 0 16px rgba(37,99,235,0);} 100%{ box-shadow:0 0 0 0 rgba(37,99,235,0);} }

/* map popup */
.answer-popup { font-weight: bold; color: #1e40af; }
</style>
</head>
<body>

<div id="map"></div>

<!-- –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é —Å–ª–µ–≤–∞ –æ—Ç–¥–µ–ª—å–Ω–æ -->
<div class="sidebar-toggle">
  <button class="btn" id="menuBtn">‚ò∞ Men√º</button>
</div>

<!-- –ò–∫–æ–Ω–∫–∏ —Å–ø—Ä–∞–≤–∞ -->
<div class="topbar">
  <button class="iconbtn" id="voiceModeBtn" title="Sprachmodus">üéôÔ∏è</button>
  <button class="iconbtn" id="ttsToggleBtn" title="Sprachausgabe ein/aus">üîä</button>
</div>

<div class="sidebar" id="sidebar">
  <h3>üóÇÔ∏è Wiener Taxi Pr√ºfungsassistent</h3>
  <div style="text-align:center; margin:10px 0;">
    <button class="btn voice-btn" id="voiceQuizBtn">üéôÔ∏è Sprachpr√ºfung</button>
  </div>
  <div id="catList"></div>
  <hr/>
  <button id="startBtn" class="btn" style="width:100%;margin-top:6px;">‚ñ∂Ô∏è Freies Quiz</button>
  <button id="examBtn" class="btn secondary" style="width:100%;margin-top:8px;">üìù Pr√ºfungsmodus (10 Fragen)</button>
  <button id="officialBtn" class="btn secondary" style="width:100%;margin-top:8px;">‚úÖ Amtlicher Block starten</button>
  <p class="small" style="margin-top:8px">Tastatur: <b>1..6</b> f√ºr Antworten, <b>Enter</b> = Weiter.</p>
</div>

<div class="quiz-panel" id="quizPanel" aria-live="polite">
  <div class="progress" id="progress"></div>
  <div class="progressbar"><div class="progressbar-fill" id="progressFill"></div></div>

  <div class="question" id="questionText"></div>

  <div class="replay-row">
    <button class="btn secondary" id="replayBtn" title="Frage wiederholen">üîÅ Wiederholen</button>
    <button class="btn secondary" id="replaySlowBtn" title="Frage langsamer wiederholen">üê¢ Langsamer</button>
    <button class="btn voice-btn" id="voiceBtn">üé§ Sprachantwort</button>
  </div>
  
  <div class="small" style="text-align:center;margin-top:-6px;margin-bottom:6px;">Sagen Sie die Antwortnummer (1,2,3,4) oder Stra√üenname</div>

  <div class="options" id="optionsContainer"></div>
  <button class="next-btn" id="nextBtn" style="display:none;">Weiter ‚Üí</button>
  <div id="endBtns" style="display:none;">
    <button class="end-btn" id="againBtn">üîÑ Nochmal spielen</button>
    <button class="end-btn secondary" id="backBtn">üìñ Zur√ºck</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- ====== VOLLST√ÑNDIGER DATENPAKET MIT ALLEN FRAGEN ====== -->
<script type="application/json" id="data-pack">
{
  "1_regierungs": [
    {"name":"Parlament (Nationalrat und Bundesrat)","address":"Dr.-Karl-Renner-Ring 3","coords":[48.207989,16.359167]},
    {"name":"Bundespr√§sident (Pr√§sidentschaftskanzlei)","address":"Ballhausplatz 1","coords":[48.208025,16.364581]},
    {"name":"Bundeskanzleramt","address":"Ballhausplatz 2","coords":[48.208386,16.363781]},
    {"name":"Bundesministerium f√ºr Inneres","address":"Herrengasse 7","coords":[48.209108,16.365931]},
    {"name":"Bundesministerium f√ºr Europ√§ische und Internationale Angelegenheiten","address":"Minoritenplatz 8","coords":[48.209347,16.364694]},
    {"name":"Bundesministerium f√ºr Bildung, Wissenschaft und Forschung","address":"Minoritenplatz 5","coords":[48.209945,16.363575]},
    {"name":"Bundesministerium f√ºr Digitalisierung und Wirtschaftsstandort","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Arbeit","address":"Taborstra√üe 1-3","coords":[48.212990,16.379061]},
    {"name":"Bundesministerium f√ºr Finanzen","address":"Johannesgasse 5","coords":[48.205108,16.372069]},
    {"name":"Bundesministerium f√ºr Klimaschutz, Umwelt, Energie, Mobilit√§t, Innovation und Technologie","address":"Radetzkystra√üe 2","coords":[48.211219,16.386589]},
    {"name":"Bundesministerium f√ºr Kunst, Kultur, √∂ffentlichen Dienst und Sport","address":"Radetzkystra√üe 2","coords":[48.211219,16.386589]},
    {"name":"Bundesministerium f√ºr Landwirtschaft, Regionen und Tourismus","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Soziales, Gesundheit, Pflege und Konsumentenschutz","address":"Stubenring 1","coords":[48.209917,16.382947]},
    {"name":"Bundesministerium f√ºr Justiz","address":"Museumstra√üe 7","coords":[48.205833,16.355278]},
    {"name":"Bundesministerium f√ºr Landesverteidigung","address":"Ro√üauer L√§nde 1","coords":[48.218186,16.367650]},
    {"name":"Landesregierung und B√ºrgermeister/Landeshauptmann (Rathaus)","address":"Rathausplatz 1","coords":[48.210800,16.357400]}
  ],

  "2_gerichte": [
    {"name":"Verfassungsgerichtshof","address":"Freyung 8","coords":[48.211478,16.366125]},
    {"name":"Verwaltungsgerichtshof","address":"Judenplatz 11","coords":[48.211600,16.370111]},
    {"name":"Oberster Gerichtshof","address":"Schmerlingplatz 10-11","coords":[48.206450,16.357230]},
    {"name":"Oberlandesgericht Wien","address":"Schmerlingplatz 10-11","coords":[48.206450,16.357230]},
    {"name":"Landesgericht f√ºr Zivilrechtssachen Wien","address":"Schmerlingplatz 10-11","coords":[48.206710,16.357590]},
    {"name":"Landesgericht f√ºr Strafsachen","address":"Landesgerichtsstra√üe 11","coords":[48.213820,16.354970]},
    {"name":"Justizanstalt Wien Josefstadt","address":"Wickenburggasse 18-20","coords":[48.213727,16.354119]},
    {"name":"Rechnungshof","address":"Dampfschiffstra√üe 2","coords":[48.212610,16.388150]}
  ],

  "3_polizei": [
    {"name":"Bundespolizeidirektion Wien - Sicherheitsdirektion","address":"Schottenring 7-9","coords":[48.2175,16.3736]},
    {"name":"Verkehrsamt (F√ºhrerschein/Taxireferat)","address":"Dietrichgasse 27","coords":[48.2028,16.3917]},
    {"name":"Fremdenpolizeiliches B√ºro","address":"Hernalser G√ºrtel 6-12","coords":[48.2167,16.3333]}
  ],

  "4_stadtpolizei": [
    {"name":"Polizeikommando Innere Stadt","address":"Deutschmeisterplatz 3","coords":[48.2122,16.3694]},
    {"name":"Polizeikommando Landstra√üe","address":"Juchgasse 19","coords":[48.2025,16.3911]},
    {"name":"Polizeikommando Margareten","address":"Viktor Christ-Gasse 19","coords":[48.1886,16.3564]},
    {"name":"Polizeikommando Josefstadt","address":"Fuhrmannsgasse 5","coords":[48.2131,16.3486]},
    {"name":"Polizeikommando Favoriten","address":"Van der N√ºll-Gasse 11","coords":[48.1703,16.3697]},
    {"name":"Polizeikommando Simmering","address":"Enkplatz 3","coords":[48.1742,16.4181]},
    {"name":"Polizeikommando Meidling","address":"Hohenbergstra√üe 1","coords":[48.1833,16.3333]},
    {"name":"Polizeikommando F√ºnfhaus","address":"Tannengasse 6","coords":[48.2000,16.3333]},
    {"name":"Polizeikommando Ottakring","address":"Wattgasse 15","coords":[48.2167,16.3167]},
    {"name":"Polizeikommando D√∂bling","address":"Hohe Warte 32","coords":[48.2500,16.3500]},
    {"name":"Polizeikommando Brigittenau","address":"Pappenheimgasse 33","coords":[48.2333,16.3667]},
    {"name":"Polizeikommando Floridsdorf","address":"Hermann Bahr-Stra√üe 3","coords":[48.2667,16.4000]},
    {"name":"Polizeikommando Donaustadt","address":"Wagramer Stra√üe 89","coords":[48.2333,16.4500]},
    {"name":"Polizeikommando Liesing","address":"Lehmanngasse 3a","coords":[48.1333,16.2833]}
  ],

  "II_betriebsordnung": [
    {"q":"Welche Personen d√ºrfen im Fahrdienst t√§tig sein?","a":"Nur vertrauensw√ºrdige Personen"},
    {"q":"Wem ist der Taxilenkerausweis auf Verlangen zur √úberpr√ºfung auszuh√§ndigen?","a":"Organen des √∂ffentlichen Sicherheitsdienstes"},
    {"q":"Wie verhalten Sie sich, wenn Sie den Taxilenkerausweis verloren haben?","a":"Unverz√ºglich Verlustanzeige machen"},
    {"q":"Wer hat den Taxilenkerausweis auszustellen?","a":"Die zust√§ndige Beh√∂rde"},
    {"q":"Unter welchen Voraussetzungen ist es dem Lenker untersagt, ein Fahrzeug zu lenken?","a":"Bei Alkoholisierung, M√ºdigkeit oder Einnahme von Medikamenten"},
    {"q":"Wie hat sich der Taxilenker im Fahrdienst zu verhalten?","a":"Besonnen, r√ºcksichtsvoll, h√∂flich und hilfsbereit"},
    {"q":"Was haben Sie als Taxilenker nach Dienstende zu tun?","a":"Pr√ºfen ob Gegenst√§nde im Fahrzeug zur√ºckgeblieben sind"},
    {"q":"Was ist Fahrg√§sten bei Taxifahrten untersagt?","a":"Den Lenker behindern, T√ºren eigenm√§chtig √∂ffnen, rauchen"},
    {"q":"Was verstehen Sie unter Bef√∂rderungspflicht?","a":"Die Pflicht, grunds√§tzlich jeden Fahrgast innerhalb Wiens zu bef√∂rdern"},
    {"q":"Welche Personen k√∂nnen Sie von der Bef√∂rderung ausschlie√üen?","a":"Personen die Sicherheit gef√§hrden, Betrunkene, Personen mit ansteckenden Krankheiten"},
    {"q":"Welche Hunde m√ºssen bef√∂rdert werden?","a":"Alle Hunde, wenn sie nicht aggressiv oder stark verschmutzt sind"},
    {"q":"M√ºssen Assistenzhunde einen Maulkorb tragen?","a":"Nein"},
    {"q":"Wie lang muss ein Taxi-KFZ mindestens sein?","a":"4,2 Meter"},
    {"q":"Welche Unterlagen m√ºssen mitgef√ºhrt werden?","a":"Wiener Landesbetriebsordnung, Gewerberegisterauszug, Taxitarif"},
    {"q":"Wie viel Wechselgeld m√ºssen Sie mit sich f√ºhren?","a":"Ausreichend f√ºr einen 50-Euro-Schein"},
    {"q":"Wann darf die Taxileuchte nicht beleuchtet sein?","a":"Wenn Fahrg√§ste bef√∂rdert werden oder bei bestellten Fahrten"},
    {"q":"Wo d√ºrfen Sie Fahrg√§ste aufnehmen?","a":"Auf Taxistandpl√§tzen, bei Bestellungen, an der Bestelladresse"},
    {"q":"D√ºrfen Sie mit Ihrem Taxi umherfahren, um Fahrg√§ste zu gewinnen?","a":"Nein"},
    {"q":"Wie haben sich Taxis auf den Standpl√§tzen aufzustellen?","a":"Nach der Zeit ihrer Ankunft einreihen und platzsparend aufstellen"},
    {"q":"Wer darf das Standplatztelefon bedienen?","a":"Der Lenker des ersten Taxis"}
  ],

  "III_tarif": [
    {"q":"Wie hoch ist die Grundtaxe am Tag?","a":"3,80 ‚Ç¨"},
    {"q":"Wie hoch ist die Grundtaxe in der Nacht / an Sonn- und Feiertagen?","a":"4,30 ‚Ç¨"},
    {"q":"Wie hoch ist die Zeittaxe f√ºr eine Stunde Wartezeit?","a":"34,80 ‚Ç¨"},
    {"q":"Der Nachtzuschlag gilt von ‚Ä¶ bis ‚Ä¶ Uhr.","a":"23:00‚Äì06:00"},
    {"q":"Wie hoch ist die Streckentaxe f√ºr die ersten 5 Kilometer am Tag?","a":"0,95 Cent pro 210,53 Meter"},
    {"q":"Wie hoch ist die Streckentaxe ab dem 5. Kilometer am Tag?","a":"0,58 Cent pro 344,83 Meter"},
    {"q":"Wie hoch ist ein Zuschlag f√ºr bestellte Fahrten?","a":"2 Euro"},
    {"q":"Wer verordnet den Wiener Taxitarif?","a":"Der Landeshauptmann (B√ºrgermeister)"},
    {"q":"Wo verliert der Wiener Taxitarif seine G√ºltigkeit?","a":"Ab der Ortsgrenze"},
    {"q":"Wie werden Botenfahrten verrechnet?","a":"Freie Vereinbarung oder laut Taxameter"},
    {"q":"Welchen Steuersatz enth√§lt eine Botenfahrt?","a":"20% MwSt"},
    {"q":"Wie hoch ist der Zuschlag bei der Bef√∂rderung von mehr als 4 Personen?","a":"2 Euro"},
    {"q":"Was tun bei Versagen des Fahrpreisanzeigers w√§hrend der Fahrt?","a":"Fahrgast sofort informieren, Fahrt fortsetzen, Preis basierend auf Tarif berechnen"},
    {"q":"In welcher Zeitspanne gilt der Sonn- und Feiertagstarif?","a":"0:00 bis 24:00 Uhr"},
    {"q":"Was sind bestellte Fahrten?","a":"Fahrten die im Voraus √ºber Standplatztelefon, App oder andere Kommunikationsdienste gebucht werden"}
  ],

  "IV_strassenverkehr": [
    {"q":"D√ºrfen Taxis durch Wohnstra√üen durchfahren?","a":"Nein, nur zu- und abfahren in Schrittgeschwindigkeit"},
    {"q":"Was ist ein Einsatzfahrzeug?","a":"Fahrzeug mit Blaulicht und Folgetonhorn"},
    {"q":"Wie verhalten Sie sich gegen√ºber einem Einsatzfahrzeug?","a":"Platz machen f√ºr Durchfahrt"},
    {"q":"Was verstehen Sie unter Halten?","a":"Abstellen eines Fahrzeuges f√ºr maximal 10 Minuten"},
    {"q":"Was verstehen Sie unter Parken?","a":"Halten eines Fahrzeuges l√§nger als 10 Minuten"},
    {"q":"Wann gilt der Lenker eines PKW als alkoholbeeintr√§chtigt?","a":"Bei 0,5 Promille Blutalkohol (f√ºr Taxifahrer 0,1 Promille)"},
    {"q":"D√ºrfen Sie auf einer Vorrangstra√üe im Ortsgebiet links zufahren?","a":"Nein, au√üer in Einbahnstra√üen"},
    {"q":"Was verstehen Sie unter dem Rei√üverschlusssystem?","a":"Wechselseitiges Einordnen lassen von Fahrzeugen an Engstellen"},
    {"q":"D√ºrfen Sie auf einem ungeregelten Schutzweg √ºberholen?","a":"Nein"},
    {"q":"Wie verhalten Sie sich vor einem Schutzweg?","a":"Geschwindigkeit so w√§hlen, dass rechtzeitig angehalten werden kann"},
    {"q":"Was bedeutet gelbes blinkendes Licht?","a":"Vorsicht"},
    {"q":"D√ºrfen Taxis in Begegnungszonen einfahren?","a":"Ja"},
    {"q":"D√ºrfen Sie die Rettungsgasse benutzen?","a":"Nein"},
    {"q":"Was ist eine Rettungsgasse?","a":"Durchg√§ngige Fahrm√∂glichkeit f√ºr Notfallfahrzeuge auf Autobahnen"},
    {"q":"Wo muss eine Rettungsgasse gebildet werden?","a":"Auf Autobahnen und Schnellstra√üen bei Stau"},
    {"q":"Was ist der Vertrauensgrundsatz?","a":"Dass jeder Stra√üenben√ºtzer darauf vertrauen darf, dass andere die Rechtsvorschriften befolgen"},
    {"q":"Welche Personen sind vom Vertrauensgrundsatz ausgenommen?","a":"Kinder, Seh- oder H√∂rbehinderte, offensichtlich Gebrechliche"},
    {"q":"Wie verhalten Sie sich beim Ausparken bei Besch√§digung eines anderen KFZ?","a":"Polizei unverz√ºglich verst√§ndigen (Selbstanzeige)"},
    {"q":"D√ºrfen Sie einen Mopedfahrer auf einer Eisenbahnkreuzung √ºberholen?","a":"Nein"},
    {"q":"Was verstehen Sie unter der freien Wahl des Fahrstreifens?","a":"Im Ortsgebiet bei mindestens zwei Fahrstreifen darf man den Fahrstreifen frei w√§hlen"}
  ],

  "19_guertel": [
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Mariahilfer Stra√üe √ºber den G√úRTEL √ºberquert haben?","options":["Sechshauser Stra√üe","Burggasse","Thaliastra√üe","Winckelmannstra√üe"],"correct":"Sechshauser Stra√üe"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Burggasse √ºber den G√úRTEL √ºberquert haben?","options":["Gablenzgasse","Thaliastra√üe","Mariahilfer Stra√üe","Winckelmannstra√üe"],"correct":"Gablenzgasse"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Neustiftgasse √ºber den G√úRTEL √ºberquert haben?","options":["Koppstra√üe","Thaliastra√üe","Burggasse","Winckelmannstra√üe"],"correct":"Koppstra√üe"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Josefst√§dter Stra√üe √ºber den G√úRTEL √ºberquert haben?","options":["Neulerchenfelder Stra√üe","Thaliastra√üe","Burggasse","Lerchenfelder Stra√üe"],"correct":"Neulerchenfelder Stra√üe"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Alser Stra√üe √ºber den G√úRTEL √ºberquert haben?","options":["Ottakringer Stra√üe","Thaliastra√üe","Burggasse","Lerchenfelder Stra√üe"],"correct":"Ottakringer Stra√üe"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die W√§hringer Stra√üe √ºber den G√úRTEL √ºberquert haben?","options":["Gentzgasse","Thaliastra√üe","Burggasse","Lerchenfelder Stra√üe"],"correct":"Gentzgasse"},
    {"name":"G√ºrtel Kreuzungen","question":"Wie hei√üt die Stra√üe weiter, nachdem Sie die Nu√üdorfer Stra√üe √ºber den G√úRTEL √ºberquert haben?","options":["D√∂blinger Hauptstra√üe","Thaliastra√üe","Burggasse","Lerchenfelder Stra√üe"],"correct":"D√∂blinger Hauptstra√üe"}
  ]
}
</script>

<script>
// ================= –û–°–ù–û–í–ù–û–ô –ö–û–î =================
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toast = (m,ms=1900)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); };
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]] } return x; }

// ================= KARTE =================
let map=null;
try{
  if(window.L){
    map = L.map('map',{zoomControl:true}).setView([48.2082,16.3738],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'¬© OpenStreetMap' }).addTo(map);
  }
} catch(e){}
let currentMarker = null;

function icon(status='blue', pulse=false){
  const sym = status==='green'?'‚úì':status==='red'?'‚úó':'‚Ä¢';
  const cls = `mk ${status==='green'?'green':status==='red'?'red':'blue'} ${pulse?'pulse':''}`;
  return (window.L && L.divIcon) ? L.divIcon({className:'', html:`<div class="${cls}">${sym}</div>`, iconSize:[26,26], iconAnchor:[13,13]}) : null;
}

function fly([lat,lng], zoom=16){ 
    if(!map) return; 
    map.flyTo([lat,lng], zoom, {duration:1.0}); 
}

function clearMap() {
    if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
    }
}

function showLocationOnMap(coords, name, address, status = 'blue') {
    clearMap();
    
    if (!coords) return;
    
    currentMarker = L.marker(coords, {icon: icon(status, true)}).addTo(map);
    
    const popupContent = `<div class="answer-popup"><b>${name}</b><br>${address}</div>`;
    currentMarker.bindPopup(popupContent).openPopup();
    
    fly(coords, 16);
}

function updateMarkerStatus(status, correctAnswer = null) {
    if (currentMarker) {
        currentMarker.setIcon(icon(status, false));
        if (correctAnswer) {
            const newContent = currentMarker.getPopup().getContent() + `<br><div style="color: ${status === 'green' ? '#16a34a' : '#dc2626'}; margin-top: 5px;"><b>${correctAnswer}</b></div>`;
            currentMarker.setPopupContent(newContent);
        }
    }
}

// ================= SPRACHERKENNUNG =================
let speechRecognition = null;
let isListening = false;

function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        speechRecognition = new SpeechRecognition();
        speechRecognition.continuous = false;
        speechRecognition.interimResults = false;
        speechRecognition.lang = 'de-DE';
        
        speechRecognition.onstart = () => {
            isListening = true;
            $("#voiceBtn").innerHTML = "üé§ H√∂re zu...";
            $("#voiceBtn").classList.add("voice-listening");
            toast("Sprechen Sie jetzt...");
        };
        
        speechRecognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            processVoiceAnswer(transcript);
        };
        
        speechRecognition.onerror = (event) => {
            stopVoiceRecognition();
        };
        
        speechRecognition.onend = () => {
            stopVoiceRecognition();
        };
    } else {
        $("#voiceBtn").style.display = "none";
        $("#voiceQuizBtn").style.display = "none";
    }
}

function startVoiceRecognition() {
    if (!speechRecognition) return;
    if (isListening) {
        stopVoiceRecognition();
        return;
    }
    
    try {
        speechRecognition.start();
        toast("H√∂re zu... Sagen Sie die Antwortnummer");
    } catch (error) {
        toast("Fehler beim Mikrofonzugriff");
    }
}

function stopVoiceRecognition() {
    if (speechRecognition && isListening) {
        speechRecognition.stop();
    }
    isListening = false;
    $("#voiceBtn").innerHTML = "üé§ Sprachantwort";
    $("#voiceBtn").classList.remove("voice-listening");
}

function processVoiceAnswer(transcript) {
    const cleanAnswer = transcript.trim().toLowerCase();
    const options = $$("#optionsContainer .option");
    
    const numberMatch = cleanAnswer.match(/(\d)/);
    if (numberMatch && options[numberMatch[1] - 1]) {
        const selectedOption = options[numberMatch[1] - 1];
        selectedOption.click();
        return;
    }
    
    for (let i = 0; i < options.length; i++) {
        const optionText = options[i].textContent.toLowerCase().replace(/^\d+\.\s*/, "");
        if (cleanAnswer.includes(optionText) || optionText.includes(cleanAnswer)) {
            options[i].click();
            return;
        }
    }
    
    speak("Antwort nicht verstanden. Bitte sagen Sie die Antwortnummer.", 0.7);
}

// ================= SPRACHAUSGABE - M√ÑNNLICHE STIMME =================
let ttsOn=true;
const DEFAULT_RATE = 0.8;  // Langsamer f√ºr besseres Verst√§ndnis
const SLOW_RATE = 0.5;     // Noch langsamer

function speak(text, rate=DEFAULT_RATE){
  if(!ttsOn || !text) return;
  if(!('speechSynthesis' in window)) return;
  
  window.speechSynthesis.cancel();
  
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "de-DE";
  u.rate = rate;
  u.pitch = 0.8;  // Tiefer f√ºr m√§nnliche Stimme
  
  window.speechSynthesis.speak(u);
}

// ================= DATEN =================
const PACK = JSON.parse(document.getElementById('data-pack').textContent);

const THEMEN = [
  {key:"1_regierungs", title:"I.1) Regierungsgeb√§ude", pages:"S.6", official:16},
  {key:"2_gerichte", title:"I.2) Gerichtsgeb√§ude", pages:"S.6-7", official:8},
  {key:"3_polizei", title:"I.3) Bundespolizei", pages:"S.7", official:3},
  {key:"4_stadtpolizei", title:"I.4) Stadtpolizeikommanden", pages:"S.7-10", official:14},
  {key:"II_betriebsordnung", title:"II) Betriebsordnung", pages:"S.39-56", official:20},
  {key:"III_tarif", title:"III) Wiener Tarif", pages:"S.58-61", official:15},
  {key:"IV_strassenverkehr", title:"IV) Stra√üenverkehrsordnung", pages:"S.62-75", official:20},
  {key:"19_guertel", title:"I.19) G√ºrtel Kreuzungen", pages:"S.23", official:7}
];

function buildQuestionsFromPack(){
  const data={};
  for(const [key,items] of Object.entries(PACK)){
    if(!Array.isArray(items)) continue;
    
    data[key]=items.map(it=>{
      const q = it.question || `Wo befindet sich ${it.name}?`;
      const right = it.a || it.address;
      
      let distractors = it.distractors;
      if (!distractors && it.a) {
        distractors = shuffle(items.filter(o => o.a && o.a !== right).map(o => o.a)).slice(0, 3);
      } else if (!distractors) {
        distractors = shuffle(items.filter(o => o.address && o.address !== right).map(o => o.address)).slice(0, 3);
      }
      
      const options = shuffle([right, ...distractors]).slice(0, 4);
      
      return {
        name: it.name || it.q, 
        address: it.address, 
        coords: it.coords || null, 
        question: q, 
        options: options, 
        correct: right
      };
    });
  }
  return data;
}
const DATA = buildQuestionsFromPack();

// ================= QUIZ ENGINE =================
let selected=[], pool=[], idx=0, score=0, examMode=false;
let lastQuestionText="";
let currentQuestion = null;

function availableCount(key){ return (DATA[key]||[]).length; }
function buildPool(keys){ const out=[]; keys.forEach(k=>{ if(DATA[k]) out.push(...DATA[k]); }); return shuffle(out); }

function openQuiz(){
  $("#quizPanel").style.display="block"; 
  $("#sidebar").style.display="none";
}

async function showQuestion(first=false){
  const q=pool[idx]; 
  if(!q) return;
  
  currentQuestion = q;

  $("#progress").textContent=`Frage ${idx+1} von ${pool.length}`;
  $("#progressFill").style.width=`${Math.round((idx)/pool.length*100)}%`;
  $("#questionText").textContent=q.question;

  const cont=$("#optionsContainer"); cont.innerHTML="";
  const options = q.options || [q.correct];
  shuffle(options).forEach((opt,i)=>{
    const d=document.createElement("div");
    d.className="option"; d.tabIndex=0; d.dataset.correct=(opt===(q.correct));
    d.innerHTML=`<strong>${i+1}.</strong> ${opt}`;
    d.onclick=()=>checkAnswer(d,opt);
    d.onkeydown=(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); d.click(); } };
    cont.appendChild(d);
  });
  $("#nextBtn").style.display="none"; 
  $("#endBtns").style.display="none";

  if (q.coords) {
    showLocationOnMap(q.coords, q.name || q.q, q.address || q.correct, 'blue');
  } else {
    clearMap();
  }

  lastQuestionText = q.question;
  speak(lastQuestionText, DEFAULT_RATE);
}

async function checkAnswer(el,opt){
  const q=currentQuestion; 
  const right=(opt===(q.correct));
  
  $$("#optionsContainer .option").forEach(o=>o.onclick=null);
  el.classList.add(right?"correct":"incorrect");
  
  if(!right){ 
    const r=$$("#optionsContainer .option").find(x=>x.dataset.correct==="true"); 
    if(r) r.classList.add("correct"); 
  }
  
  if(right) score++;

  if (q.coords) {
    updateMarkerStatus(right ? 'green' : 'red', q.address || q.correct);
  }

  $("#nextBtn").style.display="block";

  if(right){
    speak(`Richtig. ${q.correct}.`, DEFAULT_RATE);
  }else{
    speak(`Leider falsch. Richtig ist: ${q.correct}.`, DEFAULT_RATE);
  }
}

function nextQuestion(){
  idx++;
  if(idx<pool.length){ 
    showQuestion(); 
  } else {
    $("#questionText").textContent=`Fertig! Punkte: ${score}/${pool.length}`;
    $("#optionsContainer").innerHTML=""; 
    $("#progress").textContent=""; 
    $("#progressFill").style.width="100%";
    $("#nextBtn").style.display="none"; 
    $("#endBtns").style.display="block"; 
    clearMap();
    speak(`Pr√ºfung beendet. Sie haben ${score} von ${pool.length} Fragen richtig beantwortet.`, DEFAULT_RATE);
  }
}

function backToMenu(){ 
  $("#quizPanel").style.display="none"; 
  $("#sidebar").style.display="block"; 
  $("#endBtns").style.display="none"; 
  clearMap(); 
}

function restartQuiz(){ 
  $("#endBtns").style.display="none"; 
  idx=0; score=0; 
  pool=shuffle(pool); 
  showQuestion(true); 
}

async function startQuiz(mode="normal"){
  const checked=$$("#catList input[type=checkbox]:checked").map(x=>x.value);
  if(checked.length===0){ toast("Bitte w√§hlen Sie mindestens eine Kategorie!"); return; }
  selected=checked; 
  examMode=(mode==="exam"); 
  pool=buildPool(selected);
  if(examMode && pool.length>10) pool=pool.slice(0,10);
  idx=0; score=0; 
  openQuiz();
  await showQuestion(true);
}

function startVoiceQuiz() {
    startQuiz("normal");
}

// ================= UI EVENTS =================
function loadCats(){
  const wrap=$("#catList"); wrap.innerHTML="";
  THEMEN.forEach(t=>{
    const have=availableCount(t.key); 
    const need=t.official||have;
    const div=document.createElement("label"); 
    div.className="cat";
    div.innerHTML=`<input type="checkbox" value="${t.key}" ${["1_regierungs","2_gerichte","III_tarif"].includes(t.key) ? "checked" : ""}> <div>${t.title} <span class="small">(${t.pages})</span></div> <span class="meta">${have}/${need}</span>`;
    wrap.appendChild(div);
  });
}

// Initialisierung
window.addEventListener("load", ()=>{
    loadCats();
    initSpeechRecognition();
    toast("Wiener Taxi Pr√ºfungsassistent geladen");
});

// Event-Handler
$("#menuBtn").onclick = ()=>{ 
  $("#sidebar").style.display = $("#sidebar").style.display==="none"?"block":"none"; 
};
$("#startBtn").onclick = ()=>{ startQuiz("normal"); };
$("#examBtn").onclick  = ()=>{ startQuiz("exam"); };
$("#officialBtn").onclick = ()=>{ startQuiz("official"); };
$("#voiceQuizBtn").onclick = ()=>{ startVoiceQuiz(); };
$("#nextBtn").onclick  = nextQuestion;
$("#againBtn").onclick = restartQuiz;
$("#backBtn").onclick  = backToMenu;
$("#voiceBtn").onclick = startVoiceRecognition;
$("#replayBtn").onclick = ()=>{ speak(lastQuestionText, DEFAULT_RATE); };
$("#replaySlowBtn").onclick = ()=>{ speak(lastQuestionText, SLOW_RATE); };
$("#ttsToggleBtn").onclick = ()=>{ ttsOn=!ttsOn; toast(ttsOn?"üîä Sprachausgabe eingeschaltet":"üîá Sprachausgabe ausgeschaltet"); };

// Tastaturk√ºrzel
document.addEventListener("keydown",(e)=>{
  if($("#quizPanel").style.display!=="block") return;
  const i=["1","2","3","4","5","6"].indexOf(e.key);
  if(i>=0){ const opt=$$("#optionsContainer .option")[i]; if(opt && opt.onclick) opt.click(); }
  if(e.key==="Enter" && getComputedStyle($("#nextBtn")).display!=="none") nextQuestion();
});

$("#sidebar").style.display = "block";
</script>
</body>
</html>
